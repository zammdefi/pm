<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DAICO.wtf</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='%23000' d='M50,2 L58,18 L78,8 L72,28 L95,30 L80,45 L98,58 L75,62 L82,85 L60,75 L50,98 L40,75 L18,85 L25,62 L2,58 L20,45 L5,30 L28,28 L22,8 L42,18 Z'/><text x='50' y='44' font-family='sans-serif' font-size='18' font-weight='bold' font-style='italic' fill='%23FF8C42' text-anchor='middle'>DAICO</text><text x='50' y='64' font-family='sans-serif' font-size='16' font-weight='bold' font-style='italic' fill='%23FF8C42' text-anchor='middle'>.WTF</text></svg>" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='%23000' d='M50,2 L58,18 L78,8 L72,28 L95,30 L80,45 L98,58 L75,62 L82,85 L60,75 L50,98 L40,75 L18,85 L25,62 L2,58 L20,45 L5,30 L28,28 L22,8 L42,18 Z'/><text x='50' y='44' font-family='sans-serif' font-size='18' font-weight='bold' font-style='italic' fill='%23FF8C42' text-anchor='middle'>DAICO</text><text x='50' y='64' font-family='sans-serif' font-size='16' font-weight='bold' font-style='italic' fill='%23FF8C42' text-anchor='middle'>.WTF</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat&family=Oswald:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js" integrity="sha512-UXYETj+vXKSURF1UlgVRLzWRS9ZiQTv3lcL4rbeLyqTXCPNZC6PTLF/Ik3uxm2Zo+E109cUpJPZfLxJsCgKSng==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- WalletConnect v2 for mobile QR code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.10.0/dist/index.umd.js" integrity="sha384-ACTo60vL1/AfeYkCCXRvB1G0ugjHF0/SHU9YN7e4/KH/mitAIYpLcw5PKXW/+ekM" crossorigin="anonymous"></script>
    <style>
        :root {
            --pink: #FFB6D9;
            --yellow: #FFEB3B;
            --blue: #0047FF;
            --green: #00C853;
            --black: #1A1A1A;
            --orange: #FF6D00;
            --white: #FFFFFF;
            --cyan: #00FFFF;
            --red: #FF4757;

            --font-hero: clamp(3rem, 12vw, 14rem);
            --font-hero-daico: clamp(3.5rem, 14vw, 18rem);
            --font-section-title: clamp(2.5rem, 10vw, 12rem);
            --font-section-daico: clamp(2rem, 6vw, 8rem);
            --font-body: clamp(1.1rem, 2.5vw, 1.8rem);

            --spacing-sm: clamp(1rem, 3vw, 2rem);
            --spacing-md: clamp(2rem, 5vw, 4rem);
            --spacing-lg: clamp(3rem, 8vw, 6rem);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: none;
        }

        body {
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            overflow-x: hidden;
            background: var(--black);
            overscroll-behavior-y: none;
        }

        /* WALLET CONNECTION HEADER */
        .wallet-header {
            position: fixed;
            top: 0;
            right: 0;
            padding: var(--spacing-sm);
            z-index: 1000;
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .wallet-btn {
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(0.8rem, 2vw, 1rem);
            padding: 0.6em 1.2em;
            background: var(--black);
            color: var(--cyan);
            border: 2px solid var(--cyan);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.15s ease-out;
        }

        .wallet-btn:hover {
            background: var(--cyan);
            color: var(--black);
        }

        .wallet-btn.connected {
            background: var(--cyan);
            color: var(--black);
        }

        /* ATTRIBUTION BOX */
        .attribution-box {
            position: fixed;
            bottom: 0;
            right: 0;
            background: var(--white);
            padding: 0.5em 0.8em;
            font-family: 'Oswald', sans-serif;
            font-size: 0.75rem;
            z-index: 999;
            opacity: 0;
            transform: translateY(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .attribution-box.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .attribution-box span {
            color: var(--black);
        }

        .attribution-box a {
            color: var(--black);
            text-decoration: underline;
            font-weight: bold;
        }

        .attribution-box a:hover {
            color: var(--blue);
        }

        /* GITHUB LINK */
        .github-link {
            position: fixed;
            bottom: var(--spacing-sm);
            left: var(--spacing-sm);
            z-index: 999;
            padding: 0.5em 1em;
            background: transparent;
            border: 2px solid var(--black);
            color: var(--black);
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(0.8rem, 1.5vw, 1rem);
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.15s ease-out;
            text-decoration: none;
            text-transform: uppercase;
        }

        .github-link:hover {
            background: var(--black);
            color: var(--green);
        }

        /* NETWORK SELECTOR (in header) */
        .network-selector {
            position: relative;
        }

        .network-selector .network-badge {
            background: var(--black);
            border: 2px solid var(--cyan);
            font-family: 'Oswald', sans-serif;
            font-size: clamp(0.7rem, 1.5vw, 0.85rem);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4em;
            padding: 0.5em 0.8em;
            color: var(--cyan);
            transition: all 0.2s ease;
        }

        .network-selector .network-badge:hover {
            background: var(--cyan);
            color: var(--black);
        }

        .network-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        .network-selector[data-network="sepolia"] .network-dot {
            background: var(--orange);
        }

        .dropdown-arrow {
            font-size: 0.6rem;
            transition: transform 0.2s ease;
        }

        .network-selector.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .network-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--black);
            border: 2px solid var(--cyan);
            flex-direction: column;
            min-width: 120px;
            margin-top: 0.3em;
            z-index: 1001;
        }

        .network-selector.open .network-dropdown {
            display: flex;
        }

        .network-option {
            background: transparent;
            border: none;
            padding: 0.6em 0.8em;
            font-family: 'Oswald', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.5em;
            color: var(--cyan);
            transition: all 0.15s ease;
        }

        .network-option:hover {
            background: var(--cyan);
            color: var(--black);
        }

        .network-option.active {
            background: var(--cyan);
            color: var(--black);
        }

        .network-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem;
            font-weight: bold;
            color: white;
        }

        .network-icon.ethereum { background: #627EEA; }
        .network-icon.base { background: #0052FF; }
        .network-icon.sepolia { background: var(--orange); }
        .network-icon.arbitrum { background: #28a0f0; }

        /* HERO SECTION */
        .hero {
            min-height: 100vh;
            min-height: 100dvh;
            background: var(--pink);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .lines path {
            stroke: var(--black);
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 2000;
            stroke-dashoffset: 2000;
            animation: drawLine 1s ease-out forwards;
            filter: url(#sketchy);
        }

        .line1 { animation-delay: 0.5s; }
        .line2 { animation-delay: 0.7s; }
        .line3 { animation-delay: 0.9s; }

        @keyframes drawLine {
            to { stroke-dashoffset: 0; }
        }

        .hero-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: var(--spacing-md);
            padding-bottom: calc(var(--spacing-lg) + 60px);
        }

        .word {
            font-size: var(--font-hero);
            line-height: 1;
            text-transform: uppercase;
            user-select: none;
            letter-spacing: -0.02em;
            padding: 0.05em 0.25em;
            z-index: 1;
            cursor: pointer;
            transition: all 0.15s ease-out;
            display: inline-block;
            width: fit-content;
        }

        .hero-top {
            display: flex;
            flex-direction: column;
            gap: clamp(1.5rem, 6vh, 4rem);
        }

        .word-row {
            display: flex;
        }

        .word-row.center {
            justify-content: center;
        }

        .word-row.left {
            justify-content: flex-start;
        }

        .hero-bottom {
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .fund {
            color: var(--blue);
            background: var(--yellow);
            animation: fadeSlide 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }

        .fund:hover, .fund:active {
            color: var(--yellow);
            background: var(--blue);
        }

        .ctrl {
            color: var(--green);
            background: var(--black);
            animation: fadeSlide 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.1s both;
        }

        .ctrl:hover, .ctrl:active {
            color: var(--black);
            background: var(--green);
        }

        .grow {
            color: var(--orange);
            background: var(--white);
            animation: fadeSlide 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.2s both;
        }

        .grow:hover, .grow:active {
            color: var(--white);
            background: var(--orange);
        }

        .daico {
            color: var(--black);
            background: var(--cyan);
            font-size: var(--font-hero-daico);
            animation: fadeSlide 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.3s both;
        }

        .daico:hover, .daico:active {
            color: var(--cyan);
            background: var(--black);
        }

        /* LAUNCH BUTTON - Fixed position in top left */
        .launch-btn {
            position: fixed;
            top: var(--spacing-sm);
            left: var(--spacing-sm);
            z-index: 1000;
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(0.8rem, 1.5vw, 1rem);
            padding: 0.5em 1em;
            background: transparent;
            color: var(--black);
            border: 2px solid var(--black);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.15s ease-out;
        }

        .launch-btn:hover {
            background: var(--black);
            color: var(--green);
        }

        .launch-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes fadeSlide {
            0% {
                transform: translateY(30px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* SCROLL INDICATOR */
        .scroll-hint {
            position: absolute;
            bottom: var(--spacing-sm);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            z-index: 10;
            animation: bounce 2s ease-in-out infinite;
            cursor: pointer;
        }

        .scroll-hint span {
            font-size: clamp(10px, 2vw, 14px);
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--black);
            font-style: normal;
        }

        .scroll-hint .arrow {
            width: clamp(16px, 3vw, 24px);
            height: clamp(16px, 3vw, 24px);
            border-right: 2px solid var(--black);
            border-bottom: 2px solid var(--black);
            transform: rotate(45deg);
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(10px); }
        }

        /* HOW IT WORKS POST-IT NOTE */
        .how-it-works {
            position: absolute;
            bottom: calc(var(--spacing-lg) + 40px);
            left: var(--spacing-md);
            width: clamp(140px, 18vw, 200px);
            background: #fffbcc;
            padding: 0.8em 1em;
            z-index: 10;
            transform: rotate(-2deg);
            box-shadow:
                2px 3px 8px rgba(0, 0, 0, 0.15),
                inset 0 -2px 4px rgba(0, 0, 0, 0.03);
            opacity: 0;
            animation: noteSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.8s forwards;
            border-left: 3px solid #e6d966;
        }

        .how-it-works::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(0,0,0,0.03) 20%,
                rgba(0,0,0,0.05) 50%,
                rgba(0,0,0,0.03) 80%,
                transparent 100%
            );
        }

        .how-it-works-header {
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(0.7rem, 1.5vw, 0.85rem);
            color: var(--black);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.5em;
            opacity: 0.7;
            border-bottom: 1px dashed rgba(0,0,0,0.2);
            padding-bottom: 0.4em;
        }

        .how-it-works-list {
            list-style: none;
            font-family: 'Oswald', sans-serif;
            font-style: normal;
            font-size: clamp(0.6rem, 1.2vw, 0.75rem);
            color: var(--black);
            line-height: 1.6;
        }

        .how-it-works-list li {
            position: relative;
            padding-left: 1.2em;
            margin-bottom: 0.25em;
            opacity: 0.85;
        }

        .how-it-works-list li::before {
            content: attr(data-num);
            position: absolute;
            left: 0;
            font-style: italic;
            opacity: 0.5;
            font-size: 0.9em;
        }

        @keyframes noteSlideIn {
            0% {
                opacity: 0;
                transform: rotate(-2deg) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: rotate(-2deg) translateY(0);
            }
        }

        /* Mobile: keep on left, lower position near scroll hint */
        @media (max-width: 600px) {
            .how-it-works {
                left: var(--spacing-sm);
                bottom: 12px;
                width: clamp(130px, 40vw, 160px);
                padding: 0.5em 0.7em;
            }

            .how-it-works-header {
                font-size: 0.65rem;
            }

            .how-it-works-list {
                font-size: 0.55rem;
            }
        }

        /* Very small screens: even more compact */
        @media (max-width: 380px) {
            .how-it-works {
                width: 125px;
                padding: 0.4em 0.6em;
                bottom: 10px;
            }

            .how-it-works-header {
                font-size: 0.6rem;
                margin-bottom: 0.3em;
                padding-bottom: 0.3em;
            }

            .how-it-works-list {
                font-size: 0.5rem;
                line-height: 1.4;
            }

            .how-it-works-list li {
                margin-bottom: 0.1em;
            }
        }

        /* TAGLINE POST-IT NOTE (right side) */
        .tagline-note {
            position: absolute;
            bottom: calc(var(--spacing-lg) + 60px);
            right: var(--spacing-md);
            background: #1a1a1a;
            color: var(--cyan);
            padding: 0.6em 0.9em;
            z-index: 10;
            transform: rotate(1.5deg);
            box-shadow: 2px 3px 8px rgba(0, 0, 0, 0.3);
            opacity: 0;
            animation: noteSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1.2s forwards;
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(0.55rem, 1.1vw, 0.7rem);
            letter-spacing: 0.05em;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        @media (max-width: 600px) {
            .tagline-note {
                right: var(--spacing-sm);
                bottom: 50px;
                font-size: 0.5rem;
                padding: 0.4em 0.6em;
            }
        }

        @media (max-width: 380px) {
            .tagline-note {
                font-size: 0.45rem;
                padding: 0.3em 0.5em;
                bottom: 45px;
            }
        }

        /* Venn diagram link */
        .venn-diagram-link {
            position: absolute;
            top: 160px;
            right: 20%;
            width: clamp(110px, 15vw, 170px);
            opacity: 0.85;
            z-index: 50;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .venn-diagram-link:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .venn-diagram-link svg {
            width: 100%;
            height: auto;
        }

        @media (max-width: 600px) {
            .venn-diagram-link {
                right: var(--spacing-sm);
                top: 70px;
                width: 100px;
                opacity: 0.9;
            }
            .venn-diagram-link:hover {
                transform: scale(1.05);
            }
        }

        @media (max-width: 380px) {
            .venn-diagram-link {
                width: 90px;
                top: 65px;
            }
        }

        /* Handwritten note */
        .handwritten-note {
            position: absolute;
            top: 45%;
            left: 12%;
            font-family: 'Caveat', cursive;
            font-size: clamp(1rem, 2vw, 1.4rem);
            color: rgba(0, 0, 0, 0.35);
            transform: rotate(-8deg);
            pointer-events: none;
            white-space: nowrap;
        }

        .handwritten-note-right {
            left: auto;
            right: 18%;
            top: 300px;
            transform: rotate(4deg);
        }

        .handwritten-note-bottom {
            left: auto;
            right: 12%;
            top: auto;
            bottom: 30%;
            transform: rotate(-3deg);
        }

        @media (max-width: 600px) {
            .handwritten-note {
                top: auto;
                bottom: 18%;
                left: var(--spacing-sm);
                font-size: 0.9rem;
            }
            .handwritten-note-right {
                left: auto;
                right: var(--spacing-sm);
                top: 160px;
                transform: rotate(4deg);
            }
            .handwritten-note-bottom {
                left: 50%;
                right: auto;
                bottom: auto;
                top: 50%;
                transform: translateX(-50%) rotate(-3deg);
            }
        }

        @media (max-width: 380px) {
            .handwritten-note {
                bottom: 16%;
                font-size: 0.8rem;
            }
            .handwritten-note-right {
                top: 150px;
            }
            .handwritten-note-bottom {
                top: 48%;
            }
        }

        /* CONTENT SECTIONS */
        .section {
            min-height: 100vh;
            min-height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-md);
        }

        .section-fund { background: var(--yellow); }
        .section-ctrl { background: var(--black); }
        .section-grow { background: var(--white); }

        .section .theme {
            font-size: var(--font-section-title);
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: -0.02em;
            padding: 0.05em 0.25em;
            cursor: pointer;
            transition: all 0.15s ease-out;
            display: inline-block;
            width: fit-content;
            margin-bottom: var(--spacing-md);
            opacity: 0;
            transform: scale(0.8) rotate(-2deg);
        }

        .section .theme.pop-in {
            animation: themePop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes themePop {
            0% {
                opacity: 0;
                transform: scale(0.8) rotate(-2deg);
            }
            60% {
                opacity: 1;
                transform: scale(1.1) rotate(1deg);
            }
            80% {
                transform: scale(0.95) rotate(-0.5deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .section-fund .theme {
            color: var(--yellow);
            background: var(--blue);
        }

        .section-fund .theme:hover, .section-fund .theme:active {
            color: var(--blue);
            background: var(--yellow);
            outline: 3px solid var(--blue);
        }

        .section-ctrl .theme {
            color: var(--black);
            background: var(--green);
        }

        .section-ctrl .theme:hover, .section-ctrl .theme:active {
            color: var(--green);
            background: var(--black);
            outline: 3px solid var(--green);
        }

        .section-grow .theme {
            color: var(--white);
            background: var(--orange);
        }

        .section-grow .theme:hover, .section-grow .theme:active {
            color: var(--orange);
            background: var(--white);
            outline: 3px solid var(--orange);
        }

        .section .content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md) 0;
        }

        .section .content p {
            max-width: 650px;
            text-align: center;
            font-size: var(--font-body);
            line-height: 1.5;
            font-style: normal;
        }

        .section-fund .content p { color: var(--blue); }
        .section-ctrl .content p { color: var(--green); }

        /* CTRL Diagram */
        .ctrl-diagram {
            margin-top: 2rem;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .diagram-svg {
            width: 100%;
            height: auto;
        }

        .diagram-box {
            fill: none;
            stroke: var(--green);
            stroke-width: 2;
            filter: url(#sketchy-diagram);
            stroke-dasharray: 500;
            stroke-dashoffset: 500;
        }

        .diagram-label {
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-style: italic;
            fill: var(--green);
            text-anchor: middle;
            opacity: 0;
        }

        .diagram-line {
            fill: none;
            stroke: var(--cyan);
            stroke-width: 2;
            stroke-linecap: round;
            filter: url(#sketchy-diagram);
            stroke-dasharray: 200;
            stroke-dashoffset: 200;
        }

        .diagram-line.dotted {
            stroke-dasharray: 6 4;
            stroke-dashoffset: 0;
            opacity: 0;
        }

        .ctrl-diagram.animated .diagram-line.dotted {
            animation: fadeInDotted 0.5s ease-out forwards;
        }

        @keyframes fadeInDotted {
            to { opacity: 1; }
        }

        .diagram-line-label {
            font-family: 'Oswald', sans-serif;
            font-size: 12px;
            font-style: italic;
            fill: var(--cyan);
            text-anchor: middle;
            opacity: 0;
        }

        /* Animation states */
        .ctrl-diagram.animated .diagram-box {
            animation: drawDiagramBox 0.8s ease-out forwards;
        }

        .ctrl-diagram.animated .diagram-label {
            animation: fadeInLabel 0.4s ease-out forwards;
        }

        .ctrl-diagram.animated .diagram-line {
            animation: drawDiagramLine 0.5s ease-out forwards;
        }

        .ctrl-diagram.animated .diagram-line-label {
            animation: fadeInLabel 0.3s ease-out forwards;
        }

        @keyframes drawDiagramBox {
            to { stroke-dashoffset: 0; }
        }

        @keyframes drawDiagramLine {
            to { stroke-dashoffset: 0; }
        }

        @keyframes fadeInLabel {
            to { opacity: 1; }
        }

        /* Staggered animation delays */
        .ctrl-diagram.animated .treasury-box { animation-delay: 0s; }
        .ctrl-diagram.animated .treasury-label { animation-delay: 0.6s; }

        .ctrl-diagram.animated .dao-box { animation-delay: 0.2s; }
        .ctrl-diagram.animated .dao-label { animation-delay: 0.8s; }

        .ctrl-diagram.animated .holder-box { animation-delay: 0.4s; }
        .ctrl-diagram.animated .holder-label { animation-delay: 1s; }

        .ctrl-diagram.animated .ops-box { animation-delay: 0.6s; }
        .ctrl-diagram.animated .ops-label { animation-delay: 1.2s; }

        .ctrl-diagram.animated .exit-box { animation-delay: 0.8s; }
        .ctrl-diagram.animated .exit-label { animation-delay: 1.4s; }

        .ctrl-diagram.animated .line-treasury { animation-delay: 1s; }
        .ctrl-diagram.animated .line-vote { animation-delay: 1.1s; }
        .ctrl-diagram.animated .label-vote { animation-delay: 1.4s; }
        .ctrl-diagram.animated .line-tap { animation-delay: 1.2s; }
        .ctrl-diagram.animated .label-tap { animation-delay: 1.5s; }
        .ctrl-diagram.animated .line-ragequit { animation-delay: 1.3s; }
        .ctrl-diagram.animated .label-ragequit { animation-delay: 1.6s; }

        /* Mobile adjustments */
        @media (max-width: 600px) {
            .ctrl-diagram {
                margin-top: 1.5rem;
            }
            .diagram-label {
                font-size: 14px;
            }
            .diagram-line-label {
                font-size: 10px;
            }
        }
        .section-grow .content p { color: var(--orange); }

        /* GROW Section Illustration */
        .grow-illustration {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .section-grow {
            position: relative;
        }

        .section-grow .theme,
        .section-grow .content,
        .section-grow .section-daico {
            position: relative;
            z-index: 1;
        }

        /* Action Bubble */
        .action-bubble {
            transform-origin: 422px 85px;
            transform: scale(0);
        }

        .bubble-shape {
            fill: var(--black);
            stroke: var(--black);
            stroke-width: 3;
            filter: url(#sketchy-grow);
            stroke-linejoin: round;
        }

        .bubble-text {
            font-family: 'Oswald', sans-serif;
            font-size: 32px;
            font-style: italic;
            font-weight: bold;
            fill: var(--orange);
            text-anchor: middle;
            letter-spacing: 0.05em;
        }

        /* Bubble rays */
        .bubble-ray {
            stroke: var(--black);
            stroke-width: 1.5;
            stroke-dasharray: 10 8;
            filter: url(#sketchy-grow);
            opacity: 0;
        }

        /* Ground */
        .ground-line {
            fill: none;
            stroke: var(--black);
            stroke-width: 2;
            filter: url(#sketchy-grow);
            stroke-dasharray: 600;
            stroke-dashoffset: 600;
        }

        /* Stalks */
        .stalk-stem {
            fill: none;
            stroke: var(--black);
            stroke-width: 2.5;
            stroke-linecap: round;
            filter: url(#sketchy-grow);
            stroke-dasharray: 200;
            stroke-dashoffset: 200;
        }

        .stalk-leaf {
            fill: rgba(0, 0, 0, 0.15);
            stroke: var(--black);
            stroke-width: 1.5;
            filter: url(#sketchy-grow);
            opacity: 0;
            transform-origin: center;
            transform: scale(0);
        }

        /* Animated states */
        .grow-illustration.animated .action-bubble {
            animation: popBubble 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .grow-illustration.animated .bubble-ray {
            animation: fadeInRay 0.4s ease-out forwards;
        }

        .grow-illustration.animated .ray-1 { animation-delay: 0.4s; }
        .grow-illustration.animated .ray-2 { animation-delay: 0.5s; }
        .grow-illustration.animated .ray-3 { animation-delay: 0.6s; }
        .grow-illustration.animated .ray-4 { animation-delay: 0.45s; }
        .grow-illustration.animated .ray-5 { animation-delay: 0.55s; }

        .grow-illustration.animated .ground-line {
            animation: drawGround 0.8s ease-out 0.3s forwards;
        }

        .grow-illustration.animated .stalk-stem {
            animation: growStem 0.8s ease-out forwards;
        }

        .grow-illustration.animated .stalk-1 .stalk-stem { animation-delay: 0.8s; }
        .grow-illustration.animated .stalk-2 .stalk-stem { animation-delay: 1.0s; }
        .grow-illustration.animated .stalk-3 .stalk-stem { animation-delay: 1.2s; }

        .grow-illustration.animated .stalk-leaf {
            animation: sproutLeaf 0.4s ease-out forwards;
        }

        /* Stalk 1 leaves */
        .grow-illustration.animated .stalk-1 .leaf-right-1 { animation-delay: 1.3s; }
        .grow-illustration.animated .stalk-1 .leaf-left-1 { animation-delay: 1.4s; }
        .grow-illustration.animated .stalk-1 .leaf-right-2 { animation-delay: 1.5s; }

        /* Stalk 2 leaves */
        .grow-illustration.animated .stalk-2 .leaf-right-1 { animation-delay: 1.5s; }
        .grow-illustration.animated .stalk-2 .leaf-left-1 { animation-delay: 1.6s; }
        .grow-illustration.animated .stalk-2 .leaf-right-2 { animation-delay: 1.7s; }
        .grow-illustration.animated .stalk-2 .leaf-left-2 { animation-delay: 1.8s; }

        /* Stalk 3 leaves */
        .grow-illustration.animated .stalk-3 .leaf-left-1 { animation-delay: 1.7s; }
        .grow-illustration.animated .stalk-3 .leaf-right-1 { animation-delay: 1.8s; }

        @keyframes popBubble {
            0% { transform: scale(0) rotate(-20deg); }
            60% { transform: scale(1.15) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes fadeInRay {
            to { opacity: 0.35; }
        }

        @keyframes drawGround {
            to { stroke-dashoffset: 0; }
        }

        @keyframes growStem {
            to { stroke-dashoffset: 0; }
        }

        @keyframes sproutLeaf {
            0% { opacity: 0; transform: scale(0); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Mobile adjustments */
        @media (max-width: 600px) {
            .bubble-text {
                font-size: 24px;
            }
            .bubble-shape {
                stroke-width: 2;
            }
            .stalk-stem {
                stroke-width: 2;
            }
        }

        /* Crossed-out word animation */
        .crossed-word {
            position: absolute;
            display: inline-block;
        }

        .crossed-text {
            font-family: 'Oswald', sans-serif;
            font-size: clamp(1.8rem, 5vw, 3.5rem);
            font-style: italic;
            color: rgba(0, 0, 0, 0.12);
            text-transform: lowercase;
            letter-spacing: 0.02em;
            user-select: none;
        }

        .cross-lines {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120%;
            height: 100%;
            pointer-events: none;
            overflow: visible;
        }

        .cross-line {
            stroke: var(--black);
            stroke-width: 2.5;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 200;
            stroke-dashoffset: 200;
            filter: url(#sketchy);
        }

        .cross-1 {
            stroke-width: 3;
        }

        .cross-2 {
            stroke-width: 2;
            opacity: 0.7;
        }

        .crossed-word.animated .cross-line {
            animation: drawCross 0.5s ease-out forwards;
        }

        .crossed-word.animated .cross-2 {
            animation-delay: 0.12s;
        }

        @keyframes drawCross {
            to { stroke-dashoffset: 0; }
        }

        /* Individual word positions */
        .crossed-snipers {
            top: 12%;
            right: 8%;
            transform: rotate(-6deg);
        }

        .crossed-insiders {
            bottom: 25%;
            left: 5%;
            transform: rotate(5deg);
        }

        .crossed-bs {
            top: 10%;
            left: 50%;
            transform: translateX(-50%) rotate(-3deg);
        }

        .crossed-bs .crossed-text {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
        }

        /* ZAMM swap badge - subtle diagonal link */
        .zamm-swap-badge {
            position: absolute;
            bottom: 28%;
            right: 10%;
            transform: rotate(4deg);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            opacity: 0.6;
            transition: all 0.15s ease-out;
            padding: 0.4rem 0.6rem;
            border: 2px solid transparent;
        }

        .zamm-swap-badge:hover {
            opacity: 1;
            border-color: var(--blue);
            background: rgba(0, 71, 255, 0.1);
        }

        .zamm-swap-badge img {
            width: 28px;
            height: 28px;
        }

        .zamm-swap-badge .zamm-text {
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(0.85rem, 2vw, 1rem);
            color: var(--blue);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Majeur DAO badge - CTRL section */
        .majeur-badge {
            position: absolute;
            top: 12%;
            right: 6%;
            transform: rotate(-5deg);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            opacity: 0.6;
            transition: all 0.15s ease-out;
            padding: 0.4rem 0.6rem;
            border: 2px solid transparent;
            color: #c4b5fd;
        }

        .majeur-badge:hover {
            opacity: 1;
            border-color: #c4b5fd;
            background: rgba(196, 181, 253, 0.1);
        }

        .majeur-badge svg {
            width: 24px;
            height: 24px;
        }

        .majeur-badge .majeur-text {
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            color: #c4b5fd;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* World Computer highlight link - GROW section */
        .world-computer-link {
            color: var(--orange);
            background: var(--black);
            text-decoration: none;
            padding: 0.05em 0.2em;
            font-weight: 500;
            transition: all 0.1s ease-out;
            display: inline;
        }

        .world-computer-link:hover {
            color: var(--black);
            background: var(--orange);
        }

        /* Stagger animations */
        .crossed-snipers.animated .cross-line {
            animation-delay: 0s;
        }
        .crossed-snipers.animated .cross-2 {
            animation-delay: 0.12s;
        }

        .crossed-insiders.animated .cross-line {
            animation-delay: 0.2s;
        }
        .crossed-insiders.animated .cross-2 {
            animation-delay: 0.32s;
        }

        .crossed-bs.animated .cross-line {
            animation-delay: 0.4s;
        }
        .crossed-bs.animated .cross-2 {
            animation-delay: 0.52s;
        }

        /* Mobile adjustments for crossed words */
        @media (max-width: 600px) {
            .crossed-text {
                font-size: clamp(1.2rem, 6vw, 2rem);
            }

            .crossed-snipers {
                top: 8%;
                right: 5%;
            }

            .crossed-insiders {
                bottom: 18%;
                left: 3%;
            }

            .crossed-bs {
                top: 6%;
            }

            .crossed-bs .crossed-text {
                font-size: clamp(1.2rem, 5vw, 1.8rem);
            }

            .zamm-swap-badge {
                bottom: 12%;
                right: 5%;
            }

            .zamm-swap-badge img {
                width: 22px;
                height: 22px;
            }

            .zamm-swap-badge .zamm-text {
                font-size: 0.75rem;
            }

            .majeur-badge {
                top: 8%;
                right: 4%;
            }

            .majeur-badge svg {
                width: 20px;
                height: 20px;
            }

            .majeur-badge .majeur-text {
                font-size: 0.7rem;
            }
        }

        .section .section-daico {
            font-size: var(--font-section-daico);
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: -0.02em;
            padding: 0.05em 0.25em;
            color: var(--black);
            background: var(--cyan);
            cursor: pointer;
            transition: all 0.15s ease-out;
            display: inline-block;
            width: fit-content;
            align-self: flex-end;
        }

        .section .section-daico:hover, .section .section-daico:active {
            color: var(--cyan);
            background: var(--black);
        }

        /* LAUNCH MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            overflow-y: auto;
            padding: var(--spacing-md);
        }

        .modal-overlay.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .modal-container {
            background: var(--black);
            border: 3px solid var(--cyan);
            max-width: 800px;
            width: 100%;
            margin: var(--spacing-md) auto;
            position: relative;
        }

        .modal-header {
            background: var(--cyan);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--black);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modal-close {
            font-size: 2rem;
            color: var(--black);
            background: none;
            border: none;
            cursor: pointer;
            line-height: 1;
            padding: 0.25rem;
            transition: transform 0.15s;
        }

        .modal-close:hover {
            transform: scale(1.1);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* FORM STYLES */
        .form-section {
            margin-bottom: 2rem;
        }

        .form-section-title {
            font-size: 1.2rem;
            color: var(--cyan);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            font-style: normal;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            color: var(--white);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-style: normal;
        }

        .form-label .hint {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: none;
            display: block;
            margin-top: 0.25rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            transition: border-color 0.15s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .form-select {
            width: 100%;
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            cursor: pointer;
        }

        .form-select option {
            background: var(--black);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .form-checkbox input {
            width: 20px;
            height: 20px;
            accent-color: var(--cyan);
        }

        .form-checkbox span {
            color: var(--white);
            font-size: 0.9rem;
            font-style: normal;
        }

        /* TOGGLE SECTION */
        .toggle-section {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .toggle-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .toggle-header input {
            width: 20px;
            height: 20px;
            accent-color: var(--cyan);
        }

        .toggle-header label {
            font-size: 1rem;
            color: var(--cyan);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-style: normal;
            cursor: pointer;
        }

        .toggle-content {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(0, 255, 255, 0.2);
            display: none;
        }

        .toggle-content.show {
            display: block;
        }

        /* VISUALIZATION PANEL */
        .viz-panel {
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid var(--cyan);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .viz-title {
            font-size: 1rem;
            color: var(--cyan);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            font-style: normal;
        }

        .viz-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .viz-row:last-child {
            border-bottom: none;
        }

        .viz-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            font-style: normal;
        }

        .viz-value {
            color: var(--white);
            font-size: 1rem;
            font-weight: 500;
            font-style: normal;
        }

        .viz-value.highlight {
            color: var(--cyan);
            font-size: 1.1rem;
        }

        .viz-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            margin-top: 1rem;
            position: relative;
            overflow: hidden;
        }

        .viz-bar-segment {
            height: 100%;
            display: inline-block;
            transition: width 0.3s ease;
        }

        .viz-bar-label {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: var(--black);
            font-weight: 600;
            font-style: normal;
            padding: 0 0.5rem;
        }

        /* SUBMIT BUTTON */
        .submit-btn {
            width: 100%;
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: 1.5rem;
            padding: 1rem 2rem;
            background: var(--green);
            color: var(--black);
            border: 3px solid var(--black);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.15s ease-out;
            margin-top: 1rem;
        }

        .submit-btn:hover:not(:disabled) {
            background: var(--cyan);
            transform: scale(1.01);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* STATUS MESSAGE */
        .status-message {
            padding: 1rem;
            margin-bottom: 1rem;
            font-style: normal;
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.info {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--cyan);
            color: var(--cyan);
        }

        .status-message.success {
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid var(--green);
            color: var(--green);
        }

        .status-message.error {
            background: rgba(255, 109, 0, 0.1);
            border: 1px solid var(--orange);
            color: var(--orange);
        }

        .status-message a {
            color: inherit;
            text-decoration: underline;
        }

        /* SUCCESS PANEL */
        .success-panel {
            text-align: center;
            padding: 2rem;
        }

        .success-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .success-title {
            font-size: 2rem;
            color: var(--green);
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .success-dao-link {
            display: inline-block;
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: 1.2rem;
            padding: 1rem 2rem;
            background: var(--cyan);
            color: var(--black);
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            transition: all 0.15s ease-out;
        }

        .success-dao-link:hover {
            background: var(--green);
            transform: scale(1.02);
        }

        .success-address {
            font-family: monospace;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 1rem;
            word-break: break-all;
        }

        /* WALLET MODAL */
        .wallet-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
        }

        .wallet-modal.show {
            display: flex;
        }

        .wallet-modal-content {
            background: var(--black);
            border: 3px solid var(--cyan);
            max-width: 400px;
            width: 100%;
            padding: 2rem;
        }

        .wallet-modal-title {
            font-size: 1.5rem;
            color: var(--cyan);
            text-transform: uppercase;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .wallet-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            cursor: pointer;
            margin-bottom: 0.75rem;
            transition: all 0.15s;
        }

        .wallet-option:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: var(--cyan);
        }

        .wallet-option-icon {
            font-size: 1.5rem;
        }

        .wallet-option-name {
            color: var(--white);
            font-size: 1rem;
            font-style: normal;
        }

        .wallet-option.disconnect {
            background: rgba(255, 71, 87, 0.15);
            border: 2px solid var(--red);
            justify-content: center;
        }

        .wallet-option.disconnect:hover {
            background: var(--red);
        }

        .wallet-option.disconnect .wallet-option-name {
            color: var(--red);
            font-weight: 500;
        }

        .wallet-option.disconnect:hover .wallet-option-name {
            color: var(--white);
        }

        /* SIMPLE WIZARD MODAL */
        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            overflow-y: auto;
        }

        .wizard-overlay.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 2rem 0;
        }

        .wizard-container {
            width: 100%;
            max-width: 700px;
            padding: var(--spacing-md);
        }

        .wizard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .wizard-title {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--cyan);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .wizard-close {
            font-size: 2.5rem;
            color: var(--black);
            background: var(--white);
            border: 3px solid var(--black);
            width: 44px;
            height: 44px;
            cursor: pointer;
            line-height: 1;
            transition: all 0.1s;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wizard-close:hover {
            background: var(--red);
            color: var(--white);
            border-color: var(--red);
            transform: rotate(90deg);
        }

        .wizard-advanced {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: color 0.15s;
            font-style: normal;
        }

        .wizard-advanced:hover {
            color: var(--cyan);
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        .wizard-step-title {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            color: var(--white);
            text-transform: uppercase;
            margin-bottom: 1.5rem;
            text-align: center;
            font-style: normal;
        }

        /* Split choice buttons */
        .wizard-choice {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .wizard-choice-btn {
            padding: 2rem 1rem;
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.15s ease-out;
            border: 4px solid;
            text-align: center;
        }

        .wizard-choice-btn.shares {
            background: var(--yellow);
            color: var(--blue);
            border-color: var(--blue);
        }

        .wizard-choice-btn.shares:hover {
            background: var(--blue);
            color: var(--yellow);
        }

        .wizard-choice-btn.loot {
            background: var(--black);
            color: var(--green);
            border-color: var(--green);
        }

        .wizard-choice-btn.loot:hover {
            background: var(--green);
            color: var(--black);
        }

        .wizard-choice-btn.tap-yes {
            background: var(--cyan);
            color: var(--black);
            border-color: var(--black);
        }

        .wizard-choice-btn.tap-yes:hover {
            background: var(--green);
        }

        .wizard-choice-btn.tap-no {
            background: transparent;
            color: var(--white);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .wizard-choice-btn.tap-no:hover {
            border-color: var(--white);
            background: rgba(255, 255, 255, 0.1);
        }

        .wizard-choice-btn.lp-yes {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--white);
            border-color: var(--cyan);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .wizard-choice-btn.lp-yes:hover {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            border-color: var(--white);
        }

        .wizard-choice-btn.lp-no {
            background: transparent;
            color: var(--white);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .wizard-choice-btn.lp-no:hover {
            border-color: var(--white);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Tap Preset Buttons */
        .tap-preset-btn, .tap-duration-btn {
            padding: 0.6rem 1.2rem;
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            background: transparent;
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tap-preset-btn:hover, .tap-duration-btn:hover {
            border-color: var(--cyan);
            color: var(--cyan);
        }

        .tap-preset-btn.active, .tap-duration-btn.active {
            background: var(--cyan);
            color: var(--black);
            border-color: var(--cyan);
        }

        /* LP Slider */
        .wizard-lp-slider {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .wizard-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }

        .wizard-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--cyan);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid var(--black);
        }

        .wizard-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--cyan);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid var(--black);
        }

        .wizard-slider-value {
            font-size: 1.5rem;
            font-style: italic;
            color: var(--cyan);
            min-width: 60px;
            text-align: right;
        }

        /* Raise amount grid */
        .wizard-raise-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .wizard-raise-btn {
            padding: 1.5rem 1rem;
            font-family: 'Oswald', sans-serif;
            background: transparent;
            border: 3px solid var(--cyan);
            cursor: pointer;
            transition: all 0.15s ease-out;
            text-align: center;
        }

        .wizard-raise-btn:hover {
            background: var(--cyan);
        }

        .wizard-raise-btn:hover .wizard-raise-amount {
            color: var(--black);
        }

        .wizard-raise-btn:hover .wizard-raise-price {
            color: var(--black);
        }

        .wizard-raise-amount {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-style: italic;
            color: var(--cyan);
            text-transform: uppercase;
            transition: color 0.15s;
        }

        .wizard-raise-price {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.5rem;
            font-style: normal;
            transition: color 0.15s;
        }

        .wizard-raise-btn.custom {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .wizard-raise-btn.custom .wizard-raise-amount {
            color: var(--white);
        }

        .wizard-raise-btn.custom:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--white);
        }

        .wizard-raise-btn.custom:hover .wizard-raise-amount {
            color: var(--white);
        }

        .wizard-raise-btn.custom:hover .wizard-raise-price {
            color: rgba(255, 255, 255, 0.7);
        }

        @media (max-width: 500px) {
            .wizard-raise-grid {
                grid-template-columns: 1fr;
            }
        }

        .wizard-choice-desc {
            font-size: 0.85rem;
            font-style: normal;
            margin-top: 0.75rem;
            opacity: 0.8;
        }

        /* Wizard inputs */
        .wizard-input-group {
            margin-bottom: 1.5rem;
        }

        .wizard-label {
            display: block;
            font-size: 1rem;
            color: var(--cyan);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-style: normal;
        }

        .wizard-input {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 3px solid var(--cyan);
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-size: 1.2rem;
            text-align: center;
        }

        .wizard-input:focus {
            outline: none;
            background: rgba(0, 255, 255, 0.1);
        }

        .wizard-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .wizard-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Founders list */
        .wizard-founders {
            margin-bottom: 1.5rem;
        }

        .wizard-founder-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .wizard-founder-input {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
        }

        .wizard-founder-input:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .wizard-founder-remove {
            padding: 0.75rem 1rem;
            background: transparent;
            border: 2px solid var(--orange);
            color: var(--orange);
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .wizard-founder-remove:hover {
            background: var(--orange);
            color: var(--black);
        }

        .wizard-add-founder {
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 2px dashed rgba(0, 255, 255, 0.3);
            color: rgba(0, 255, 255, 0.6);
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.15s;
        }

        .wizard-add-founder:hover {
            border-color: var(--cyan);
            color: var(--cyan);
        }

        /* Wizard navigation */
        .wizard-nav {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .wizard-btn {
            flex: 1;
            padding: 1rem 2rem;
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.15s ease-out;
            border: 3px solid;
        }

        .wizard-btn.back {
            background: transparent;
            color: var(--white);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .wizard-btn.back:hover {
            border-color: var(--white);
        }

        .wizard-btn.next {
            background: var(--cyan);
            color: var(--black);
            border-color: var(--cyan);
        }

        .wizard-btn.next:hover {
            background: var(--white);
        }

        .wizard-btn.launch {
            background: var(--green);
            color: var(--black);
            border-color: var(--black);
        }

        .wizard-btn.launch:hover {
            background: var(--cyan);
        }

        .wizard-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Summary panel */
        .wizard-summary {
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid var(--cyan);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .wizard-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-style: normal;
        }

        .wizard-summary-row:last-child {
            border-bottom: none;
        }

        .wizard-summary-label {
            color: rgba(255, 255, 255, 0.6);
        }

        .wizard-summary-value {
            color: var(--white);
            font-weight: 500;
        }

        .wizard-summary-value.highlight {
            color: var(--cyan);
        }

        /* Trust Mode notice */
        .wizard-trust-notice {
            margin-top: 1.5rem;
            padding: 1rem 1.25rem;
            background: rgba(255, 200, 100, 0.1);
            border: 2px solid var(--yellow);
            text-align: center;
        }

        .wizard-trust-title {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--yellow);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .wizard-trust-desc {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            font-style: normal;
        }

        /* Wizard success */
        .wizard-success {
            text-align: center;
            padding: 2rem 0;
        }

        .wizard-success-title {
            font-size: clamp(2rem, 5vw, 3rem);
            color: var(--green);
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .wizard-success-address {
            font-family: monospace;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            word-break: break-all;
            margin: 1rem 0;
        }

        .wizard-success-link {
            display: inline-block;
            padding: 1rem 2rem;
            background: var(--cyan);
            color: var(--black);
            text-decoration: none;
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: 1.2rem;
            text-transform: uppercase;
            margin-top: 1rem;
            transition: all 0.15s;
        }

        .wizard-success-link:hover {
            background: var(--green);
        }

        /* INTERACTIVE SUMMARY SECTION */
        .section-summary {
            background: var(--black);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-lg) var(--spacing-md);
        }

        .summary-sentence {
            font-size: clamp(1.4rem, 4vw, 2.8rem);
            line-height: 1.8;
            text-align: center;
            max-width: 900px;
            color: var(--white);
            font-style: normal;
        }

        .summary-editable {
            display: inline-block;
            padding: 0.1em 0.3em;
            margin: 0 0.1em;
            cursor: pointer;
            transition: all 0.15s ease-out;
            position: relative;
            border-bottom: 3px solid currentColor;
        }

        .summary-editable:hover {
            transform: scale(1.05);
        }

        .summary-editable.editing {
            border-bottom-style: dashed;
        }

        .summary-editable input {
            background: transparent;
            border: none;
            font-family: 'Oswald', sans-serif;
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            width: 100%;
            text-align: center;
            outline: none;
            padding: 0;
            margin: 0;
        }

        /* Hide number input spinners */
        .summary-editable input::-webkit-outer-spin-button,
        .summary-editable input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .summary-editable input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .edit-raise {
            background: var(--yellow);
            color: var(--blue);
        }

        .edit-raise:hover {
            background: var(--blue);
            color: var(--yellow);
        }

        .edit-tribute {
            background: var(--pink);
            color: var(--black);
        }

        .edit-tribute:hover {
            background: var(--cyan);
            color: var(--black);
        }

        .edit-supply {
            background: var(--cyan);
            color: var(--black);
        }

        .edit-supply:hover {
            background: var(--white);
            color: var(--black);
        }

        .edit-token-type {
            background: var(--green);
            color: var(--black);
        }

        .edit-token-type:hover {
            background: var(--pink);
            color: var(--black);
        }

        .edit-token-type.loot {
            background: var(--pink);
            color: var(--black);
        }

        .edit-token-type.loot:hover {
            background: var(--green);
            color: var(--black);
        }

        .edit-quorum {
            background: var(--orange);
            color: var(--black);
        }

        .edit-quorum:hover {
            background: var(--white);
            color: var(--orange);
        }

        .edit-voting {
            background: var(--blue);
            color: var(--white);
        }

        .edit-voting:hover {
            background: var(--yellow);
            color: var(--blue);
        }

        .edit-timelock {
            background: var(--pink);
            color: var(--black);
        }

        .edit-timelock:hover {
            background: var(--cyan);
            color: var(--black);
        }

        .edit-tap-pct {
            background: var(--green);
            color: var(--black);
        }

        .edit-tap-pct:hover {
            background: var(--cyan);
            color: var(--black);
        }

        .edit-tap-months {
            background: var(--green);
            color: var(--black);
        }

        .edit-tap-months:hover {
            background: var(--cyan);
            color: var(--black);
        }

        .edit-tap-toggle {
            background: transparent;
            color: rgba(255, 255, 255, 0.5);
            padding: 0.1rem 0.3rem;
        }

        .edit-tap-toggle:hover {
            color: var(--cyan);
        }

        .summary-static {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Summary entrance animation - each editable pops in sequence */
        .summary-editable.entrance-pop {
            animation: editablePop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes editablePop {
            0% {
                transform: scale(1);
            }
            30% {
                transform: scale(1.2) rotate(2deg);
            }
            50% {
                transform: scale(0.9) rotate(-1deg);
            }
            70% {
                transform: scale(1.1) rotate(0.5deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        .summary-launch-container {
            margin-top: 3rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .summary-launch-btn {
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(1.2rem, 3vw, 2rem);
            padding: 1em 2.5em;
            background: var(--green);
            color: var(--black);
            border: 4px solid var(--white);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.15s ease-out;
        }

        .summary-launch-btn:hover:not(:disabled) {
            background: var(--cyan);
            transform: scale(1.02);
            border-color: var(--cyan);
        }

        .summary-launch-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .summary-advanced-link {
            font-size: 0.75rem;
            color: var(--white);
            opacity: 0.4;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            transition: opacity 0.15s ease-out;
            margin-top: 0.5rem;
        }

        .summary-advanced-link:hover {
            opacity: 0.8;
        }

        .summary-price-preview {
            font-size: clamp(0.9rem, 2vw, 1.2rem);
            color: var(--cyan);
            font-style: normal;
        }

        .summary-tap-preview {
            font-size: clamp(0.75rem, 1.8vw, 1rem);
            color: var(--green);
            font-style: normal;
            opacity: 0.7;
            margin-top: 0.3em;
        }

        .summary-template-note {
            font-size: clamp(0.7rem, 1.5vw, 0.9rem);
            font-style: normal;
            opacity: 0.8;
            margin-top: 0.5em;
        }

        .summary-template-note.buterin { color: var(--green); }
        .summary-template-note.club { color: var(--yellow); }
        .summary-template-note.builder { color: var(--orange); }
        .summary-template-note.ungovern { color: var(--pink); }

        /* TEMPLATE SELECTOR */
        .template-selector {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .template-btn {
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(0.7rem, 1.5vw, 0.9rem);
            padding: 0.5em 1em;
            background: transparent;
            color: rgba(255, 255, 255, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            transition: all 0.15s ease-out;
            position: relative;
        }

        .template-btn:hover {
            color: var(--white);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .template-btn.active {
            border-color: var(--cyan);
            color: var(--cyan);
            background: rgba(0, 255, 255, 0.1);
        }

        .template-btn.buterin.active {
            border-color: var(--green);
            color: var(--green);
            background: rgba(0, 255, 0, 0.1);
        }

        .template-btn.club.active {
            border-color: var(--yellow);
            color: var(--yellow);
            background: rgba(255, 255, 0, 0.1);
        }

        .template-btn.builder.active {
            border-color: var(--orange);
            color: var(--orange);
            background: rgba(255, 165, 0, 0.1);
        }

        .template-btn.ungovern.active {
            border-color: var(--pink);
            color: var(--pink);
            background: rgba(255, 100, 200, 0.1);
        }

        .template-btn .template-hint {
            display: block;
            font-size: 0.65em;
            font-style: normal;
            opacity: 0.6;
            margin-top: 0.2em;
            text-transform: none;
            letter-spacing: 0;
        }

        /* Card template badges in gallery */
        .daico-template-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            font-family: 'Oswald', sans-serif;
            font-size: 0.65rem;
            font-style: italic;
            padding: 0.2em 0.5em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .daico-template-badge.buterin {
            background: var(--green);
            color: var(--black);
        }

        .daico-template-badge.club {
            background: var(--yellow);
            color: var(--black);
        }

        .daico-template-badge.builder {
            background: var(--orange);
            color: var(--black);
        }

        .daico-template-badge.ungovern {
            background: var(--pink);
            color: var(--black);
        }

        .summary-token-icon {
            display: inline-block;
            width: 1.2em;
            height: 1.2em;
            vertical-align: middle;
            margin-left: 0.15em;
        }

        .summary-token-icon svg {
            width: 100%;
            height: 100%;
        }

        .summary-name-section {
            margin-top: 2.5rem;
            text-align: center;
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            line-height: 2;
            color: rgba(255, 255, 255, 0.6);
        }

        .summary-name-input {
            background: transparent;
            border: none;
            border-bottom: 3px solid var(--cyan);
            color: var(--cyan);
            font-family: 'Oswald', sans-serif;
            font-size: inherit;
            text-align: center;
            padding: 0.1em 0.3em;
            margin: 0 0.2em;
            transition: all 0.15s ease-out;
        }

        .summary-name-input:focus {
            outline: none;
            border-bottom-color: var(--white);
            color: var(--white);
        }

        .summary-name-input::placeholder {
            color: rgba(0, 255, 255, 0.4);
            font-style: italic;
        }

        .summary-name-input.name-field {
            width: 200px;
            border-bottom-color: var(--yellow);
            color: var(--yellow);
        }

        .summary-name-input.name-field:focus {
            border-bottom-color: var(--white);
            color: var(--white);
        }

        .summary-name-input.name-field::placeholder {
            color: rgba(255, 255, 0, 0.4);
        }

        .summary-name-input.symbol-field {
            width: 100px;
            text-transform: uppercase;
            border-bottom-color: var(--orange);
            color: var(--orange);
        }

        .summary-name-input.symbol-field:focus {
            border-bottom-color: var(--white);
            color: var(--white);
        }

        .summary-name-input.symbol-field::placeholder {
            color: rgba(255, 165, 0, 0.4);
        }

        .summary-description-wrapper {
            margin-top: 1rem;
            text-align: center;
        }

        .summary-description {
            background: transparent;
            border: none;
            border-bottom: 2px dashed rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            text-align: center;
            padding: 0.5em;
            width: 80%;
            max-width: 500px;
            min-height: 1.5em;
            resize: none;
            transition: all 0.15s ease-out;
        }

        .summary-description:focus {
            outline: none;
            border-bottom-color: var(--cyan);
            color: var(--white);
        }

        .summary-description::placeholder {
            color: rgba(255, 255, 255, 0.25);
            font-style: italic;
        }

        .summary-duna-hint {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.35);
            margin-top: 0.35rem;
            font-family: 'Roboto Mono', monospace;
        }

        .summary-duna-hint a {
            color: var(--cyan);
            opacity: 0.7;
            text-decoration: none;
        }

        .summary-duna-hint a:hover {
            opacity: 1;
            text-decoration: underline;
        }

        /* ACTIVE DAICOS SECTION */
        .section-active-daicos {
            background: linear-gradient(180deg, #050505 0%, var(--black) 50%, #0a0505 100%);
            min-height: 60vh;
            padding: var(--spacing-xl) var(--spacing-md);
            border-top: 6px solid var(--cyan);
        }

        .active-daicos-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto 1.5rem;
        }

        .active-daicos-title {
            font-family: 'Oswald', sans-serif;
            font-size: clamp(2.5rem, 7vw, 4rem);
            font-style: italic;
            color: var(--green);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-shadow: 3px 3px 0 var(--cyan);
        }

        .refresh-btn {
            background: var(--yellow);
            border: 4px solid var(--black);
            color: var(--black);
            font-size: 1.8rem;
            width: 60px;
            height: 60px;
            cursor: pointer;
            transition: all 0.1s;
            font-weight: bold;
        }

        .refresh-btn:hover {
            background: var(--cyan);
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 var(--white);
        }

        /* Sale status tabs */
        .sale-tabs {
            display: flex;
            gap: 0;
            max-width: 1200px;
            margin: 0 auto 2rem;
        }

        .sale-tab {
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            padding: 0.75rem 1.5rem;
            background: transparent;
            color: rgba(255, 255, 255, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-bottom: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.1s ease-out;
        }

        .sale-tab:first-child {
            border-right: none;
        }

        .sale-tab:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }

        .sale-tab.active {
            color: var(--green);
            background: var(--black);
            border-color: var(--green);
        }

        .sale-tab .tab-count {
            font-style: normal;
            font-size: 0.85em;
            opacity: 0.7;
            margin-left: 0.5rem;
        }

        /* Completed sale card styling */
        .daico-card.completed {
            opacity: 0.7;
            border-color: rgba(0, 255, 255, 0.3);
        }

        .daico-card.completed::before {
            display: none; /* Hide LIVE badge for completed sales */
        }

        .daico-card.completed:hover {
            opacity: 0.9;
        }

        .daico-card.completed .daico-deadline {
            color: var(--orange);
        }

        .sale-status-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-family: 'Oswald', sans-serif;
            font-size: 0.75rem;
            font-style: normal;
            padding: 0.25rem 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sale-status-badge.sold-out {
            background: var(--orange);
            color: var(--black);
        }

        .sale-status-badge.ended {
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
        }

        .active-daicos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .daico-card {
            background: var(--black);
            border: 4px solid var(--cyan);
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.1s ease-out;
            position: relative;
        }

        .daico-card::before {
            content: 'LIVE';
            position: absolute;
            top: -2px;
            right: 12px;
            background: var(--green);
            color: var(--black);
            font-family: 'Oswald', sans-serif;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 4px 10px;
            letter-spacing: 0.1em;
            animation: pulse-badge 2s ease-in-out infinite;
        }

        @keyframes pulse-badge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .daico-card:hover {
            border-color: var(--green);
            background: rgba(0, 255, 255, 0.08);
            transform: translate(-4px, -4px);
            box-shadow: 8px 8px 0 var(--cyan);
        }

        .daico-card:hover::before {
            background: var(--yellow);
        }

        .daico-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 1.25rem;
        }

        .daico-name {
            font-family: 'Oswald', sans-serif;
            font-size: 1.8rem;
            font-style: italic;
            color: var(--white);
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .daico-symbol {
            font-family: 'Oswald', sans-serif;
            font-size: 1.2rem;
            color: var(--cyan);
            font-weight: bold;
        }

        .daico-price {
            font-size: 1.4rem;
            font-family: 'Oswald', sans-serif;
            color: var(--green);
            margin-bottom: 1.25rem;
            font-style: normal;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .daico-trib-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .daico-trib-icon svg {
            width: 100%;
            height: 100%;
        }

        .daico-trib-icon-sm {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            display: inline-flex;
            vertical-align: middle;
            margin-right: 0.25rem;
        }

        .daico-trib-icon-sm svg {
            width: 100%;
            height: 100%;
        }

        .daico-progress {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 0.5rem;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.25);
            position: relative;
        }

        .daico-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--green) 0%, var(--cyan) 100%);
            transition: width 0.5s ease-out;
            position: relative;
            min-width: 2px;
        }

        .daico-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.2) 50%,
                transparent 100%
            );
            animation: progressShine 2s ease-in-out infinite;
        }

        @keyframes progressShine {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .daico-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Oswald', sans-serif;
            font-size: 0.7rem;
            font-style: normal;
            font-weight: 500;
            color: var(--white);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            z-index: 1;
        }

        .daico-progress-labels {
            display: flex;
            justify-content: space-between;
            font-family: 'Oswald', sans-serif;
            font-size: 0.75rem;
            font-style: normal;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.75rem;
        }

        .daico-progress-labels .progress-sold {
            color: var(--green);
            font-weight: 500;
        }

        .daico-progress-labels .progress-total {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Completed/sold out progress bar */
        .daico-progress.sold-out .daico-progress-bar {
            background: linear-gradient(90deg, var(--orange) 0%, var(--yellow) 100%);
        }

        .daico-progress.sold-out .daico-progress-bar::after {
            animation: none;
        }

        .daico-stats {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            font-family: 'Oswald', sans-serif;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1rem;
            font-style: normal;
        }

        .daico-raised {
            color: var(--green);
            font-weight: bold;
            display: inline-flex;
            align-items: center;
        }

        .daico-deadline {
            font-size: 1.1rem;
            font-family: 'Oswald', sans-serif;
            color: var(--yellow);
            font-style: normal;
            font-weight: bold;
            text-transform: uppercase;
        }

        .daico-tap {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 3px solid var(--orange);
            font-size: 1rem;
            font-family: 'Oswald', sans-serif;
            color: var(--orange);
            font-style: normal;
            font-weight: bold;
        }

        .daico-card-content {
            display: flex;
            gap: 1.25rem;
        }

        .daico-image {
            width: 80px;
            height: 80px;
            min-width: 80px;
            border: 2px solid var(--cyan);
            background: var(--black);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .daico-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .daico-image-placeholder {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1) 0%, rgba(0, 255, 0, 0.1) 100%);
        }

        .daico-image-initial {
            font-family: 'Oswald', sans-serif;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--cyan);
            text-transform: uppercase;
        }

        .daico-image-description {
            padding: 0.5rem;
            background: var(--black);
        }

        .daico-desc-text {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.65rem;
            line-height: 1.3;
            color: var(--white);
            display: -webkit-box;
            -webkit-line-clamp: 5;
            line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-break: break-word;
        }

        .daico-info {
            flex: 1;
            min-width: 0;
        }

        .daico-loading, .no-daicos {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            color: var(--cyan);
            font-size: 1.6rem;
            font-family: 'Oswald', sans-serif;
            font-style: italic;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 4px dashed rgba(0, 255, 255, 0.3);
            background: rgba(0, 255, 255, 0.02);
        }

        .daico-loading::before {
            content: '';
            display: block;
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: spin 2s linear infinite;
        }

        .no-daicos::before {
            content: '';
            display: block;
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* PURCHASE MODAL */
        .purchase-container {
            background: var(--black);
            border: 6px solid var(--green);
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            box-shadow: 12px 12px 0 var(--cyan);
            margin: auto;
        }

        .purchase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .purchase-title {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            font-style: italic;
            color: var(--green);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .purchase-header .daico-template-badge {
            align-self: center;
        }

        .purchase-description {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.85);
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--cyan);
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            max-height: 100px;
            overflow-y: auto;
            word-break: break-word;
        }

        .purchase-info {
            background: rgba(0, 255, 255, 0.05);
            border: 3px solid var(--cyan);
            padding: 1.25rem;
            margin-bottom: 1.75rem;
        }

        .purchase-info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 1rem;
            font-style: normal;
            font-family: 'Oswald', sans-serif;
        }

        .purchase-info-row span:first-child {
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
        }

        .purchase-info-row span:last-child {
            color: var(--white);
            font-weight: bold;
        }

        /* Purchase Modal Progress Bar */
        .purchase-progress-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(0, 255, 255, 0.2);
        }

        .purchase-progress {
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.25);
            position: relative;
            margin-bottom: 0.5rem;
        }

        .purchase-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--green) 0%, var(--cyan) 100%);
            transition: width 0.5s ease-out;
            position: relative;
            min-width: 2px;
        }

        .purchase-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.2) 50%,
                transparent 100%
            );
            animation: progressShine 2s ease-in-out infinite;
        }

        .purchase-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Oswald', sans-serif;
            font-size: 0.8rem;
            font-style: normal;
            font-weight: 500;
            color: var(--white);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            z-index: 1;
        }

        .purchase-progress-labels {
            display: flex;
            justify-content: space-between;
            font-family: 'Oswald', sans-serif;
            font-size: 0.8rem;
            font-style: normal;
            color: rgba(255, 255, 255, 0.6);
        }

        .purchase-progress-labels .progress-sold {
            color: var(--green);
            font-weight: 500;
        }

        .purchase-progress-labels .progress-remaining {
            color: var(--cyan);
        }

        .purchase-progress.sold-out .purchase-progress-bar {
            background: linear-gradient(90deg, var(--orange) 0%, var(--yellow) 100%);
        }

        .purchase-progress.sold-out .purchase-progress-bar::after {
            animation: none;
        }

        .swap-container {
            margin-bottom: 1.25rem;
        }

        .swap-box {
            background: rgba(255, 255, 255, 0.03);
            border: 3px solid rgba(255, 255, 255, 0.2);
            padding: 1.25rem;
            transition: all 0.1s;
        }

        .swap-box:focus-within {
            border-color: var(--cyan);
            background: rgba(0, 255, 255, 0.05);
        }

        .swap-pay {
            border-radius: 0;
        }

        .swap-receive {
            border-radius: 0;
            border-top: none;
        }

        .swap-label {
            font-size: 0.95rem;
            font-family: 'Oswald', sans-serif;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.75rem;
            font-style: normal;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .swap-input-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .swap-input {
            flex: 1;
            background: transparent;
            border: none;
            font-family: 'Oswald', sans-serif;
            font-size: 2.2rem;
            color: var(--white);
            outline: none;
            width: 100%;
            min-width: 0;
        }

        .swap-input::placeholder {
            color: rgba(255, 255, 255, 0.25);
        }

        .swap-token {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem 1rem;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 0;
            flex-shrink: 0;
        }

        .swap-token-icon {
            width: 28px;
            height: 28px;
        }

        .swap-token span {
            font-family: 'Oswald', sans-serif;
            font-size: 1.15rem;
            color: var(--white);
            font-weight: bold;
        }

        .swap-balance {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-top: 0.75rem;
            font-size: 0.9rem;
            font-family: 'Oswald', sans-serif;
            color: rgba(255, 255, 255, 0.5);
            font-style: normal;
        }

        .max-btn {
            background: var(--yellow);
            color: var(--black);
            border: 2px solid var(--black);
            padding: 0.3rem 0.7rem;
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
        }

        .max-btn:hover {
            background: var(--cyan);
            transform: translate(-1px, -1px);
            box-shadow: 2px 2px 0 var(--white);
        }

        .swap-arrow {
            text-align: center;
            font-size: 1.6rem;
            color: var(--green);
            margin: -0.5rem 0;
            position: relative;
            z-index: 1;
            font-weight: bold;
        }

        .slippage-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.75rem;
            font-size: 1rem;
            font-family: 'Oswald', sans-serif;
            color: rgba(255, 255, 255, 0.6);
            font-style: normal;
            text-transform: uppercase;
        }

        .slippage-options {
            display: flex;
            gap: 0.6rem;
        }

        .slippage-btn {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.6);
            padding: 0.4rem 0.8rem;
            font-family: 'Oswald', sans-serif;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.1s;
        }

        .slippage-btn.active {
            border-color: var(--green);
            color: var(--green);
            background: rgba(85, 251, 155, 0.1);
        }

        .slippage-btn:hover {
            border-color: var(--cyan);
            color: var(--cyan);
        }

        .purchase-btn {
            width: 100%;
            padding: 1.25rem;
            font-family: 'Oswald', sans-serif;
            font-size: 1.4rem;
            font-style: italic;
            border: 4px solid var(--black);
            cursor: pointer;
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: bold;
        }

        .approve-btn {
            background: var(--yellow);
            color: var(--black);
            margin-bottom: 0.75rem;
        }

        .approve-btn:hover:not(:disabled) {
            background: var(--orange);
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 var(--yellow);
        }

        .buy-btn {
            background: var(--green);
            color: var(--black);
        }

        .buy-btn:hover:not(:disabled) {
            background: var(--cyan);
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 var(--green);
        }

        .purchase-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .tap-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 4px solid var(--orange);
        }

        .tap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-style: normal;
        }

        .tap-header span:first-child {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
        }

        .tap-amount {
            color: var(--orange);
            font-family: 'Roboto Mono', monospace;
            font-size: 1.3rem;
            font-weight: bold;
            letter-spacing: 0.02em;
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.3);
        }

        .tap-claim-btn {
            width: 100%;
            padding: 1rem;
            background: var(--orange);
            color: var(--black);
            border: 4px solid var(--black);
            font-family: 'Oswald', sans-serif;
            font-size: 1.2rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.1s;
        }

        .tap-claim-btn:hover:not(:disabled) {
            background: var(--yellow);
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 var(--orange);
        }

        .tap-claim-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .purchase-footer {
            margin-top: 2rem;
            text-align: center;
        }

        .majeur-link {
            color: var(--cyan);
            text-decoration: none;
            font-size: 1rem;
            font-family: 'Oswald', sans-serif;
            font-style: normal;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.1s;
            border-bottom: 2px solid transparent;
            padding-bottom: 2px;
        }

        .majeur-link:hover {
            color: var(--green);
            border-bottom-color: var(--green);
        }

        @media (max-width: 600px) {
            .wizard-choice {
                grid-template-columns: 1fr;
            }

            .wizard-input-row {
                grid-template-columns: 1fr;
            }

            .wizard-founder-row {
                grid-template-columns: 1fr;
            }

            .wizard-founder-row .wizard-founder-input:first-child {
                grid-column: 1;
            }
        }

        /* TABLET ADJUSTMENTS */
        @media (min-width: 768px) {
            .hero-top {
                gap: clamp(2rem, 8vh, 5rem);
            }

            .word-row.center {
                padding-left: 15%;
            }

            .word-row.left {
                padding-left: 3%;
            }
        }

        /* DESKTOP ADJUSTMENTS */
        @media (min-width: 1024px) {
            .hero-content {
                padding: var(--spacing-lg);
                padding-bottom: calc(var(--spacing-lg) + 80px);
            }

            .word-row.center {
                padding-left: 20%;
            }

            .section {
                padding: var(--spacing-lg);
            }

            /* Smaller DAICO.WTF on desktop to not hug GROW */
            .daico {
                font-size: clamp(2.5rem, 8vw, 10rem);
            }
        }

        /* LARGE DESKTOP */
        @media (min-width: 1400px) {
            .hero-content {
                max-width: 1800px;
                margin: 0 auto;
                width: 100%;
            }

            .section {
                max-width: 1800px;
                margin: 0 auto;
            }

            .daico {
                font-size: clamp(3rem, 7vw, 9rem);
            }
        }

        /* SMALL MOBILE */
        @media (max-width: 480px) {
            .word {
                padding: 0.05em 0.15em;
            }

            .section .theme {
                padding: 0.05em 0.15em;
            }

            .section .section-daico {
                padding: 0.05em 0.15em;
            }

            .launch-btn {
                padding: 0.4em 0.8em;
            }
        }

        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 600px) {
            /* Header */
            .wallet-header {
                padding: 0.75rem 1rem;
                gap: 0.5rem;
            }

            .wallet-btn {
                padding: 0.5em 0.8em;
                font-size: 0.85rem;
            }

            .network-selector .network-badge {
                font-size: 0.7rem;
                padding: 0.4em 0.6em;
            }

            /* Launch button */
            .launch-btn {
                font-size: clamp(0.7rem, 2.5vw, 0.9rem);
                padding: 0.5em 0.8em;
                top: 0.75rem;
                left: 0.75rem;
            }

            /* Wallet modal */
            .wallet-modal-content {
                padding: 1.25rem;
                margin: 1rem;
                max-width: calc(100% - 2rem);
            }

            .wallet-modal-title {
                font-size: 1.25rem;
                margin-bottom: 1rem;
            }

            .wallet-option {
                padding: 0.85rem;
                gap: 0.75rem;
            }

            .wallet-option-icon {
                font-size: 1.3rem;
            }

            .wallet-option-name {
                font-size: 0.95rem;
            }

            /* Wizard modal */
            .wizard-container {
                padding: 1.25rem;
                margin: 0.75rem;
                max-width: calc(100% - 1.5rem);
            }

            .wizard-title {
                font-size: 1.5rem;
            }

            .wizard-step-title {
                font-size: 1.1rem;
            }

            .wizard-choice-btn {
                padding: 1rem;
            }

            .wizard-choice-icon {
                font-size: 2rem;
            }

            .wizard-choice-title {
                font-size: 1rem;
            }

            .wizard-choice-desc {
                font-size: 0.8rem;
            }

            .wizard-input {
                padding: 0.85rem;
                font-size: 1rem;
            }

            .wizard-raise-btn {
                padding: 0.85rem;
            }

            .wizard-raise-amount {
                font-size: 1.3rem;
            }

            .wizard-btn {
                padding: 1rem;
                font-size: 1.1rem;
            }

            .wizard-nav {
                flex-direction: column;
                gap: 0.75rem;
            }

            .wizard-nav button {
                width: 100%;
            }

            .wizard-close {
                width: 38px;
                height: 38px;
                font-size: 2rem;
            }

            /* DAICO Cards */
            .active-daicos-grid {
                grid-template-columns: 1fr;
                gap: 1.25rem;
                padding: 0 0.5rem;
            }

            .active-daicos-header {
                padding: 0 0.5rem;
                margin-bottom: 1rem;
            }

            .active-daicos-title {
                font-size: 1.8rem;
            }

            .refresh-btn {
                width: 48px;
                height: 48px;
                font-size: 1.4rem;
            }

            .sale-tabs {
                padding: 0 0.5rem;
                margin-bottom: 1.5rem;
            }

            .sale-tab {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }

            .sale-status-badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }

            .daico-card {
                padding: 1.25rem;
                border-width: 3px;
            }

            .daico-card::before {
                font-size: 0.65rem;
                padding: 3px 8px;
                right: 8px;
            }

            .daico-template-badge {
                font-size: 0.55rem;
                padding: 0.15em 0.4em;
            }

            .daico-name {
                font-size: 1.4rem;
            }

            .daico-symbol {
                font-size: 1rem;
            }

            .daico-price {
                font-size: 1.15rem;
            }

            .daico-trib-icon {
                width: 20px;
                height: 20px;
            }

            .daico-trib-icon-sm {
                width: 14px;
                height: 14px;
            }

            .daico-progress {
                height: 16px;
            }

            .daico-progress-text {
                font-size: 0.6rem;
            }

            .daico-progress-labels {
                font-size: 0.65rem;
                margin-bottom: 0.5rem;
            }

            .daico-stats {
                font-size: 0.9rem;
            }

            .daico-deadline {
                font-size: 0.95rem;
            }

            .daico-image {
                width: 64px;
                height: 64px;
                min-width: 64px;
            }

            .daico-image-initial {
                font-size: 2rem;
            }

            .daico-desc-text {
                font-size: 0.55rem;
                -webkit-line-clamp: 4;
                line-clamp: 4;
            }

            .daico-card-content {
                gap: 1rem;
            }

            /* Purchase modal */
            .purchase-container {
                padding: 1.25rem;
                margin: 0.75rem;
                max-width: calc(100% - 1.5rem);
                border-width: 4px;
                box-shadow: 8px 8px 0 var(--cyan);
            }

            .purchase-title {
                font-size: 1.5rem;
            }

            .purchase-info {
                padding: 1rem;
                margin-bottom: 1.25rem;
            }

            .purchase-info-row {
                font-size: 0.9rem;
                padding: 0.35rem 0;
            }

            .purchase-progress {
                height: 20px;
            }

            .purchase-progress-text {
                font-size: 0.7rem;
            }

            .purchase-progress-labels {
                font-size: 0.7rem;
            }

            .swap-box {
                padding: 1rem;
            }

            .swap-input {
                font-size: 1.6rem;
            }

            .swap-label {
                font-size: 0.85rem;
            }

            .swap-token {
                padding: 0.5rem 0.75rem;
            }

            .swap-token-icon {
                width: 22px;
                height: 22px;
            }

            .swap-token span {
                font-size: 1rem;
            }

            .swap-balance {
                font-size: 0.8rem;
            }

            .max-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }

            .slippage-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .slippage-options {
                width: 100%;
                justify-content: space-between;
            }

            .slippage-btn {
                flex: 1;
                text-align: center;
                padding: 0.5rem;
            }

            .purchase-btn {
                padding: 1rem;
                font-size: 1.2rem;
            }

            .tap-section {
                margin-top: 1.5rem;
                padding-top: 1.5rem;
            }

            .tap-claim-btn {
                padding: 0.85rem;
                font-size: 1rem;
            }

            /* Summary section */
            .template-selector {
                gap: 0.5rem;
                margin-bottom: 1.5rem;
            }

            .template-btn {
                font-size: 0.7rem;
                padding: 0.4em 0.75em;
            }

            .template-btn .template-hint {
                font-size: 0.6em;
            }

            .summary-sentence {
                font-size: clamp(1rem, 4vw, 1.4rem);
                line-height: 1.8;
            }

            .summary-editable {
                padding: 0.15em 0.3em;
            }

            .summary-launch-btn {
                padding: 1rem 2rem;
                font-size: 1.1rem;
            }

            /* Launch modal (advanced form) */
            .modal-content {
                padding: 1.25rem;
                margin: 0.75rem;
                max-width: calc(100% - 1.5rem);
            }

            .modal-title {
                font-size: 1.4rem;
            }

            .form-input, .form-select {
                padding: 0.75rem;
                font-size: 0.95rem;
            }

            .form-label {
                font-size: 0.85rem;
            }

            /* Advanced form modal optimizations */
            .modal-container {
                margin: 0.5rem;
                max-height: calc(100vh - 1rem);
            }

            .modal-header {
                padding: 0.85rem 1rem;
            }

            .modal-body {
                padding: 1rem;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .form-section {
                margin-bottom: 1.5rem;
            }

            .form-section-title {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            .form-group {
                margin-bottom: 0.75rem;
            }

            .toggle-section {
                padding: 0.85rem;
            }

            .toggle-header label {
                font-size: 0.9rem;
            }

            .toggle-content {
                padding-top: 0.75rem;
            }

            .viz-panel {
                padding: 0.85rem;
                margin-bottom: 1.25rem;
            }

            .viz-title {
                font-size: 0.9rem;
            }

            .viz-row {
                font-size: 0.85rem;
            }

            /* Submit button */
            .submit-btn {
                padding: 1rem;
                font-size: 1.1rem;
            }

            /* Tap config buttons */
            .tap-preset-btn, .tap-duration-btn {
                padding: 0.5rem 0.9rem;
                font-size: 0.9rem;
            }

            .tap-preset-btns {
                gap: 0.4rem !important;
            }

            /* Wizard tap effect box */
            #wizardTapEffect {
                font-size: 0.85rem !important;
                padding: 0.75rem !important;
            }

            /* Wizard tap ops display */
            .tap-ops-display {
                font-size: 0.75rem !important;
                padding: 0.6rem 0.8rem !important;
            }

            /* Text summoning improvements */
            .summary-name-section {
                flex-direction: column;
                gap: 0.5rem;
            }

            .summary-name-input.name-field {
                width: 100%;
                max-width: none;
            }

            .summary-name-input.symbol-field {
                width: 80px;
            }

            .summary-description {
                font-size: 0.9rem;
            }

            .summary-tap-preview {
                font-size: 0.7rem;
            }

            /* Advanced form grid fixes */
            .form-row {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            .form-group-row {
                flex-direction: column;
                gap: 0.75rem;
            }

            /* LP and tap sections in advanced form */
            .lp-config-section,
            .tap-config-section {
                padding: 1rem;
            }

            .lp-config-section .form-row,
            .tap-config-section .form-row {
                gap: 0.75rem;
            }
        }

        /* EXTRA SMALL MOBILE */
        @media (max-width: 360px) {
            .wallet-header {
                padding: 0.5rem 0.75rem;
            }

            .wallet-btn {
                padding: 0.4em 0.6em;
                font-size: 0.75rem;
            }

            .launch-btn {
                font-size: 0.65rem;
                padding: 0.4em 0.6em;
            }

            .wizard-container,
            .purchase-container,
            .modal-content {
                padding: 1rem;
                margin: 0.5rem;
            }

            .daico-card {
                padding: 1rem;
            }

            .daico-name {
                font-size: 1.2rem;
            }

            .daico-image {
                width: 56px;
                height: 56px;
                min-width: 56px;
            }

            .daico-image-initial {
                font-size: 1.6rem;
            }

            .daico-desc-text {
                font-size: 0.5rem;
                -webkit-line-clamp: 3;
                line-clamp: 3;
            }

            .purchase-title,
            .wizard-title {
                font-size: 1.3rem;
            }

            .swap-input {
                font-size: 1.4rem;
            }

            /* Tap buttons on extra small */
            .tap-preset-btn, .tap-duration-btn {
                padding: 0.4rem 0.7rem;
                font-size: 0.8rem;
            }

            /* Summary text on extra small */
            .summary-sentence {
                font-size: 0.9rem;
                line-height: 1.7;
            }

            .summary-editable {
                padding: 0.1em 0.2em;
            }

            .summary-price-preview {
                font-size: 0.75rem;
            }

            .summary-tap-preview {
                font-size: 0.65rem;
            }

            .summary-name-section {
                font-size: 1rem;
            }

            .summary-launch-btn {
                padding: 0.85rem 1.5rem;
                font-size: 1rem;
            }
        }

        /* TOUCH DEVICE OPTIMIZATIONS */
        @media (hover: none) {
            .word:active,
            .section .theme:active,
            .section .section-daico:active {
                transform: scale(0.98);
            }

            /* Larger touch targets */
            .wallet-option {
                min-height: 52px;
            }

            .wizard-choice-btn {
                min-height: 80px;
            }

            .slippage-btn {
                min-height: 44px;
            }

            .tap-preset-btn, .tap-duration-btn {
                min-height: 44px;
            }

            .summary-editable {
                min-height: 32px;
                display: inline-flex;
                align-items: center;
            }

            .summary-launch-btn {
                min-height: 52px;
            }

            /* Remove hover effects that don't work on touch */
            .daico-card:hover {
                transform: none;
                box-shadow: none;
            }

            .daico-card:active {
                transform: scale(0.98);
                border-color: var(--green);
            }

            .purchase-btn:hover:not(:disabled) {
                transform: none;
                box-shadow: none;
            }

            .purchase-btn:active:not(:disabled) {
                transform: scale(0.98);
            }

            .tap-preset-btn:active, .tap-duration-btn:active {
                transform: scale(0.95);
            }

            .summary-editable:active {
                transform: scale(0.98);
            }

            .wizard-raise-btn:active {
                transform: scale(0.98);
            }

            .zamm-swap-badge:hover {
                opacity: 0.6;
                border-color: transparent;
                background: transparent;
            }

            .zamm-swap-badge:active {
                opacity: 1;
                transform: rotate(4deg) scale(0.95);
            }

            .majeur-badge:hover {
                opacity: 0.6;
                border-color: transparent;
                background: transparent;
            }

            .majeur-badge:active {
                opacity: 1;
                border-color: #c4b5fd;
                transform: rotate(-5deg) scale(0.95);
            }
        }

        /* REDUCED MOTION */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            html {
                scroll-behavior: auto;
            }

            .daico-card::before {
                animation: none;
            }
        }

        /* LANDSCAPE MOBILE */
        @media (max-height: 500px) and (orientation: landscape) {
            .wizard-container,
            .purchase-container {
                max-height: 95vh;
                overflow-y: auto;
            }

            .wizard-choice {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* HIGH DPI / RETINA */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .daico-card,
            .purchase-container,
            .wallet-modal-content {
                border-width: 3px;
            }
        }
    </style>
</head>
<body>
    <!-- LAUNCH BUTTON - Fixed top left, visible on all pages -->
    <button id="launchBtn" class="launch-btn" onclick="document.getElementById('summary-section').scrollIntoView({behavior: 'smooth'})">Launch DAICO</button>

    <!-- WALLET HEADER (Network & Wallet - top right) -->
    <div class="wallet-header">
        <div class="network-selector" id="networkSelector" data-network="ethereum">
            <button class="network-badge" onclick="toggleNetworkDropdown()">
                <span class="network-dot"></span>
                <span id="networkName">Ethereum</span>
                <span class="dropdown-arrow"></span>
            </button>
            <div class="network-dropdown" id="networkDropdown">
                <button class="network-option active" data-network="ethereum" onclick="switchNetwork('ethereum')">
                    <span class="network-icon ethereum">E</span>
                    Ethereum
                </button>
                <button class="network-option" data-network="base" onclick="switchNetwork('base')">
                    <span class="network-icon base">B</span>
                    Base
                </button>
                <button class="network-option" data-network="arbitrum" onclick="switchNetwork('arbitrum')">
                    <span class="network-icon arbitrum">A</span>
                    Arbitrum
                </button>
                <button class="network-option" data-network="sepolia" onclick="switchNetwork('sepolia')">
                    <span class="network-icon sepolia">S</span>
                    Sepolia
                </button>
            </div>
        </div>
        <button id="walletBtn" class="wallet-btn" onclick="connectWallet()">Connect</button>
    </div>

    <div class="attribution-box" id="attributionBox">
        <span>built by </span><a href="https://majeurdao.eth.limo/#/dao/1/0x5E58BA0e06ED0F5558f83bE732a4b899a674053E" target="_blank" rel="noopener">zOrg</a><span> for </span><a href="https://zamm.finance/" target="_blank" rel="noopener">zamm.finance</a>
    </div>

    <a href="https://github.com/z0r0z/majeur" target="_blank" rel="noopener noreferrer" class="github-link" title="View on GitHub">GitHub</a>

    <!-- HERO -->
    <section class="hero">
        <svg class="lines">
            <defs>
                <filter id="sketchy" x="-20%" y="-20%" width="140%" height="140%">
                    <feTurbulence type="turbulence" baseFrequency="0.05" numOctaves="2" result="noise" seed="1"/>
                    <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G"/>
                </filter>
            </defs>
            <path class="line1" id="line1" />
            <path class="line2" id="line2" />
            <path class="line3" id="line3" />
        </svg>

        <div class="hero-content">
            <div class="hero-top">
                <div class="word-row left">
                    <div class="word fund" id="fund" onclick="document.getElementById('fund-section').scrollIntoView({behavior: 'smooth'})">FUND</div>
                </div>
                <div class="word-row center">
                    <div class="word ctrl" id="ctrl" onclick="document.getElementById('ctrl-section').scrollIntoView({behavior: 'smooth'})">CTRL</div>
                </div>
                <div class="word-row left">
                    <div class="word grow" id="grow" onclick="document.getElementById('grow-section').scrollIntoView({behavior: 'smooth'})">GROW</div>
                </div>
            </div>
            <div class="hero-bottom">
                <div class="word daico" id="daico">DAICO.WTF</div>
            </div>
        </div>

        <!-- How It Works Post-it Note -->
        <div class="how-it-works">
            <div class="how-it-works-header">How it works</div>
            <ul class="how-it-works-list">
                <li data-num="1.">crowdfund a dao</li>
                <li data-num="2.">ops gets vesting</li>
                <li data-num="3.">dao can turn off</li>
                <li data-num="4.">refund whenever</li>
            </ul>
        </div>

        <!-- Tagline Note -->
        <div class="tagline-note">DAOs if they didn't suck</div>

        <!-- Venn Diagram Link -->
        <a href="https://ethresear.ch/t/explanation-of-daicos/465/1" target="_blank" rel="noopener" class="venn-diagram-link" title="Read Vitalik's DAICO explanation">
            <svg viewBox="0 0 170 100">
                <defs>
                    <clipPath id="leftClip"><ellipse cx="50" cy="55" rx="45" ry="35"/></clipPath>
                </defs>
                <text x="50" y="14" font-family="sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#000">DAO</text>
                <text x="120" y="14" font-family="sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#000">ICO</text>
                <ellipse cx="50" cy="55" rx="45" ry="35" fill="none" stroke="#000" stroke-width="1.5"/>
                <ellipse cx="120" cy="55" rx="45" ry="35" fill="none" stroke="#000" stroke-width="1.5"/>
                <ellipse cx="120" cy="55" rx="45" ry="35" fill="rgba(0,0,0,0.15)" clip-path="url(#leftClip)"/>
            </svg>
        </a>

        <!-- Handwritten notes -->
        <div class="handwritten-note">moloch + ico</div>
        <div class="handwritten-note handwritten-note-right">tokens that do things</div>
        <div class="handwritten-note handwritten-note-bottom">refundable programmable fundraises</div>

        <a href="#fund-section" class="scroll-hint">
            <span>Scroll</span>
            <div class="arrow"></div>
        </a>
    </section>

    <!-- FUND SECTION -->
    <section class="section section-fund" id="fund-section">
        <div class="theme">FUND</div>
        <div class="content">
            <p>Sell tokens. Raise funds. Do things onchain. Automatically.</p>
            <div class="crossed-word crossed-snipers">
                <span class="crossed-text">snipers</span>
                <svg class="cross-lines" viewBox="0 0 100 50">
                    <path class="cross-line cross-1" d="M 5,42 Q 30,35 50,25 T 95,8" />
                    <path class="cross-line cross-2" d="M 5,8 Q 30,15 50,25 T 95,42" />
                </svg>
            </div>
            <div class="crossed-word crossed-insiders">
                <span class="crossed-text">insiders</span>
                <svg class="cross-lines" viewBox="0 0 100 50">
                    <path class="cross-line cross-1" d="M 5,42 Q 30,35 50,25 T 95,8" />
                    <path class="cross-line cross-2" d="M 5,8 Q 30,15 50,25 T 95,42" />
                </svg>
            </div>
            <div class="crossed-word crossed-bs">
                <span class="crossed-text">bs</span>
                <svg class="cross-lines" viewBox="0 0 100 50">
                    <path class="cross-line cross-1" d="M 5,42 Q 30,35 50,25 T 95,8" />
                    <path class="cross-line cross-2" d="M 5,8 Q 30,15 50,25 T 95,42" />
                </svg>
            </div>
        </div>
        <!-- ZAMM swap badge -->
        <a href="https://zamm.finance/" target="_blank" rel="noopener" class="zamm-swap-badge" title="Swap DAICO tokens on ZAMM">
            <img src="https://content.wrappr.wtf/ipfs/bafybeibuct6mftnmgzkbn4tq47elpokbkahkjxq7z6qceptlcsvpxletou" alt="ZAMM">
            <span class="zamm-text">swap</span>
        </a>
        <div class="section-daico">DAICO.WTF</div>
    </section>

    <!-- CTRL SECTION -->
    <section class="section section-ctrl" id="ctrl-section">
        <div class="theme">CTRL</div>
        <div class="content">
            <p>Token holders control funds. Vote on spending based on your share. Adjust TAP to OPS. Ragequit for refund. No meetings. Always online as a DAO.</p>
            <!-- Hand-drawn diagram -->
            <div class="ctrl-diagram">
                <svg class="diagram-svg" viewBox="0 0 400 200">
                    <defs>
                        <filter id="sketchy-diagram" x="-20%" y="-20%" width="140%" height="140%">
                            <feTurbulence type="turbulence" baseFrequency="0.03" numOctaves="2" result="noise" seed="3"/>
                            <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G"/>
                        </filter>
                    </defs>

                    <!-- DAO box (center) -->
                    <rect class="diagram-box dao-box" x="150" y="70" width="100" height="60" rx="3"/>
                    <text class="diagram-label dao-label" x="200" y="105">DAO</text>

                    <!-- Treasury box (top) -->
                    <rect class="diagram-box treasury-box" x="150" y="5" width="100" height="45" rx="3"/>
                    <text class="diagram-label treasury-label" x="200" y="33">treasury</text>

                    <!-- Ops box (right) -->
                    <rect class="diagram-box ops-box" x="290" y="75" width="90" height="50" rx="3"/>
                    <text class="diagram-label ops-label" x="335" y="105">ops</text>

                    <!-- Holder icon (left) -->
                    <circle class="diagram-box holder-box" cx="60" cy="100" r="30"/>
                    <text class="diagram-label holder-label" x="60" y="105">you</text>

                    <!-- Exit box (bottom) -->
                    <rect class="diagram-box exit-box" x="150" y="150" width="100" height="40" rx="3"/>
                    <text class="diagram-label exit-label" x="200" y="175">exit</text>

                    <!-- Connecting lines -->
                    <!-- Holder to DAO (vote) -->
                    <path class="diagram-line line-vote" d="M 90,100 Q 110,100 150,100"/>
                    <text class="diagram-line-label label-vote" x="120" y="92">vote</text>

                    <!-- Treasury to DAO -->
                    <path class="diagram-line line-treasury" d="M 200,50 L 200,70"/>

                    <!-- DAO to Ops (TAP) - dotted line -->
                    <text class="diagram-line-label label-tap" x="270" y="92">tap</text>
                    <path class="diagram-line line-tap dotted" d="M 250,105 Q 270,105 290,105"/>

                    <!-- Holder to Exit (ragequit) -->
                    <path class="diagram-line line-ragequit" d="M 60,130 Q 60,170 150,170"/>
                    <text class="diagram-line-label label-ragequit" x="95" y="148">ragequit</text>
                </svg>
            </div>
        </div>
        <!-- Majeur DAO badge -->
        <a href="https://majeurdao.eth.limo/" target="_blank" rel="noopener" class="majeur-badge" title="Manage your DAO on Majeur">
            <svg viewBox="0 0 32 32" fill="none">
                <line x1="16" y1="0" x2="16" y2="16" stroke="currentColor" stroke-width="1" opacity="0.7"/>
                <line x1="16" y1="32" x2="16" y2="16" stroke="currentColor" stroke-width="1" opacity="0.7"/>
                <line x1="0" y1="16" x2="16" y2="16" stroke="currentColor" stroke-width="1" opacity="0.7"/>
                <line x1="32" y1="16" x2="16" y2="16" stroke="currentColor" stroke-width="1" opacity="0.7"/>
                <line x1="3" y1="3" x2="16" y2="16" stroke="currentColor" stroke-width="0.8" opacity="0.5"/>
                <line x1="29" y1="3" x2="16" y2="16" stroke="currentColor" stroke-width="0.8" opacity="0.5"/>
                <line x1="3" y1="29" x2="16" y2="16" stroke="currentColor" stroke-width="0.8" opacity="0.5"/>
                <line x1="29" y1="29" x2="16" y2="16" stroke="currentColor" stroke-width="0.8" opacity="0.5"/>
                <circle cx="16" cy="16" r="5" fill="none" stroke="currentColor" stroke-width="0.8" opacity="0.5"/>
                <circle cx="16" cy="16" r="2.5" fill="currentColor" opacity="0.6"/>
            </svg>
            <span class="majeur-text">majeur</span>
        </a>
        <div class="section-daico">DAICO.WTF</div>
    </section>

    <!-- GROW SECTION -->
    <section class="section section-grow" id="grow-section">
        <div class="theme">GROW</div>
        <div class="content">
            <p>Plug into open finance on the <a href="https://ethereum.org/" target="_blank" rel="noopener" class="world-computer-link">World Computer</a>. Cut out the middleman and put that money back into your ventures.</p>
        </div>
        <div class="section-daico">DAICO.WTF</div>

        <!-- Farm illustration -->
        <svg class="grow-illustration" viewBox="0 0 500 300" preserveAspectRatio="xMidYMid slice">
            <defs>
                <filter id="sketchy-grow" x="-20%" y="-20%" width="140%" height="140%">
                    <feTurbulence type="turbulence" baseFrequency="0.035" numOctaves="2" result="noise" seed="7"/>
                    <feDisplacementMap in="SourceGraphic" in2="noise" scale="2.5" xChannelSelector="R" yChannelSelector="G"/>
                </filter>
            </defs>

            <!-- Action bubble (top right) - jagged comic style -->
            <g class="action-bubble">
                <!-- Jagged starburst shape -->
                <path class="bubble-shape" d="
                    M 420,25
                    L 435,45 L 460,35 L 455,60 L 480,65
                    L 465,85 L 485,100 L 460,105 L 470,130
                    L 445,120 L 435,145 L 420,125 L 400,140
                    L 400,115 L 375,120 L 385,95 L 360,85
                    L 380,70 L 365,50 L 390,55 L 395,30
                    L 415,45 Z
                "/>
                <!-- DEFI text -->
                <text class="bubble-text" x="422" y="95">DEFI</text>
            </g>

            <!-- Rays from bubble going left/down -->
            <g class="bubble-rays">
                <line class="bubble-ray ray-1" x1="360" y1="85" x2="50" y2="180"/>
                <line class="bubble-ray ray-2" x1="375" y1="120" x2="80" y2="250"/>
                <line class="bubble-ray ray-3" x1="400" y1="140" x2="150" y2="280"/>
                <line class="bubble-ray ray-4" x1="365" y1="50" x2="20" y2="120"/>
                <line class="bubble-ray ray-5" x1="385" y1="95" x2="30" y2="200"/>
            </g>

            <!-- Ground line -->
            <path class="ground-line" d="M 0,280 Q 125,275 250,280 T 500,275"/>

            <!-- Bean stalks (moved to left side) -->
            <g class="stalk stalk-1">
                <path class="stalk-stem" d="M 60,280 Q 58,250 62,220 Q 60,190 65,160"/>
                <path class="stalk-leaf leaf-right-1" d="M 62,220 Q 85,215 95,228 Q 80,220 62,220"/>
                <path class="stalk-leaf leaf-left-1" d="M 60,190 Q 38,182 28,195 Q 45,188 60,190"/>
                <path class="stalk-leaf leaf-right-2" d="M 65,165 Q 88,158 98,172 Q 82,165 65,165"/>
            </g>

            <g class="stalk stalk-2">
                <path class="stalk-stem" d="M 120,280 Q 122,255 118,230 Q 120,205 117,175 Q 120,150 115,120"/>
                <path class="stalk-leaf leaf-right-1" d="M 118,230 Q 142,222 152,238 Q 138,228 118,230"/>
                <path class="stalk-leaf leaf-left-1" d="M 120,200 Q 95,192 82,208 Q 100,198 120,200"/>
                <path class="stalk-leaf leaf-right-2" d="M 117,170 Q 142,162 152,178 Q 138,168 117,170"/>
                <path class="stalk-leaf leaf-left-2" d="M 115,140 Q 90,130 78,145 Q 95,135 115,140"/>
            </g>

            <g class="stalk stalk-3">
                <path class="stalk-stem" d="M 180,280 Q 178,260 182,240 Q 180,220 183,195"/>
                <path class="stalk-leaf leaf-left-1" d="M 182,240 Q 158,235 148,248 Q 165,240 182,240"/>
                <path class="stalk-leaf leaf-right-1" d="M 180,215 Q 205,208 215,222 Q 198,213 180,215"/>
            </g>
        </svg>
    </section>

    <!-- INTERACTIVE SUMMARY SECTION -->
    <section class="section-summary" id="summary-section">
        <!-- TEMPLATE SELECTOR -->
        <div class="template-selector">
            <button class="template-btn buterin active" onclick="applyTemplate('buterin')">
                Buterin
                <span class="template-hint">tap + governance</span>
            </button>
            <button class="template-btn club" onclick="applyTemplate('club')">
                Club
                <span class="template-hint">vote on spends</span>
            </button>
            <button class="template-btn builder" onclick="applyTemplate('builder')">
                Builder
                <span class="template-hint">builder controls</span>
            </button>
            <button class="template-btn ungovern" onclick="applyTemplate('ungovern')">
                Ungovern
                <span class="template-hint">tap + ragequit</span>
            </button>
        </div>

        <div class="summary-sentence">
            <span class="summary-static">Raise</span>
            <span class="summary-editable edit-raise" id="editRaise" onclick="editSummaryField('raise')">10</span>
            <span class="summary-editable edit-tribute" id="editTribute" onclick="toggleSummaryTribute()">ETH</span>
            <span class="summary-static">selling</span>
            <span class="summary-editable edit-supply" id="editSupply" onclick="editSummaryField('supply')">1,000,000,000</span>
            <span class="summary-editable edit-token-type" id="editTokenType" onclick="toggleSummaryTokenType()">Shares</span><span class="summary-static">.</span>
            <span id="governanceLine">
            <br>
            <span class="summary-editable edit-quorum" id="editQuorum" onclick="editSummaryField('quorum')">10%</span>
            <span class="summary-static">quorum.</span>
            <span class="summary-editable edit-voting" id="editVoting" onclick="editSummaryField('voting')">2</span>
            <span class="summary-static">day voting.</span>
            <span class="summary-editable edit-timelock" id="editTimelock" onclick="editSummaryField('timelock')">1</span>
            <span class="summary-static">day timelock.</span>
            </span>
            <br>
            <span class="summary-static">Tap</span>
            <span class="summary-editable edit-tap-pct" id="editTapPct" onclick="editTapPctField()">100%</span>
            <span class="summary-static" id="tapOverText">over</span>
            <span class="summary-editable edit-tap-months" id="editTapMonths" onclick="editSummaryField('tapMonths')">6</span>
            <span class="summary-static" id="tapMonthsText">months</span>
            <span class="summary-editable edit-tap-toggle" id="editTapToggle" onclick="toggleSummaryTap()" style="opacity: 0.5; font-size: 0.8em;">(disable)</span>
        </div>

        <div id="summaryPricePreview" class="summary-price-preview"></div>
        <div id="summaryTapPreview" class="summary-tap-preview"></div>
        <div id="summaryTemplateNote" class="summary-template-note buterin">
            All holders vote. Tap releases funds automatically to ops.
        </div>

        <div class="summary-name-section">
            <span>Call it</span>
            <input type="text" id="summaryName" class="summary-name-input name-field" placeholder="Name">
            <span>(</span><input type="text" id="summarySymbol" class="summary-name-input symbol-field" placeholder="SYM" maxlength="10"><span>)</span>
        </div>
        <div class="summary-description-wrapper">
            <textarea id="summaryDescription" class="summary-description" placeholder="vision..." rows="1"></textarea>
            <div class="summary-duna-hint">defaults to <a href="https://github.com/z0r0z/majeur?tab=readme-ov-file#wyoming-duna-compliance" target="_blank" rel="noopener">DUNA</a></div>
        </div>

        <div class="summary-launch-container">
            <button id="summaryLaunchBtn" class="summary-launch-btn" onclick="launchFromSummary()">Launch</button>
            <div id="summaryStatus" style="color: var(--cyan); font-style: normal; text-align: center;"></div>
            <div class="summary-advanced-link" onclick="openWizard()">Advanced</div>
        </div>
    </section>

    <!-- ACTIVE DAICOS SECTION -->
    <section class="section-active-daicos" id="active-daicos-section">
        <div class="active-daicos-header">
            <div class="active-daicos-title">Sales</div>
            <button class="refresh-btn" onclick="daicoScanTriggered = false; triggerDAICOScan();"></button>
        </div>
        <div class="sale-tabs">
            <button id="activeTab" class="sale-tab active" onclick="showSaleTab('active')">Active<span id="activeCount" class="tab-count"></span></button>
            <button id="completedTab" class="sale-tab" onclick="showSaleTab('completed')">Completed<span id="completedCount" class="tab-count"></span></button>
        </div>
        <div id="activeDaicosList" class="active-daicos-grid">
            <div class="daico-loading">Scroll to load DAICOs...</div>
        </div>
    </section>

    <!-- PURCHASE MODAL -->
    <div id="purchaseModal" class="wizard-overlay">
        <div class="purchase-container">
            <div class="purchase-header">
                <div class="purchase-title" id="purchaseDaoName">Buy Tokens</div>
                <div id="purchaseTemplateBadge" class="daico-template-badge" style="display: none; position: static; margin-left: 0.5rem;"></div>
                <button class="wizard-close" onclick="closePurchaseModal()">&times;</button>
            </div>

            <!-- DAO Description (from contractURI) -->
            <div id="purchaseDescription" class="purchase-description" style="display: none;"></div>

            <div id="purchaseStatus" class="status-message"></div>

            <!-- Sale Info -->
            <div class="purchase-info">
                <div class="purchase-info-row">
                    <span>Remaining Supply</span>
                    <span id="purchaseRemaining">--</span>
                </div>
                <div class="purchase-info-row">
                    <span>Time Left</span>
                    <span id="purchaseDeadline">--</span>
                </div>
                <div class="purchase-info-row">
                    <span>Price</span>
                    <span id="purchasePrice">--</span>
                </div>

                <!-- Progress Bar -->
                <div class="purchase-progress-section">
                    <div class="purchase-progress" id="purchaseProgress">
                        <div class="purchase-progress-bar" id="purchaseProgressBar" style="width: 0%"></div>
                        <div class="purchase-progress-text" id="purchaseProgressText">0% sold</div>
                    </div>
                    <div class="purchase-progress-labels">
                        <span class="progress-sold" id="purchaseProgressSold">0 sold</span>
                        <span class="progress-remaining" id="purchaseProgressRemaining">0 remaining</span>
                    </div>
                </div>
            </div>

            <!-- Swap Interface -->
            <div class="swap-container">
                <!-- Pay Input -->
                <div class="swap-box swap-pay">
                    <div class="swap-label">You Pay</div>
                    <div class="swap-input-row">
                        <input type="text" id="payAmountInput" class="swap-input" placeholder="0.0" oninput="handlePayInput()">
                        <div class="swap-token" id="payTokenDisplay">
                            <div class="swap-token-icon" id="payTokenIcon"></div>
                            <span id="payTokenSymbol">ETH</span>
                        </div>
                    </div>
                    <div class="swap-balance">
                        Balance: <span id="payBalance">--</span>
                        <button class="max-btn" onclick="setMaxPay()">MAX</button>
                    </div>
                </div>

                <!-- Swap Arrow -->
                <div class="swap-arrow"></div>

                <!-- Receive Input -->
                <div class="swap-box swap-receive">
                    <div class="swap-label">You Receive</div>
                    <div class="swap-input-row">
                        <input type="text" id="receiveAmountInput" class="swap-input" placeholder="0.0" oninput="handleReceiveInput()">
                        <div class="swap-token" id="receiveTokenDisplay">
                            <div class="swap-token-icon" id="receiveTokenIcon"></div>
                            <span id="receiveTokenSymbol">SHARES</span>
                        </div>
                    </div>
                    <div class="swap-balance">
                        Available: <span id="receiveAvailable">--</span>
                    </div>
                </div>
            </div>

            <!-- Slippage -->
            <div class="slippage-row">
                <span>Slippage Tolerance</span>
                <div class="slippage-options">
                    <button class="slippage-btn active" onclick="setSlippage(0.5, this)">0.5%</button>
                    <button class="slippage-btn" onclick="setSlippage(1, this)">1%</button>
                    <button class="slippage-btn" onclick="setSlippage(2, this)">2%</button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div id="purchaseActions">
                <button id="approveBtn" class="purchase-btn approve-btn" style="display: none;" onclick="approveToken()">
                    Approve <span id="approveTokenName">TOKEN</span>
                </button>
                <button id="buyBtn" class="purchase-btn buy-btn" onclick="executePurchase()">
                    Connect Wallet
                </button>
            </div>

            <!-- Tap Section (if enabled) -->
            <div id="tapSection" class="tap-section" style="display: none;">
                <div class="tap-header">
                    <span>Team Funding (TAP)</span>
                    <span id="tapClaimable" class="tap-amount">0 ETH</span>
                </div>
                <div id="tapOpsRow" class="tap-ops-row" style="font-size: 0.85rem; margin-top: 0.5rem; margin-bottom: 1.25rem; color: rgba(255, 255, 255, 0.7);">
                    Operator: <span id="tapOpsDisplay" style="font-family: 'Roboto Mono', monospace; color: var(--orange);"></span>
                </div>
                <button id="claimTapBtn" class="tap-claim-btn" onclick="claimTap()">Claim TAP</button>
            </div>

            <!-- Link to Majeur -->
            <div class="purchase-footer">
                <a id="majeurLink" href="#" target="_blank" rel="noopener" class="majeur-link">View full DAO on Majeur </a>
            </div>
        </div>
    </div>

    <!-- SIMPLE WIZARD MODAL -->
    <div id="wizardModal" class="wizard-overlay">
        <div class="wizard-container">
            <div class="wizard-header">
                <div class="wizard-title">Launch DAICO</div>
                <div style="display: flex; align-items: center; gap: 1.5rem;">
                    <span class="wizard-advanced" onclick="openAdvancedModal()">Advanced</span>
                    <button class="wizard-close" onclick="closeWizard()">&times;</button>
                </div>
            </div>

            <div id="wizardStatus" class="status-message"></div>

            <!-- STEP 1: Choose Token Type -->
            <div id="wizardStep1" class="wizard-step active">
                <div class="wizard-step-title">What are you selling?</div>
                <div class="wizard-choice">
                    <button class="wizard-choice-btn shares" onclick="selectTokenType('shares')">
                        Shares
                        <div class="wizard-choice-desc">Voting tokens. All sold to contributors.</div>
                    </button>
                    <button class="wizard-choice-btn loot" onclick="selectTokenType('loot')">
                        Loot
                        <div class="wizard-choice-desc">Non-voting. No governance. Ragequittable.</div>
                    </button>
                </div>
            </div>

            <!-- STEP 2: Basic Info -->
            <div id="wizardStep2" class="wizard-step">
                <div class="wizard-step-title">Name your DAO</div>
                <div class="wizard-input-group">
                    <label class="wizard-label">Name</label>
                    <input type="text" id="wizardName" class="wizard-input" placeholder="My Project">
                </div>
                <div class="wizard-input-group">
                    <label class="wizard-label">Symbol</label>
                    <input type="text" id="wizardSymbol" class="wizard-input" placeholder="MPD" maxlength="10">
                </div>
                <div class="wizard-input-group" style="margin-top: 0.5rem;">
                    <label class="wizard-label" style="opacity: 0.6;">Description <span style="font-weight: normal; font-size: 0.75rem;">(optional)</span></label>
                    <textarea id="wizardDescription" class="wizard-input" placeholder="Brief description of your project..." style="resize: vertical; min-height: 50px; max-height: 120px; font-family: inherit;"></textarea>
                    <small style="color: rgba(255, 255, 255, 0.35); font-size: 0.7rem; margin-top: 0.25rem; display: block;">defaults to <a href="https://github.com/z0r0z/majeur?tab=readme-ov-file#wyoming-duna-compliance" target="_blank" rel="noopener" style="color: var(--cyan); opacity: 0.7;">DUNA</a></small>
                </div>
                <div class="wizard-nav">
                    <button class="wizard-btn back" onclick="wizardBack()">Back</button>
                    <button class="wizard-btn next" onclick="wizardNext()">Next</button>
                </div>
            </div>

            <!-- STEP 3: Raise Amount -->
            <div id="wizardStep3" class="wizard-step">
                <div class="wizard-step-title">How much do you want to raise?</div>
                <div class="wizard-raise-grid">
                    <button class="wizard-raise-btn" onclick="selectRaiseAmount(1)">
                        <div class="wizard-raise-amount">1 ETH</div>
                        <div class="wizard-raise-price">0.001 ETH / 1M tokens</div>
                    </button>
                    <button class="wizard-raise-btn" onclick="selectRaiseAmount(10)">
                        <div class="wizard-raise-amount">10 ETH</div>
                        <div class="wizard-raise-price">0.01 ETH / 1M tokens</div>
                    </button>
                    <button class="wizard-raise-btn" onclick="selectRaiseAmount(100)">
                        <div class="wizard-raise-amount">100 ETH</div>
                        <div class="wizard-raise-price">0.1 ETH / 1M tokens</div>
                    </button>
                    <button class="wizard-raise-btn custom" onclick="showCustomRaise()">
                        <div class="wizard-raise-amount">Custom</div>
                        <div class="wizard-raise-price">Set your own target</div>
                    </button>
                </div>
                <div id="wizardCustomRaise" class="wizard-input-group" style="display: none; margin-top: 1.5rem;">
                    <label class="wizard-label">Target Raise (ETH)</label>
                    <input type="text" id="wizardCustomRaiseInput" class="wizard-input" placeholder="50">
                    <div id="wizardCustomPrice" style="text-align: center; margin-top: 0.5rem; color: var(--cyan); font-style: normal;"></div>
                    <div class="wizard-nav" style="margin-top: 1rem;">
                        <button class="wizard-btn back" onclick="hideCustomRaise()">Back</button>
                        <button class="wizard-btn next" onclick="confirmCustomRaise()">Confirm</button>
                    </div>
                </div>
                <div id="wizardRaiseNav" class="wizard-nav">
                    <button class="wizard-btn back" onclick="wizardBack()">Back</button>
                </div>
            </div>

            <!-- STEP 4: Enable Tap -->
            <div id="wizardStep4" class="wizard-step">
                <div class="wizard-step-title">Enable the TAP?</div>
                <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 1.5rem; font-style: normal;">
                    Release funds gradually to an ops address. DAO can adjust anytime via governance.
                </p>
                <div class="wizard-choice">
                    <button class="wizard-choice-btn tap-yes" onclick="showTapConfig()">
                        Yes
                        <div class="wizard-choice-desc">Controlled fund release to ops.</div>
                    </button>
                    <button class="wizard-choice-btn tap-no" onclick="selectTap(false)">
                        No
                        <div class="wizard-choice-desc">Funds stay in treasury.</div>
                    </button>
                </div>
                <div id="wizardTapConfig" style="display: none; margin-top: 1.5rem;">
                    <!-- Ops Address (clickable to edit) -->
                    <div class="wizard-input-group" style="margin-bottom: 1.5rem;">
                        <label class="wizard-label">Ops Address</label>
                        <div id="wizardTapOpsDisplay" class="tap-ops-display" onclick="toggleTapOpsEdit()" style="cursor: pointer; padding: 0.75rem 1rem; background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.3); font-family: 'Roboto Mono', monospace; font-size: 0.9rem; text-align: center;">
                            <span id="wizardTapOpsAddr" style="color: var(--cyan);"></span>
                            <span style="opacity: 0.5; margin-left: 0.5rem; font-size: 0.8rem;">click to change</span>
                        </div>
                        <div id="wizardTapOpsEdit" style="display: none;">
                            <input type="text" id="wizardTapOps" class="wizard-input" placeholder="0x... or ENS name" style="margin-top: 0.5rem;">
                            <div id="wizardTapOpsResolved" style="text-align: center; margin-top: 0.5rem; font-size: 0.8rem; font-style: normal; color: var(--cyan);"></div>
                        </div>
                    </div>

                    <!-- Tap Percentage -->
                    <div class="wizard-input-group" style="margin-bottom: 1.5rem;">
                        <label class="wizard-label">Percentage of Raise</label>
                        <div class="tap-preset-btns" style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                            <button class="tap-preset-btn" onclick="setTapPct(25, this)">25%</button>
                            <button class="tap-preset-btn" onclick="setTapPct(50, this)">50%</button>
                            <button class="tap-preset-btn active" onclick="setTapPct(100, this)">100%</button>
                        </div>
                        <div id="wizardTapPctSummary" style="text-align: center; margin-top: 0.75rem; font-size: 0.9rem; color: rgba(255,255,255,0.7);"></div>
                    </div>

                    <!-- Tap Duration -->
                    <div class="wizard-input-group" style="margin-bottom: 1.5rem;">
                        <label class="wizard-label">Release Duration</label>
                        <div class="tap-preset-btns" style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                            <button class="tap-duration-btn" onclick="setTapDuration(3, this)">3 mo</button>
                            <button class="tap-duration-btn active" onclick="setTapDuration(6, this)">6 mo</button>
                            <button class="tap-duration-btn" onclick="setTapDuration(12, this)">12 mo</button>
                        </div>
                    </div>

                    <!-- Tap Effect Summary -->
                    <div id="wizardTapEffect" style="text-align: center; padding: 1rem; background: rgba(0,255,0,0.05); border: 1px solid rgba(0,255,0,0.2); margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.6;"></div>

                    <div class="wizard-nav">
                        <button class="wizard-btn back" onclick="hideTapConfig()">Back</button>
                        <button class="wizard-btn next" onclick="confirmTapConfig()">Confirm</button>
                    </div>
                </div>
            </div>

            <!-- STEP 5: LP Seeding -->
            <div id="wizardStep5LP" class="wizard-step">
                <div class="wizard-step-title">Seed Liquidity?</div>
                <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 1.5rem; font-style: normal;">
                    Route a portion of sale proceeds to a ZAMM liquidity pool.
                </p>
                <div class="wizard-choice">
                    <button class="wizard-choice-btn lp-yes" onclick="showLPConfig()">
                        <img src="https://content.wrappr.wtf/ipfs/bafybeibuct6mftnmgzkbn4tq47elpokbkahkjxq7z6qceptlcsvpxletou" alt="ZAMM" style="width: 48px; height: 48px; margin-bottom: 0.5rem;">
                        <div style="font-size: 1.2rem;">Yes</div>
                        <div class="wizard-choice-desc">Auto-create trading pair on ZAMM.</div>
                    </button>
                    <button class="wizard-choice-btn lp-no" onclick="selectLP(false)">
                        No
                        <div class="wizard-choice-desc">No liquidity pool.</div>
                    </button>
                </div>
                <div id="wizardLPConfig" style="display: none; margin-top: 1.5rem;">
                    <div class="wizard-input-group">
                        <label class="wizard-label">LP Percentage of Sale</label>
                        <div class="wizard-lp-slider">
                            <input type="range" id="wizardLPPct" class="wizard-slider" min="5" max="50" value="10" oninput="updateLPPreview()">
                            <div id="wizardLPValue" class="wizard-slider-value">10%</div>
                        </div>
                        <div id="wizardLPPreview" style="text-align: center; margin-top: 0.75rem; font-size: 0.9rem; color: rgba(255,255,255,0.6); font-style: normal;"></div>
                    </div>
                    <div class="wizard-nav">
                        <button class="wizard-btn back" onclick="hideLPConfig()">Back</button>
                        <button class="wizard-btn next" onclick="confirmLPConfig()">Confirm</button>
                    </div>
                </div>
            </div>

            <!-- STEP 6: Loot - Add Founders -->
            <div id="wizardStep6Founders" class="wizard-step">
                <div class="wizard-step-title">Add Founding Members</div>
                <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 1.5rem; font-style: normal;">
                    These addresses receive voting shares. Loot sale is non-voting.
                </p>
                <div id="wizardFounders" class="wizard-founders">
                    <div class="wizard-founder-row">
                        <input type="text" class="wizard-founder-input founder-address" placeholder="0x... (your address)">
                        <input type="text" class="wizard-founder-input founder-shares" placeholder="Shares">
                        <button class="wizard-founder-remove" onclick="removeFounder(this)" style="visibility: hidden;">&times;</button>
                    </div>
                </div>
                <button class="wizard-add-founder" onclick="addFounder()">+ Add Founder</button>
                <div class="wizard-nav">
                    <button class="wizard-btn back" onclick="wizardBack()">Back</button>
                    <button class="wizard-btn next" onclick="wizardNext()">Next</button>
                </div>
            </div>

            <!-- STEP 6: Confirm & Launch -->
            <div id="wizardStepConfirm" class="wizard-step">
                <div class="wizard-step-title">Confirm & Launch</div>
                <div class="wizard-summary">
                    <div class="wizard-summary-row">
                        <span class="wizard-summary-label">DAO Name</span>
                        <span id="wizardSummaryName" class="wizard-summary-value">--</span>
                    </div>
                    <div class="wizard-summary-row">
                        <span class="wizard-summary-label">Token Type</span>
                        <span id="wizardSummaryType" class="wizard-summary-value">--</span>
                    </div>
                    <div class="wizard-summary-row">
                        <span class="wizard-summary-label">Sale Supply</span>
                        <span class="wizard-summary-value">1,000,000,000</span>
                    </div>
                    <div class="wizard-summary-row">
                        <span class="wizard-summary-label">Target Raise</span>
                        <span id="wizardSummaryRaise" class="wizard-summary-value highlight">--</span>
                    </div>
                    <div class="wizard-summary-row">
                        <span class="wizard-summary-label">Price</span>
                        <span id="wizardSummaryPrice" class="wizard-summary-value highlight" style="text-align: right; line-height: 1.4;">--</span>
                    </div>
                    <div id="wizardSummaryFoundersRow" class="wizard-summary-row" style="display: none;">
                        <span class="wizard-summary-label">Founder Shares</span>
                        <span id="wizardSummaryFounders" class="wizard-summary-value">--</span>
                    </div>
                    <div class="wizard-summary-row">
                        <span class="wizard-summary-label">TAP</span>
                        <span id="wizardSummaryTap" class="wizard-summary-value">--</span>
                    </div>
                    <div class="wizard-summary-row">
                        <span class="wizard-summary-label">Liquidity</span>
                        <span id="wizardSummaryLP" class="wizard-summary-value">--</span>
                    </div>
                    <div class="wizard-summary-row">
                        <span class="wizard-summary-label">Quorum</span>
                        <span class="wizard-summary-value">10%</span>
                    </div>
                    <div class="wizard-summary-row">
                        <span class="wizard-summary-label">Voting Period</span>
                        <span class="wizard-summary-value">2 days</span>
                    </div>
                    <div class="wizard-summary-row">
                        <span class="wizard-summary-label">Timelock</span>
                        <span class="wizard-summary-value">1 day</span>
                    </div>
                </div>
                <!-- Trust Mode notice for ungovernable DAICO -->
                <div id="wizardTrustModeNotice" class="wizard-trust-notice" style="display: none;">
                    <div class="wizard-trust-title">Trust Mode</div>
                    <div class="wizard-trust-desc">
                        No voting shareholders  loot holders trust the tap operator.
                        Contributors can ragequit anytime for a pro-rata treasury refund.
                    </div>
                </div>
                <div class="wizard-nav">
                    <button class="wizard-btn back" onclick="wizardBack()">Back</button>
                    <button id="wizardLaunchBtn" class="wizard-btn launch" onclick="launchSimpleDAICO()">Launch</button>
                </div>
            </div>

            <!-- SUCCESS -->
            <div id="wizardSuccess" class="wizard-step">
                <div class="wizard-success">
                    <div class="wizard-success-title">DAICO Launched</div>
                    <p style="color: rgba(255,255,255,0.6); font-style: normal;">Your DAO is live with an active token sale.</p>
                    <div id="wizardSuccessAddress" class="wizard-success-address"></div>
                    <a id="wizardSuccessLink" href="#" target="_blank" rel="noopener" class="wizard-success-link">View Your DAO</a>
                </div>
            </div>
        </div>
    </div>

    <!-- WALLET SELECTION MODAL -->
    <div id="walletModal" class="wallet-modal">
        <div class="wallet-modal-content">
            <div class="wallet-modal-title">Connect Wallet</div>
            <div id="walletOptions"></div>
            <button onclick="closeWalletModal()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: transparent; border: 2px solid rgba(0, 255, 255, 0.3); color: rgba(255, 255, 255, 0.6); font-family: 'Oswald', sans-serif; font-size: 0.9rem; cursor: pointer; text-transform: uppercase;">Cancel</button>
        </div>
    </div>

    <!-- LAUNCH MODAL -->
    <div id="launchModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">Launch DAICO</div>
                <button class="modal-close" onclick="closeLaunchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="statusMessage" class="status-message"></div>

                <!-- SUCCESS PANEL (hidden by default) -->
                <div id="successPanel" class="success-panel" style="display: none;">
                    <div class="success-icon"></div>
                    <div class="success-title">DAICO Launched!</div>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem; font-style: normal;">Your DAO has been created with an active token sale.</p>
                    <div id="successAddress" class="success-address"></div>
                    <a id="successLink" href="#" target="_blank" rel="noopener" class="success-dao-link">View Your DAO</a>
                </div>

                <!-- FORM (shown by default) -->
                <div id="launchForm">
                    <!-- VISUALIZATION PANEL -->
                    <div class="viz-panel">
                        <div class="viz-title">Sale Preview</div>
                        <div class="viz-row">
                            <span class="viz-label">Token Name</span>
                            <span id="vizName" class="viz-value">--</span>
                        </div>
                        <div class="viz-row">
                            <span class="viz-label">Sale Supply</span>
                            <span id="vizSupply" class="viz-value">--</span>
                        </div>
                        <div class="viz-row">
                            <span class="viz-label">Price</span>
                            <span id="vizPrice" class="viz-value highlight">--</span>
                        </div>
                        <div class="viz-row">
                            <span class="viz-label">Total Raise (if sold out)</span>
                            <span id="vizRaise" class="viz-value highlight">--</span>
                        </div>
                        <div id="vizLPRow" class="viz-row" style="display: none;">
                            <span class="viz-label">LP Allocation</span>
                            <span id="vizLP" class="viz-value">--</span>
                        </div>
                        <div id="vizTapRow" class="viz-row" style="display: none;">
                            <span class="viz-label">Tap Rate</span>
                            <span id="vizTap" class="viz-value">--</span>
                        </div>
                        <div class="viz-bar" id="vizBar">
                            <div class="viz-bar-segment" id="vizBarSale" style="background: var(--green); width: 100%;"></div>
                            <div class="viz-bar-segment" id="vizBarLP" style="background: var(--blue); width: 0%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-top: 0.5rem; color: rgba(255,255,255,0.5); font-style: normal;">
                            <span><span style="color: var(--green);"></span> To Treasury</span>
                            <span id="vizLPLabel" style="display: none;"><span style="color: var(--blue);"></span> To Liquidity</span>
                        </div>
                    </div>

                    <!-- DAO INFO -->
                    <div class="form-section">
                        <div class="form-section-title">DAO Identity</div>
                        <div class="form-group">
                            <label class="form-label">Name
                                <span class="hint">Your project or organization name</span>
                            </label>
                            <input type="text" id="daoName" class="form-input" placeholder="My Project DAO" oninput="updateVisualization()">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Symbol
                                    <span class="hint">Token ticker (e.g., MPD)</span>
                                </label>
                                <input type="text" id="daoSymbol" class="form-input" placeholder="MPD" maxlength="10" oninput="updateVisualization()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quorum %
                                    <span class="hint">Votes needed to pass (default: 20%)</span>
                                </label>
                                <input type="number" id="quorumPct" class="form-input" placeholder="20" min="1" max="100" value="20">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="opacity: 0.7;">Description
                                <span class="hint">Optional - stored as on-chain metadata</span>
                            </label>
                            <textarea id="daoDescription" class="form-input" placeholder="Brief description of your project..." style="resize: vertical; min-height: 50px; max-height: 100px; font-family: inherit;"></textarea>
                            <small style="color: rgba(255, 255, 255, 0.35); font-size: 0.7rem; margin-top: 0.25rem; display: block;">defaults to <a href="https://github.com/z0r0z/majeur?tab=readme-ov-file#wyoming-duna-compliance" target="_blank" rel="noopener" style="color: var(--cyan); opacity: 0.7;">DUNA</a> charter</small>
                        </div>
                    </div>

                    <!-- SALE CONFIG -->
                    <div class="form-section">
                        <div class="form-section-title">Token Sale</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Sale Supply
                                    <span class="hint">Tokens available for purchase</span>
                                </label>
                                <input type="text" id="saleSupply" class="form-input" placeholder="1,000,000" oninput="formatNumberInput(this); updateVisualization()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Token
                                    <span class="hint">What buyers pay with</span>
                                </label>
                                <select id="paymentToken" class="form-select" onchange="updateVisualization()">
                                    <option value="eth">ETH</option>
                                    <option value="custom">Custom ERC20</option>
                                </select>
                            </div>
                        </div>
                        <div id="customTokenGroup" class="form-group" style="display: none;">
                            <label class="form-label">Custom Token Address</label>
                            <input type="text" id="customTokenAddress" class="form-input" placeholder="0x...">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Price (ETH per token)
                                    <span class="hint">How much 1 token costs</span>
                                </label>
                                <input type="text" id="tokenPrice" class="form-input" placeholder="0.0001" oninput="updateVisualization()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Token Type
                                    <span class="hint">Shares = voting, Loot = non-voting</span>
                                </label>
                                <select id="tokenType" class="form-select">
                                    <option value="shares">Shares (Voting)</option>
                                    <option value="loot">Loot (Non-Voting)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- LP CONFIG (OPTIONAL) -->
                    <div class="toggle-section">
                        <div class="toggle-header">
                            <input type="checkbox" id="enableLP" onchange="toggleLPConfig()">
                            <label for="enableLP">Enable Liquidity Bootstrapping</label>
                        </div>
                        <div id="lpConfig" class="toggle-content">
                            <p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 1rem; font-style: normal;">
                                Automatically route a portion of proceeds to a ZAMM liquidity pool. Buyers receive proportionally fewer tokens.
                            </p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">LP Percentage
                                        <span class="hint">% of tribute to liquidity (1-99)</span>
                                    </label>
                                    <input type="number" id="lpPct" class="form-input" placeholder="50" min="1" max="99" value="50" oninput="updateVisualization()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Pool Fee (bps)
                                        <span class="hint">ZAMM trading fee (default: 30 = 0.3%)</span>
                                    </label>
                                    <input type="number" id="poolFee" class="form-input" placeholder="30" value="30">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAP CONFIG (OPTIONAL) -->
                    <div class="toggle-section">
                        <div class="toggle-header">
                            <input type="checkbox" id="enableTap" onchange="toggleTapConfig()">
                            <label for="enableTap">Enable Tap (Controlled Fund Release)</label>
                        </div>
                        <div id="tapConfig" class="toggle-content">
                            <p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 1rem; font-style: normal;">
                                Release funds gradually to an ops address. The DAO can vote to adjust or halt the tap at any time.
                            </p>
                            <div class="form-group">
                                <label class="form-label">Ops Address
                                    <span class="hint">Where tap funds are sent (your wallet or multisig)</span>
                                </label>
                                <input type="text" id="tapOps" class="form-input" placeholder="0x... (leave empty to use your address)">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Tap Rate (per month)
                                        <span class="hint">ETH released per month</span>
                                    </label>
                                    <input type="text" id="tapRate" class="form-input" placeholder="1.0" oninput="updateVisualization()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tap Budget (ETH)
                                        <span class="hint">Total approved for tap (0 = unlimited)</span>
                                    </label>
                                    <input type="text" id="tapBudget" class="form-input" placeholder="100">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FOUNDER ALLOCATION -->
                    <div class="form-section">
                        <div class="form-section-title">Founder Allocation (Optional)</div>
                        <p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 1rem; font-style: normal;">
                            Optionally mint shares to yourself as a founder. These are separate from the sale supply.
                        </p>
                        <div class="form-group">
                            <label class="form-label">Your Shares
                                <span class="hint">Shares minted to your wallet (0 = none)</span>
                            </label>
                            <input type="text" id="founderShares" class="form-input" placeholder="0" oninput="formatNumberInput(this)">
                        </div>
                    </div>

                    <!-- ADVANCED OPTIONS -->
                    <div class="toggle-section">
                        <div class="toggle-header">
                            <input type="checkbox" id="showAdvanced" onchange="toggleAdvanced()">
                            <label for="showAdvanced">Advanced Options</label>
                        </div>
                        <div id="advancedConfig" class="toggle-content">
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="ragequittable" checked>
                                    <span>Enable Ragequit (members can exit with treasury share)</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="sharesLocked">
                                    <span>Lock Shares (non-transferable)</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="lootLocked">
                                    <span>Lock Loot (non-transferable)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button id="submitBtn" class="submit-btn" onclick="launchDAICO()">Launch DAICO</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Network configuration
        const NETWORKS = {
            ethereum: {
                chainId: 1n,
                chainIdHex: '0x1',
                name: 'Ethereum',
                shortName: 'ETH',
                rpcs: [
                    'https://1rpc.io/eth',
                    'https://eth.drpc.org',
                    'https://ethereum.publicnode.com',
                    'https://rpc.payload.de',
                    'https://eth.merkle.io',
                    'https://eth.llamarpc.com'
                ],
                explorer: 'https://etherscan.io',
                swissKnifeChainId: 1,
                treasuryTokens: [
                    ethers.ZeroAddress, // ETH
                    '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', // USDC
                    '0xdAC17F958D2ee523a2206206994597C13D831ec7', // USDT
                    '0x6B175474E89094C44Da98b954EedeAC495271d0F', // DAI
                    '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0', // wstETH
                    '0xae78736Cd615f374D3085123A210448E74Fc6393'  // rETH
                ],
                tokenMeta: {
                    [ethers.ZeroAddress]: { symbol: 'ETH', decimals: 18 },
                    '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48': { symbol: 'USDC', decimals: 6 },
                    '0xdAC17F958D2ee523a2206206994597C13D831ec7': { symbol: 'USDT', decimals: 6 },
                    '0x6B175474E89094C44Da98b954EedeAC495271d0F': { symbol: 'DAI', decimals: 18 },
                    '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0': { symbol: 'wstETH', decimals: 18 },
                    '0xae78736Cd615f374D3085123A210448E74Fc6393': { symbol: 'rETH', decimals: 18 }
                }
            },
            base: {
                chainId: 8453n,
                chainIdHex: '0x2105',
                name: 'Base',
                shortName: 'BASE',
                rpcs: [
                    'https://mainnet.base.org',
                    'https://base.publicnode.com',
                    'https://1rpc.io/base',
                    'https://base.drpc.org',
                    'https://base.meowrpc.com',
                    'https://base.llamarpc.com'
                ],
                explorer: 'https://basescan.org',
                swissKnifeChainId: 8453,
                treasuryTokens: [
                    ethers.ZeroAddress, // ETH
                    '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913', // USDC
                    '0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2', // USDT (bridged)
                    '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb', // DAI
                    '0xc1CBa3fCea344f92D9239c08C0568f6F2F0ee452', // wstETH
                    '0xB6fe221Fe9EeF5aBa221c348bA20A1Bf5e73624c'  // rETH
                ],
                tokenMeta: {
                    [ethers.ZeroAddress]: { symbol: 'ETH', decimals: 18 },
                    '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913': { symbol: 'USDC', decimals: 6 },
                    '0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2': { symbol: 'USDT', decimals: 6 },
                    '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb': { symbol: 'DAI', decimals: 18 },
                    '0xc1CBa3fCea344f92D9239c08C0568f6F2F0ee452': { symbol: 'wstETH', decimals: 18 },
                    '0xB6fe221Fe9EeF5aBa221c348bA20A1Bf5e73624c': { symbol: 'rETH', decimals: 18 }
                }
            },
            sepolia: {
                chainId: 11155111n,
                chainIdHex: '0xaa36a7',
                name: 'Sepolia',
                shortName: 'SEP',
                rpcs: [
                    'https://ethereum-sepolia.publicnode.com',
                    'https://1rpc.io/sepolia',
                    'https://sepolia.drpc.org',
                    'https://rpc.sepolia.org',
                    'https://rpc2.sepolia.org'
                ],
                explorer: 'https://sepolia.etherscan.io',
                swissKnifeChainId: 11155111,
                treasuryTokens: [
                    ethers.ZeroAddress // ETH only for testnet
                ],
                tokenMeta: {
                    [ethers.ZeroAddress]: { symbol: 'ETH', decimals: 18 }
                }
            },
            arbitrum: {
                chainId: 42161n,
                chainIdHex: '0xa4b1',
                name: 'Arbitrum',
                shortName: 'ARB',
                rpcs: [
                    'https://arb1.arbitrum.io/rpc',
                    'https://arbitrum.publicnode.com',
                    'https://1rpc.io/arb',
                    'https://arbitrum.drpc.org',
                    'https://arbitrum.meowrpc.com',
                    'https://arbitrum.llamarpc.com'
                ],
                explorer: 'https://arbiscan.io',
                swissKnifeChainId: 42161,
                treasuryTokens: [
                    ethers.ZeroAddress, // ETH
                    '0xaf88d065e77c8cC2239327C5EDb3A432268e5831', // USDC (native)
                    '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9', // USDT
                    '0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1', // DAI
                    '0x5979D7b546E38E414F7E9822514be443A4800529', // wstETH
                    '0xEC70Dcb4A1EFa46b8F2D97C310C9c4790ba5ffA8'  // rETH
                ],
                tokenMeta: {
                    [ethers.ZeroAddress]: { symbol: 'ETH', decimals: 18 },
                    '0xaf88d065e77c8cC2239327C5EDb3A432268e5831': { symbol: 'USDC', decimals: 6 },
                    '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9': { symbol: 'USDT', decimals: 6 },
                    '0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1': { symbol: 'DAI', decimals: 18 },
                    '0x5979D7b546E38E414F7E9822514be443A4800529': { symbol: 'wstETH', decimals: 18 },
                    '0xEC70Dcb4A1EFa46b8F2D97C310C9c4790ba5ffA8': { symbol: 'rETH', decimals: 18 }
                }
            }
        };

        // Current network (persisted in localStorage)
        let currentNetwork = localStorage.getItem('daico_network') || 'ethereum';
        // Migrate old setting
        if (currentNetwork === 'mainnet') {
            currentNetwork = 'ethereum';
            localStorage.setItem('daico_network', 'ethereum');
        }

        function getNetwork() {
            return NETWORKS[currentNetwork];
        }

        function getNetworkByChainId(chainId) {
            const chainIdBigInt = typeof chainId === 'bigint' ? chainId : BigInt(chainId);
            for (const [key, network] of Object.entries(NETWORKS)) {
                if (network.chainId === chainIdBigInt) {
                    return { key, network };
                }
            }
            return null;
        }

        function isOnSupportedNetwork(chainId) {
            return getNetworkByChainId(chainId) !== null;
        }

        // Contract addresses (same on all supported networks)
        const DAICO_ADDRESS = '0x000000000033e92DB97B4B3beCD2c255126C60aC';
        const SUMMONER_ADDRESS = '0x0000000000330B8df9E3bc5E553074DA58eE9138';
        const DEFAULT_RENDERER = '0x000000000011c799980827f52d3137b4abd6e654';
        const MULTICALL3_ADDRESS = '0xcA11bde05977b3631167028862bE2a173976CA11';
        const MOLOCH_VIEW_HELPER = '0x00000000006631040967E58e3430e4B77921a2db';

        // Implementation addresses per network (L2s have different addresses due to EVM differences)
        const IMPLEMENTATIONS = {
            ethereum: {
                moloch: '0x643A45B599D81be3f3A68F37EB3De55fF10673C1',
                shares: '0x71E9b38d301b5A58cb998C1295045FE276Acf600',
                loot: '0x6f1f2aF76a3aDD953277e9F369242697C87bc6A5'
            },
            base: {
                moloch: '0x0c969b771afded8e7c1bec050b2472b1f00a033d',
                shares: '0x36aeeb011e66ddb191d18124c8096b8c35451b77',
                loot: '0x44fe15d5d2913e654c699e08c7bbbd65faf529cc'
            },
            sepolia: {
                moloch: '0x643A45B599D81be3f3A68F37EB3De55fF10673C1',
                shares: '0x71E9b38d301b5A58cb998C1295045FE276Acf600',
                loot: '0x6f1f2aF76a3aDD953277e9F369242697C87bc6A5'
            },
            arbitrum: {
                moloch: '0x0c969b771afded8e7c1bec050b2472b1f00a033d',
                shares: '0x36aeeb011e66ddb191d18124c8096b8c35451b77',
                loot: '0x44fe15d5d2913e654c699e08c7bbbd65faf529cc'
            }
        };

        // Get implementation addresses for current network
        function getImplementations() {
            return IMPLEMENTATIONS[currentNetwork] || IMPLEMENTATIONS.ethereum;
        }

        // Prompt user to switch networks when following a deep link
        async function promptNetworkSwitch(networkKey, targetNetwork, dao, tribTkn) {
            const currentNet = getNetwork();
            const msg = `This link is for ${targetNetwork.name}, but you're on ${currentNet.name}. Switch networks?`;

            if (!confirm(msg)) {
                // Clear the hash so user isn't stuck
                clearUrlHash();
                return;
            }

            // Switch the app's network setting
            currentNetwork = networkKey;
            localStorage.setItem('daico_network', networkKey);
            updateNetworkUI();

            // If wallet is connected, prompt to switch wallet network too
            if (connectedWalletProvider && connectedAddress) {
                try {
                    await connectedWalletProvider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: targetNetwork.chainIdHex }]
                    });
                } catch (switchError) {
                    // Chain not added - try to add it (not supported by WalletConnect, but works for injected)
                    if (switchError.code === 4902 && connectedWalletProvider.request) {
                        try {
                            await connectedWalletProvider.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: targetNetwork.chainIdHex,
                                    chainName: targetNetwork.name,
                                    nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: targetNetwork.rpcs,
                                    blockExplorerUrls: [targetNetwork.explorer]
                                }]
                            });
                        } catch (addError) {
                            console.error('Failed to add network:', addError);
                        }
                    }
                }
            }

            // Re-scan DAICOs on the new network
            activeDAICOs = [];
            completedDAICOs = [];
            daicoScanTriggered = false;

            // Re-trigger deep link handling
            setTimeout(() => handleDeepLink(), 100);
        }

        // Dynamic proxy for network-aware token metadata lookup
        const COMMON_TRIB_TOKENS = new Proxy({}, {
            get(target, prop) {
                const network = getNetwork();
                return network.tokenMeta[prop] || null;
            },
            ownKeys() {
                return Object.keys(getNetwork().tokenMeta);
            },
            getOwnPropertyDescriptor(target, prop) {
                const meta = getNetwork().tokenMeta[prop];
                if (meta) {
                    return { configurable: true, enumerable: true, value: meta };
                }
                return undefined;
            }
        });

        // Token icons (SVG)
        const TOKEN_ICONS = {
            eth: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g><polygon fill="#80D8FF" points="7.62,18.83 16.01,30.5 16.01,24.1"/><polygon fill="#42A5F5" points="16.01,30.5 24.38,18.78 16.01,24.1"/><polygon fill="#FFF176" points="16.01,1.5 7.62,16.23 16.01,12.3"/><polygon fill="#FF8A80" points="24.38,16.18 16.01,1.5 16.01,12.3"/><polygon fill="#C1AEE1" points="16.01,21.5 24.38,16.18 16.01,12.3"/><polygon fill="#55FB9B" points="16.01,12.3 7.62,16.23 16.01,21.5"/></g></svg>`,
            usdc: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle fill="#3E73C4" cx="16" cy="16" r="16"/><path fill="#FFF" d="M20.022 18.124c0-2.124-1.28-2.852-3.84-3.156-1.828-.243-2.193-.728-2.193-1.578 0-.85.61-1.396 1.828-1.396 1.097 0 1.707.364 2.011 1.275a.458.458 0 0 0 .427.303h.975a.416.416 0 0 0 .427-.425v-.06a3.04 3.04 0 0 0-2.743-2.489V9.142c0-.243-.183-.425-.487-.486h-.915c-.243 0-.426.182-.487.486v1.396c-1.829.242-2.986 1.456-2.986 2.974 0 2.002 1.218 2.791 3.778 3.095 1.707.303 2.255.668 2.255 1.639 0 .97-.853 1.638-2.011 1.638-1.585 0-2.133-.668-2.316-1.578-.06-.303-.243-.364-.486-.364h-1.036a.416.416 0 0 0-.426.425v.06c.243 1.518 1.219 2.61 3.23 2.914v1.457c0 .242.183.425.487.485h.915c.243 0 .426-.182.487-.485V21.16c1.828-.303 3.107-1.578 3.107-3.035z"/></svg>`,
            usdt: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="16" fill="#26A17B"/><path fill="#FFF" d="M17.922 17.383v-.002c-.11.008-.677.042-1.942.042-1.01 0-1.721-.03-1.971-.042v.003c-3.888-.171-6.79-.848-6.79-1.658 0-.809 2.902-1.486 6.79-1.66v2.644c.254.018.982.061 1.988.061 1.207 0 1.812-.05 1.925-.06v-2.643c3.88.173 6.775.85 6.775 1.658 0 .81-2.895 1.485-6.775 1.657m0-3.59v-2.366h5.414V7.819H8.595v3.608h5.414v2.365c-4.4.202-7.709 1.074-7.709 2.118 0 1.044 3.309 1.915 7.709 2.118v7.582h3.913v-7.584c4.393-.202 7.694-1.073 7.694-2.116 0-1.043-3.301-1.914-7.694-2.117"/></svg>`,
            dai: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle fill="#F4B731" cx="16" cy="16" r="16"/><path fill="#FFF" d="M9.277 8h6.552c3.985 0 7.006 2.116 8.13 5.194H26v1.861h-1.611c.031.294.047.594.047.898v.046c0 .342-.02.68-.06 1.01H26v1.86h-2.08C22.767 21.905 19.77 24 15.83 24H9.277v-5.131H7v-1.86h2.277v-1.954H7v-1.86h2.277V8z"/></svg>`,
            wsteth: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle fill="#00A3FF" cx="16" cy="16" r="16"/><path fill="#FFF" d="M9.437 14.864l-.181.275c-2.048 3.097-1.603 7.253 1.034 9.824 1.561 1.521 3.622 2.353 5.683 2.353 0 0 0 0-6.536-12.452z"/><path fill="#FFF" opacity=".6" d="M15.997 18.611l-6.56-3.747c6.56 12.452 6.56 12.452 6.56 12.452 0-2.683 0-5.623 0-8.705z"/><path fill="#FFF" opacity=".6" d="M22.563 14.864l.181.275c2.048 3.097 1.603 7.253-1.034 9.824-1.561 1.521-3.622 2.353-5.683 2.353 0 0 0 0 6.536-12.452z"/><path fill="#FFF" opacity=".2" d="M16.003 18.611l6.56-3.747c-6.56 12.452-6.56 12.452-6.56 12.452 0-2.683 0-5.623 0-8.705z"/></svg>`,
            reth: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle fill="#FF6B35" cx="16" cy="16" r="16"/><path fill="#FFF" d="M16 6l-6.5 10.5L16 20l6.5-3.5L16 6z"/><path fill="#FFF" opacity=".6" d="M16 20l-6.5-3.5L16 26l6.5-9.5L16 20z"/></svg>`,
            shares: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle fill="#55FB9B" cx="16" cy="16" r="14" stroke="#000" stroke-width="1"/><text x="16" y="20" font-family="sans-serif" font-size="12" font-weight="bold" fill="#000" text-anchor="middle">S</text></svg>`,
            loot: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle fill="#FF69B4" cx="16" cy="16" r="14" stroke="#000" stroke-width="1"/><text x="16" y="20" font-family="sans-serif" font-size="12" font-weight="bold" fill="#000" text-anchor="middle">L</text></svg>`,
            default: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="14" fill="none" stroke="#00ffff" stroke-width="2"/><circle cx="16" cy="16" r="8" fill="none" stroke="#00ffff" stroke-width="1.5" opacity="0.5"/></svg>`
        };

        function getTokenIcon(address) {
            const addr = address?.toLowerCase();
            if (!addr || addr === ethers.ZeroAddress.toLowerCase()) return TOKEN_ICONS.eth;

            // Look up symbol from current network's token metadata
            const tokenMeta = COMMON_TRIB_TOKENS[address];
            if (tokenMeta?.symbol) {
                const iconKey = tokenMeta.symbol.toLowerCase();
                if (TOKEN_ICONS[iconKey]) return TOKEN_ICONS[iconKey];
            }

            return TOKEN_ICONS.default;
        }

        // Calculate deadline 30 days from now (as unix timestamp)
        function getDefaultDeadline() {
            const THIRTY_DAYS_IN_SECONDS = 30 * 24 * 60 * 60;
            return Math.floor(Date.now() / 1000) + THIRTY_DAYS_IN_SECONDS;
        }

        // DAICO ABI (minimal for summon functions)
        const DAICO_ABI = [
            'function summonDAICO((address summoner, address molochImpl, address sharesImpl, address lootImpl) summonConfig, string orgName, string orgSymbol, string orgURI, uint16 quorumBps, bool ragequittable, address renderer, bytes32 salt, address[] initHolders, uint256[] initShares, bool sharesLocked, bool lootLocked, (address tribTkn, uint256 tribAmt, uint256 saleSupply, uint256 forAmt, uint40 deadline, bool sellLoot, uint16 lpBps, uint16 maxSlipBps, uint256 feeOrHook) daicoConfig) payable returns (address dao)',
            'function summonDAICOCustom((address summoner, address molochImpl, address sharesImpl, address lootImpl) summonConfig, string orgName, string orgSymbol, string orgURI, uint16 quorumBps, bool ragequittable, address renderer, bytes32 salt, address[] initHolders, uint256[] initShares, bool sharesLocked, bool lootLocked, (address tribTkn, uint256 tribAmt, uint256 saleSupply, uint256 forAmt, uint40 deadline, bool sellLoot, uint16 lpBps, uint16 maxSlipBps, uint256 feeOrHook) daicoConfig, (address target, uint256 value, bytes data)[] customCalls) payable returns (address dao)',
            'function summonDAICOWithTap((address summoner, address molochImpl, address sharesImpl, address lootImpl) summonConfig, string orgName, string orgSymbol, string orgURI, uint16 quorumBps, bool ragequittable, address renderer, bytes32 salt, address[] initHolders, uint256[] initShares, bool sharesLocked, bool lootLocked, (address tribTkn, uint256 tribAmt, uint256 saleSupply, uint256 forAmt, uint40 deadline, bool sellLoot, uint16 lpBps, uint16 maxSlipBps, uint256 feeOrHook) daicoConfig, (address ops, uint128 ratePerSec, uint256 tapAllowance) tapConfig) payable returns (address dao)',
            'function summonDAICOWithTapCustom((address summoner, address molochImpl, address sharesImpl, address lootImpl) summonConfig, string orgName, string orgSymbol, string orgURI, uint16 quorumBps, bool ragequittable, address renderer, bytes32 salt, address[] initHolders, uint256[] initShares, bool sharesLocked, bool lootLocked, (address tribTkn, uint256 tribAmt, uint256 saleSupply, uint256 forAmt, uint40 deadline, bool sellLoot, uint16 lpBps, uint16 maxSlipBps, uint256 feeOrHook) daicoConfig, (address ops, uint128 ratePerSec, uint256 tapAllowance) tapConfig, (address target, uint256 value, bytes data)[] customCalls) payable returns (address dao)'
        ];

        // Moloch governance interfaces for init calls
        const MOLOCH_INTERFACES = {
            setProposalTTL: new ethers.Interface(['function setProposalTTL(uint64)']),
            setTimelockDelay: new ethers.Interface(['function setTimelockDelay(uint64)'])
        };

        // DAICO interface for encoding calldata
        const DAICO_IFACE = new ethers.Interface(DAICO_ABI);

        // Swiss Knife calldata decoder URL builder
        const SWISS_KNIFE_BASE = 'https://calldata.swiss-knife.xyz/decoder';
        function buildSwissKnifeUrl(calldata) {
            return `${SWISS_KNIFE_BASE}?chainId=${getNetwork().swissKnifeChainId}&address=${DAICO_ADDRESS}&calldata=${calldata}`;
        }

        // Error handling helpers
        function isUserRejection(error) {
            // Check top-level error codes
            if (error.code === 'ACTION_REJECTED' || error.code === 4001 || error.code === -32603) {
                // For -32603, check if it's actually a user rejection
                if (error.code === -32603) {
                    const msg = error.message || '';
                    if (msg.includes('User rejected') || msg.includes('user rejected')) {
                        return true;
                    }
                } else {
                    return true;
                }
            }
            // Check nested error (viem/ethers wraps wallet errors)
            if (error.error) {
                const nested = error.error;
                if (nested.code === 4001 || nested.code === -32603) {
                    const msg = nested.message || '';
                    if (msg.includes('User rejected') || msg.includes('user rejected')) {
                        return true;
                    }
                }
            }
            // Check error message for rejection patterns
            const msg = (error.message || '').toLowerCase();
            if (msg.includes('user rejected') || msg.includes('user denied') || msg.includes('rejected the request') || msg.includes('user closed') || msg.includes('qr code modal closed')) {
                return true;
            }
            return false;
        }

        function getErrorMessage(error) {
            if (error.shortMessage) return error.shortMessage;
            if (error.reason) return error.reason;
            if (error.message) return error.message.slice(0, 100);
            return 'Launch failed';
        }

        // Build contractURI metadata JSON (ERC-7572 compatible)
        // Returns data URI with JSON for on-chain storage, or empty string if no description
        // Note: If empty, the on-chain renderer displays default DUNA charter
        function buildContractURI(name, symbol, description) {
            if (!description || !description.trim()) {
                return ''; // Empty triggers renderer's default DUNA template
            }
            const metadata = {
                name: name || '',
                symbol: symbol || '',
                description: description.trim()
                // Future: image, external_link, banner_image, etc.
            };
            const json = JSON.stringify(metadata);
            return 'data:application/json;utf8,' + json;
        }

        // Parse contractURI to extract metadata (handles both JSON and SVG formats)
        // Returns: { type: 'json'|'svg', image?: string, description?: string, name?: string, symbol?: string }
        function parseContractURI(uri) {
            if (!uri) return null;

            try {
                // Handle data URI formats
                if (uri.startsWith('data:')) {
                    // JSON format: data:application/json;utf8,{...} or data:application/json;base64,...
                    if (uri.startsWith('data:application/json')) {
                        let jsonStr;
                        if (uri.includes(';base64,')) {
                            const base64 = uri.split(';base64,')[1];
                            jsonStr = atob(base64);
                        } else if (uri.includes(';utf8,')) {
                            jsonStr = uri.split(';utf8,')[1];
                        } else {
                            // Assume raw JSON after comma
                            jsonStr = uri.split(',')[1];
                        }
                        const metadata = JSON.parse(jsonStr);
                        return {
                            type: 'json',
                            name: metadata.name,
                            symbol: metadata.symbol,
                            description: metadata.description,
                            image: metadata.image,
                            external_link: metadata.external_link,
                            banner_image: metadata.banner_image
                        };
                    }

                    // SVG format: data:image/svg+xml;base64,... or data:image/svg+xml,...
                    if (uri.startsWith('data:image/svg+xml')) {
                        return {
                            type: 'svg',
                            image: uri // The URI itself is the image
                        };
                    }

                    // Other image formats
                    if (uri.startsWith('data:image/')) {
                        return {
                            type: 'image',
                            image: uri
                        };
                    }
                }

                // IPFS format
                if (uri.startsWith('ipfs://')) {
                    const ipfsHash = uri.replace('ipfs://', '');
                    return {
                        type: 'ipfs',
                        image: `https://ipfs.io/ipfs/${ipfsHash}`
                    };
                }

                // HTTP(S) URL - could be JSON or image
                if (uri.startsWith('http://') || uri.startsWith('https://')) {
                    return {
                        type: 'url',
                        image: uri
                    };
                }

                return null;
            } catch (e) {
                console.warn('Failed to parse contractURI:', e);
                return null;
            }
        }

        // Validate image URL to prevent XSS (javascript:, etc.)
        function isSafeImageUrl(url) {
            if (!url || typeof url !== 'string') return false;
            const lower = url.toLowerCase().trim();
            return lower.startsWith('https://') ||
                   lower.startsWith('http://') ||
                   lower.startsWith('data:image/') ||
                   lower.startsWith('ipfs://');
        }

        // Render DAO image/logo based on metadata
        // Returns HTML for the image display area
        function renderDaoImage(metadata, name) {
            const safeName = escapeHtml(name || '?');
            const initial = safeName[0].toUpperCase();

            if (!metadata) {
                // No metadata - show default placeholder
                return `<div class="daico-image daico-image-placeholder">
                    <span class="daico-image-initial">${initial}</span>
                </div>`;
            }

            // If we have a safe image URL (from JSON, SVG data URI, or direct image)
            if (metadata.image && isSafeImageUrl(metadata.image)) {
                return `<div class="daico-image">
                    <img src="${metadata.image}" alt="${safeName}" onerror="this.parentElement.innerHTML='<span class=\\'daico-image-initial\\'>${initial}</span>'" />
                </div>`;
            }

            // JSON with description but no image - render description box
            if (metadata.type === 'json' && metadata.description) {
                const truncatedDesc = metadata.description.length > 120
                    ? metadata.description.slice(0, 117) + '...'
                    : metadata.description;
                return `<div class="daico-image daico-image-description">
                    <span class="daico-desc-text">${escapeHtml(truncatedDesc)}</span>
                </div>`;
            }

            // Fallback to initial
            return `<div class="daico-image daico-image-placeholder">
                <span class="daico-image-initial">${initial}</span>
            </div>`;
        }

        // Helper to escape HTML for safe rendering
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // CREATE2 address prediction (must match Summoner's proxy bytecode)
        // Solidity: hex"602d5f8160095f39f35f5f365f5f37365f73" + impl + hex"5af43d5f5f3e6029573d5ffd5b3d5ff3"
        const CLONE_PREFIX = '0x602d5f8160095f39f35f5f365f5f37365f73';
        const CLONE_SUFFIX = '0x5af43d5f5f3e6029573d5ffd5b3d5ff3';

        function minimalProxyInitCode(implementation) {
            const impl = implementation.toLowerCase().replace(/^0x/, '');
            return ethers.concat([CLONE_PREFIX, '0x' + impl, CLONE_SUFFIX]);
        }

        function computeCreate2Address(deployer, salt, implementation) {
            const initCode = minimalProxyInitCode(implementation);
            const initCodeHash = ethers.keccak256(initCode);
            const encoded = ethers.solidityPacked(
                ['bytes1', 'address', 'bytes32', 'bytes32'],
                ['0xff', deployer, salt, initCodeHash]
            );
            return ethers.getAddress('0x' + ethers.keccak256(encoded).slice(-40));
        }

        function predictDaoAddress(initHolders, initShares, userSalt) {
            // Summoner computes salt as: keccak256(abi.encode(initHolders, initShares, userSalt))
            const summonerSalt = ethers.keccak256(
                ethers.AbiCoder.defaultAbiCoder().encode(
                    ['address[]', 'uint256[]', 'bytes32'],
                    [initHolders, initShares, userSalt]
                )
            );
            return computeCreate2Address(SUMMONER_ADDRESS, summonerSalt, getImplementations().moloch);
        }

        // State
        let provider = null;
        let signer = null;
        let connectedAddress = null;
        let connectedWalletProvider = null; // Raw wallet provider for network switching
        let connectedWallet = null;
        let isConnecting = false;
        let connectionJustCompleted = false; // Guard against spurious events right after connection
        let walletConnectProvider = null; // WalletConnect provider instance
        const eip6963Providers = new Map();

        // Wallet detection config
        const WALLET_CONFIG = {
            metamask: {
                name: 'MetaMask',
                icon: '',
                detect: () => window.ethereum?.isMetaMask,
                getProvider: () => window.ethereum
            },
            coinbase: {
                name: 'Coinbase Wallet',
                icon: '',
                detect: () => window.ethereum?.isCoinbaseWallet || window.coinbaseWalletExtension,
                getProvider: () => window.ethereum?.isCoinbaseWallet ? window.ethereum : window.coinbaseWalletExtension
            },
            rainbow: {
                name: 'Rainbow',
                icon: '',
                detect: () => window.ethereum?.isRainbow,
                getProvider: () => window.ethereum
            },
            rabby: {
                name: 'Rabby',
                icon: '',
                detect: () => window.ethereum?.isRabby,
                getProvider: () => window.ethereum
            },
            brave: {
                name: 'Brave',
                icon: '',
                detect: () => window.ethereum?.isBraveWallet,
                getProvider: () => window.ethereum
            },
            trust: {
                name: 'Trust Wallet',
                icon: '',
                detect: () => window.ethereum?.isTrust,
                getProvider: () => window.ethereum
            },
            phantom: {
                name: 'Phantom',
                icon: '',
                detect: () => window.phantom?.ethereum,
                getProvider: () => window.phantom?.ethereum
            },
            frame: {
                name: 'Frame',
                icon: '',
                detect: () => window.ethereum?.isFrame,
                getProvider: () => window.ethereum
            },
            zerion: {
                name: 'Zerion',
                icon: '',
                detect: () => window.ethereum?.isZerion,
                getProvider: () => window.ethereum
            },
            walletconnect: {
                name: 'WalletConnect',
                icon: ''
            }
        };

        // EIP-6963: Multi-injector wallet detection
        function initEIP6963() {
            if (typeof window === 'undefined') return;
            window.addEventListener('eip6963:announceProvider', (event) => {
                const { info, provider } = event.detail;
                eip6963Providers.set(info.uuid, { info, provider });
            });
            window.dispatchEvent(new Event('eip6963:requestProvider'));
        }

        function detectWallets() {
            const detected = [];
            const seenNames = new Set();

            // Detect legacy injected wallets (skip walletconnect - handled separately below)
            for (const [key, config] of Object.entries(WALLET_CONFIG)) {
                if (key === 'walletconnect') continue;
                if (config.detect()) {
                    detected.push({ key, ...config });
                    seenNames.add(config.name.toLowerCase());
                }
            }

            // Add EIP-6963 wallets not already detected
            for (const [uuid, { info, provider }] of eip6963Providers.entries()) {
                const nameLower = info.name.toLowerCase();
                if (!seenNames.has(nameLower)) {
                    detected.push({
                        key: `eip6963_${uuid}`,
                        name: info.name,
                        icon: info.icon ? `<img src="${info.icon}" style="width: 1.5rem; height: 1.5rem; vertical-align: middle;" alt="${info.name}"/>` : '',
                        detect: () => true,
                        getProvider: () => provider,
                        isEIP6963: true
                    });
                    seenNames.add(nameLower);
                }
            }

            // Fallback to generic injected provider
            if (detected.length === 0 && window.ethereum) {
                detected.push({ key: 'injected', name: 'Browser Wallet', icon: '', getProvider: () => window.ethereum });
            }

            // Always add WalletConnect as an option (for mobile QR scanning)
            const wcModule = (typeof globalThis !== 'undefined' ? globalThis : window)['@walletconnect/ethereum-provider'];
            if (wcModule?.EthereumProvider) {
                detected.push({
                    key: 'walletconnect',
                    name: 'WalletConnect',
                    icon: '',
                    isWalletConnect: true
                });
            }

            return detected;
        }

        // LocalStorage helpers
        function saveWalletPreference(walletKey) {
            try { localStorage.setItem('daico_wallet', walletKey); } catch (e) {}
        }
        function getWalletPreference() {
            try { return localStorage.getItem('daico_wallet'); } catch (e) { return null; }
        }
        function clearWalletPreference() {
            try { localStorage.removeItem('daico_wallet'); } catch (e) {}
        }

        function showWalletModal() {
            const wallets = detectWallets();
            const container = document.getElementById('walletOptions');

            // If already connected, show disconnect option
            if (connectedAddress && connectedWallet) {
                let walletInfo = WALLET_CONFIG[connectedWallet];
                if (!walletInfo && connectedWallet.startsWith('eip6963_')) {
                    const uuid = connectedWallet.replace('eip6963_', '');
                    const eip6963Wallet = eip6963Providers.get(uuid);
                    if (eip6963Wallet) {
                        walletInfo = {
                            name: eip6963Wallet.info.name,
                            icon: eip6963Wallet.info.icon ? `<img src="${eip6963Wallet.info.icon}" style="width: 1.5rem; height: 1.5rem;"/>` : ''
                        };
                    }
                }
                container.innerHTML = `
                    <div style="padding: 1rem; background: rgba(0, 255, 255, 0.05); border: 2px solid var(--cyan); margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.5rem;">${walletInfo?.icon || ''}</span>
                            <div>
                                <div style="font-family: 'Oswald', sans-serif; font-size: 1.1rem; color: var(--white);">${walletInfo?.name || 'Wallet'}</div>
                                <div style="color: var(--green); font-size: 0.85rem;">Connected</div>
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); word-break: break-all;">${connectedAddress}</div>
                    </div>
                    <div class="wallet-option disconnect" onclick="disconnectWallet()">
                        <span class="wallet-option-name">Disconnect</span>
                    </div>
                `;
            } else if (wallets.length === 0) {
                // This only happens if WalletConnect failed to load AND no browser wallets
                container.innerHTML = `
                    <p style="color: rgba(255,255,255,0.6); text-align: center; font-style: normal; margin-bottom: 1rem;">No wallet detected</p>
                    <div class="wallet-option" onclick="window.open('https://metamask.io/download/', '_blank')">
                        <span class="wallet-option-icon"></span>
                        <span class="wallet-option-name">Install MetaMask</span>
                    </div>
                    <div class="wallet-option" onclick="window.open('https://www.coinbase.com/wallet/downloads', '_blank')">
                        <span class="wallet-option-icon"></span>
                        <span class="wallet-option-name">Install Coinbase Wallet</span>
                    </div>
                    <div class="wallet-option" onclick="window.open('https://rainbow.me/download', '_blank')">
                        <span class="wallet-option-icon"></span>
                        <span class="wallet-option-name">Install Rainbow</span>
                    </div>
                `;
            } else {
                container.innerHTML = wallets.map(w => `
                    <div class="wallet-option" onclick="connectWithWallet('${w.key}')">
                        <span class="wallet-option-icon">${w.icon}</span>
                        <span class="wallet-option-name">${w.name}</span>
                    </div>
                `).join('');
            }

            document.getElementById('walletModal').classList.add('show');
        }

        function closeWalletModal() {
            document.getElementById('walletModal').classList.remove('show');
        }

        async function connectWallet() {
            showWalletModal();
        }

        async function connectWithWallet(walletKey) {
            if (isConnecting) return;
            isConnecting = true;

            try {
                closeWalletModal();

                let walletProvider;

                // Handle WalletConnect separately
                if (walletKey === 'walletconnect') {
                    // Access via globalThis (standard) or window (fallback)
                    const wcModule = (typeof globalThis !== 'undefined' ? globalThis : window)['@walletconnect/ethereum-provider'];
                    const WCProvider = wcModule?.EthereumProvider;

                    if (!WCProvider?.init) {
                        throw new Error('WalletConnect provider not available. Please refresh the page.');
                    }

                    // Clean up any existing WalletConnect provider to prevent listener accumulation
                    if (walletConnectProvider) {
                        try {
                            walletConnectProvider.removeAllListeners?.();
                            await walletConnectProvider.disconnect?.();
                        } catch (e) {
                            // Ignore cleanup errors
                        }
                        walletConnectProvider = null;
                    }

                    // Initialize WalletConnect v2 provider
                    walletConnectProvider = await WCProvider.init({
                        projectId: '1e8390ef1c1d8a185e035912a1409749',
                        chains: [1], // Required: at least one chain
                        optionalChains: [8453, 42161, 11155111], // Base, Arbitrum, Sepolia
                        showQrModal: true,
                        rpcMap: {
                            1: 'https://1rpc.io/eth',
                            8453: 'https://mainnet.base.org',
                            42161: 'https://arb1.arbitrum.io/rpc',
                            11155111: 'https://1rpc.io/sepolia'
                        },
                        metadata: {
                            name: 'DAICO.wtf',
                            description: 'Launch and manage DAICOs',
                            url: window.location.origin,
                            icons: ['https://daico.wtf/icon.png']
                        }
                    });

                    // Enable will show QR code modal and connect
                    await walletConnectProvider.enable();
                    walletProvider = walletConnectProvider;

                } else if (walletKey.startsWith('eip6963_')) {
                    // EIP-6963 wallets
                    const uuid = walletKey.replace('eip6963_', '');
                    const eip6963Wallet = eip6963Providers.get(uuid);
                    walletProvider = eip6963Wallet?.provider;
                } else {
                    // Legacy injected wallets
                    const config = WALLET_CONFIG[walletKey] || { getProvider: () => window.ethereum };
                    walletProvider = config.getProvider();
                }

                if (!walletProvider) {
                    throw new Error('Wallet provider not found');
                }

                // For non-WalletConnect, request accounts
                if (walletKey !== 'walletconnect') {
                    await walletProvider.request({ method: 'eth_requestAccounts' });
                }

                provider = new ethers.BrowserProvider(walletProvider);
                signer = await provider.getSigner();
                connectedAddress = await signer.getAddress();
                connectedWallet = walletKey;
                connectedWalletProvider = walletProvider; // Store for network switching

                // Save preference
                saveWalletPreference(walletKey);

                const shortAddress = connectedAddress.slice(0, 6) + '...' + connectedAddress.slice(-4);
                document.getElementById('walletBtn').textContent = shortAddress;
                document.getElementById('walletBtn').classList.add('connected');

                // Check network and sync currentNetwork with wallet
                // Get chainId directly from wallet provider to avoid ethers caching issues
                const chainIdHex = await walletProvider.request({ method: 'eth_chainId' });
                const chainId = BigInt(chainIdHex);
                const detectedNetwork = getNetworkByChainId(chainId);

                if (detectedNetwork) {
                    // Wallet is on a supported network - sync our state
                    const networkChanged = currentNetwork !== detectedNetwork.key;
                    currentNetwork = detectedNetwork.key;
                    localStorage.setItem('daico_network', currentNetwork);
                    // Update network selector UI
                    updateNetworkUI();
                    // Rescan if network changed
                    if (networkChanged) {
                        activeDAICOs = [];
                        completedDAICOs = [];
                        daicoScanTriggered = false;
                        triggerDAICOScan();
                    }
                } else {
                    // Unsupported network - show status message
                    showStatus('Please switch to a supported network (Ethereum, Base, or Sepolia)', 'error');
                }

                // Remove any existing listeners before adding new ones (prevent duplicates)
                walletProvider.removeListener?.('accountsChanged', handleAccountsChanged);
                walletProvider.removeListener?.('chainChanged', handleChainChanged);

                // Setup listeners
                walletProvider.on('accountsChanged', handleAccountsChanged);
                walletProvider.on('chainChanged', handleChainChanged);

                // WalletConnect-specific: listen for disconnect from mobile wallet
                if (walletKey === 'walletconnect' && walletConnectProvider) {
                    walletConnectProvider.on('disconnect', handleWalletConnectDisconnect);
                }

            } catch (error) {
                console.error('Connection failed:', error);
                if (!isUserRejection(error)) {
                    showStatus('Connection failed: ' + getErrorMessage(error), 'error');
                }
            } finally {
                isConnecting = false;
                // Set grace period flag to ignore spurious events right after connection
                connectionJustCompleted = true;
                setTimeout(() => { connectionJustCompleted = false; }, 2000);
            }
        }

        function disconnectWallet() {
            // Remove event listeners to prevent memory leaks
            if (connectedWalletProvider) {
                connectedWalletProvider.removeListener?.('accountsChanged', handleAccountsChanged);
                connectedWalletProvider.removeListener?.('chainChanged', handleChainChanged);
            }
            // Disconnect WalletConnect session if active
            if (walletConnectProvider) {
                try {
                    walletConnectProvider.removeListener?.('disconnect', handleWalletConnectDisconnect);
                    walletConnectProvider.disconnect();
                } catch (e) {
                    console.warn('WalletConnect disconnect error:', e);
                }
                walletConnectProvider = null;
            }
            provider = null;
            signer = null;
            connectedAddress = null;
            connectedWallet = null;
            connectedWalletProvider = null;
            clearWalletPreference();
            const walletBtn = document.getElementById('walletBtn');
            if (walletBtn) {
                walletBtn.textContent = 'Connect';
                walletBtn.classList.remove('connected');
            }
            closeWalletModal();
        }

        function handleAccountsChanged(accounts) {
            // Ignore spurious events during or right after connection
            if (isConnecting || connectionJustCompleted) return;

            if (accounts.length === 0) {
                disconnectWallet();
            } else {
                window.location.reload();
            }
        }

        function handleChainChanged() {
            // Ignore spurious events during or right after connection
            if (isConnecting || connectionJustCompleted) return;

            window.location.reload();
        }

        function handleWalletConnectDisconnect() {
            // Ignore spurious disconnect events during/after connection or if already disconnected
            if (isConnecting || connectionJustCompleted || !connectedAddress) return;
            disconnectWallet();
        }

        // Auto-reconnect on page load
        async function tryAutoReconnect() {
            const savedWallet = getWalletPreference();
            if (!savedWallet) return;

            // WalletConnect session restoration is complex for static sites
            // Simpler to have user re-scan QR code each session
            if (savedWallet === 'walletconnect') {
                clearWalletPreference();
                return;
            }

            // Wait a bit for EIP-6963 providers to announce
            await new Promise(r => setTimeout(r, 100));

            // Check if wallet is available
            let walletProvider;
            if (savedWallet.startsWith('eip6963_')) {
                const uuid = savedWallet.replace('eip6963_', '');
                const eip6963Wallet = eip6963Providers.get(uuid);
                walletProvider = eip6963Wallet?.provider;
            } else {
                const config = WALLET_CONFIG[savedWallet];
                if (config?.detect()) {
                    walletProvider = config.getProvider();
                }
            }

            if (!walletProvider) return;

            try {
                // Check if already authorized (don't prompt)
                const accounts = await walletProvider.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await connectWithWallet(savedWallet);
                }
            } catch (e) {
                console.warn('Auto-reconnect failed:', e);
            }
        }

        // Modal functions
        function openLaunchModal() {
            // Reset to form view (in case previously showed success)
            document.getElementById('launchForm').style.display = 'block';
            document.getElementById('successPanel').style.display = 'none';
            hideStatus();

            document.getElementById('launchModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            updateVisualization();
        }

        function closeLaunchModal() {
            document.getElementById('launchModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        // ==================== SIMPLE WIZARD ====================
        let wizardState = {
            tokenType: null, // 'shares' or 'loot'
            raiseAmount: null, // ETH target
            enableTap: false,
            tapOps: null, // Resolved ops address for tap
            tapPct: 100, // Percentage of raise for tap (default 100%)
            tapDuration: 6, // Duration in months (default 6)
            enableLP: false,
            lpPct: 10, // Default 10%
            step: 1
        };

        const WIZARD_DEFAULTS = {
            saleSupply: 1_000_000_000,
            quorumBps: 1000, // 10%
            proposalTTL: 172800, // 2 days in seconds
            timelockDelay: 86400, // 1 day in seconds
            tapPct: 100, // 100% of raise goes to tap by default
            tapDuration: 6 // 6 months default
        };

        // Calculate price per token from raise amount
        function calcPricePerToken(raiseEth) {
            return raiseEth / WIZARD_DEFAULTS.saleSupply;
        }

        // Format price display with per-token and per-million
        function formatPriceDisplay(pricePerToken) {
            if (pricePerToken === 0) return { perToken: '0 ETH', perMillion: '0 ETH' };

            const perMillion = pricePerToken * 1_000_000;

            // Format per-token (scientific for tiny numbers)
            let perTokenStr;
            if (pricePerToken >= 0.000001) {
                perTokenStr = pricePerToken.toFixed(10).replace(/\.?0+$/, '') + ' ETH';
            } else {
                perTokenStr = pricePerToken.toExponential(2) + ' ETH';
            }

            // Format per-million (should be more readable)
            let perMillionStr;
            if (perMillion >= 1) {
                perMillionStr = perMillion.toLocaleString(undefined, { maximumFractionDigits: 4 }) + ' ETH';
            } else if (perMillion >= 0.0001) {
                perMillionStr = perMillion.toFixed(6).replace(/\.?0+$/, '') + ' ETH';
            } else {
                perMillionStr = perMillion.toExponential(2) + ' ETH';
            }

            return { perToken: perTokenStr, perMillion: perMillionStr };
        }

        function openWizard() {
            // Reset wizard state
            wizardState = { tokenType: null, raiseAmount: null, enableTap: false, tapOps: null, tapPct: 100, tapDuration: 6, enableLP: false, lpPct: 10, step: 1 };

            // Reset all steps
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
            document.getElementById('wizardStep1').classList.add('active');

            // Clear inputs
            document.getElementById('wizardName').value = '';
            document.getElementById('wizardSymbol').value = '';
            document.getElementById('wizardDescription').value = '';
            document.getElementById('wizardCustomRaiseInput').value = '';
            document.getElementById('wizardCustomRaise').style.display = 'none';
            document.getElementById('wizardRaiseNav').style.display = 'flex';
            document.getElementById('wizardTapOps').value = '';
            document.getElementById('wizardTapOpsResolved').textContent = '';
            document.getElementById('wizardTapConfig').style.display = 'none';
            document.getElementById('wizardLPPct').value = '10';
            document.getElementById('wizardLPValue').textContent = '10%';
            document.getElementById('wizardLPConfig').style.display = 'none';

            // Reset founders list
            const foundersDiv = document.getElementById('wizardFounders');
            foundersDiv.innerHTML = `
                <div class="wizard-founder-row">
                    <input type="text" class="wizard-founder-input founder-address" placeholder="0x... (your address)">
                    <input type="text" class="wizard-founder-input founder-shares" placeholder="Shares">
                    <button class="wizard-founder-remove" onclick="removeFounder(this)" style="visibility: hidden;">&times;</button>
                </div>
            `;

            // Clear any status
            document.getElementById('wizardStatus').className = 'status-message';
            document.getElementById('wizardStatus').innerHTML = '';

            document.getElementById('wizardModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeWizard() {
            document.getElementById('wizardModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        function openAdvancedModal() {
            closeWizard();
            openLaunchModal();
        }

        function selectTokenType(type) {
            wizardState.tokenType = type;
            // Auto-enable tap for loot sales (prevents locked funds footgun)
            if (type === 'loot') {
                wizardState.enableTap = true;
            }
            showWizardStep(2);
        }

        function selectRaiseAmount(amount) {
            wizardState.raiseAmount = amount;
            showWizardStep(4); // Go to tap selection
        }

        function showCustomRaise() {
            document.getElementById('wizardCustomRaise').style.display = 'block';
            document.getElementById('wizardRaiseNav').style.display = 'none';
            document.getElementById('wizardCustomRaiseInput').focus();
            updateCustomPricePreview();
            // Add input listener
            document.getElementById('wizardCustomRaiseInput').oninput = updateCustomPricePreview;
        }

        function hideCustomRaise() {
            document.getElementById('wizardCustomRaise').style.display = 'none';
            document.getElementById('wizardRaiseNav').style.display = 'flex';
        }

        function updateCustomPricePreview() {
            const input = document.getElementById('wizardCustomRaiseInput').value;
            const amount = parseFloat(input) || 0;
            const priceEl = document.getElementById('wizardCustomPrice');
            if (amount > 0) {
                const price = calcPricePerToken(amount);
                const priceDisplay = formatPriceDisplay(price);
                priceEl.textContent = `${priceDisplay.perMillion} / 1M tokens`;
            } else {
                priceEl.textContent = '';
            }
        }

        function confirmCustomRaise() {
            const amount = parseFloat(document.getElementById('wizardCustomRaiseInput').value);
            if (!amount || amount <= 0) {
                showWizardStatus('Please enter a valid raise amount', 'error');
                return;
            }
            hideWizardStatus();
            wizardState.raiseAmount = amount;
            showWizardStep(4); // Go to tap selection
        }

        function selectTap(enabled) {
            // For loot sales, we auto-enable tap but allow disabling
            // Validation at confirm step will warn if loot + no tap + no founders (locked funds footgun)
            wizardState.enableTap = enabled;
            wizardState.tapOps = null; // Reset
            // Go to LP step
            showWizardStep(5);
        }

        function showTapConfig() {
            document.getElementById('wizardTapConfig').style.display = 'block';

            // Show connected address as default ops
            if (connectedAddress) {
                document.getElementById('wizardTapOpsAddr').textContent = connectedAddress;
            }

            // Reset to defaults
            wizardState.tapPct = 100;
            wizardState.tapDuration = 6;

            // Update button states - select last preset btn (100%) and middle duration btn (6 mo)
            document.querySelectorAll('.tap-preset-btn').forEach(btn => btn.classList.remove('active'));
            const presetBtns = document.querySelectorAll('.tap-preset-btn');
            if (presetBtns.length > 0) presetBtns[presetBtns.length - 1].classList.add('active');
            document.querySelectorAll('.tap-duration-btn').forEach(btn => btn.classList.remove('active'));
            const durationBtns = document.querySelectorAll('.tap-duration-btn');
            if (durationBtns.length > 1) durationBtns[1].classList.add('active');

            // Add ENS resolution on blur
            document.getElementById('wizardTapOps').onblur = resolveWizardTapOps;

            // Update the effect summary
            updateTapEffect();
        }

        function hideTapConfig() {
            document.getElementById('wizardTapConfig').style.display = 'none';
            document.getElementById('wizardTapOps').value = '';
            document.getElementById('wizardTapOpsResolved').textContent = '';
            document.getElementById('wizardTapOpsEdit').style.display = 'none';
            document.getElementById('wizardTapOpsDisplay').style.display = 'block';
        }

        function toggleTapOpsEdit() {
            const display = document.getElementById('wizardTapOpsDisplay');
            const edit = document.getElementById('wizardTapOpsEdit');

            if (edit.style.display === 'none') {
                display.style.display = 'none';
                edit.style.display = 'block';
                document.getElementById('wizardTapOps').focus();
            } else {
                edit.style.display = 'none';
                display.style.display = 'block';
            }
        }

        function setTapPct(pct, el) {
            wizardState.tapPct = pct;
            el.parentElement.querySelectorAll('.tap-preset-btn').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active');
            updateTapEffect();
        }

        function setTapDuration(months, el) {
            wizardState.tapDuration = months;
            el.parentElement.querySelectorAll('.tap-duration-btn').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active');
            updateTapEffect();
        }

        function updateTapEffect() {
            const raiseAmount = wizardState.raiseAmount || 0;
            const tapAmount = raiseAmount * (wizardState.tapPct / 100);
            const duration = wizardState.tapDuration;

            // Calculate rates
            const daysTotal = duration * 30.44; // avg days per month
            const ratePerDay = tapAmount / daysTotal;

            // Format the effect text
            let effectText = '';
            if (tapAmount > 0) {
                const tapAmountStr = tapAmount >= 0.01 ? tapAmount.toFixed(2) : tapAmount.toFixed(4);
                const dailyStr = formatTapRate(ratePerDay);
                effectText = `<span style="color: var(--green); font-weight: bold;">${tapAmountStr} ETH</span> over <span style="color: var(--cyan);">${duration} months</span>`;
                effectText += `<br><span style="opacity: 0.6; font-size: 0.85em;"> ${dailyStr}/day to ops</span>`;
            } else {
                effectText = `<span style="opacity: 0.5;">Set a raise amount first</span>`;
            }

            document.getElementById('wizardTapEffect').innerHTML = effectText;

            // Also update the percentage summary
            const remaining = 100 - wizardState.tapPct;
            const pctSummary = remaining > 0
                ? `${remaining}% stays in DAO treasury`
                : `Full raise accessible via tap`;
            document.getElementById('wizardTapPctSummary').textContent = pctSummary;
        }

        // Format tap rate with appropriate precision
        function formatTapRate(ethPerDay) {
            if (ethPerDay >= 1) {
                return ethPerDay.toFixed(2) + ' ETH';
            } else if (ethPerDay >= 0.001) {
                return ethPerDay.toFixed(4) + ' ETH';
            } else {
                // Convert to wei for very small amounts
                const weiPerDay = ethPerDay * 1e18;
                if (weiPerDay >= 1e15) {
                    return (weiPerDay / 1e15).toFixed(2) + ' finney';
                } else if (weiPerDay >= 1e12) {
                    return (weiPerDay / 1e12).toFixed(2) + ' gwei';
                } else {
                    return ethPerDay.toExponential(2) + ' ETH';
                }
            }
        }

        async function resolveWizardTapOps() {
            const input = document.getElementById('wizardTapOps').value.trim();
            const resolvedEl = document.getElementById('wizardTapOpsResolved');

            if (!input) {
                resolvedEl.textContent = '';
                return;
            }

            // If already a valid address, show it
            if (ethers.isAddress(input)) {
                resolvedEl.textContent = '';
                return;
            }

            // Try ENS resolution
            if (input.includes('.')) {
                resolvedEl.textContent = 'Resolving ENS...';
                resolvedEl.style.color = 'rgba(255,255,255,0.5)';
                try {
                    const resolved = await provider.resolveName(input);
                    if (resolved) {
                        resolvedEl.textContent = ` ${resolved.slice(0, 6)}...${resolved.slice(-4)}`;
                        resolvedEl.style.color = 'var(--cyan)';
                    } else {
                        resolvedEl.textContent = 'ENS name not found';
                        resolvedEl.style.color = 'var(--orange)';
                    }
                } catch (e) {
                    resolvedEl.textContent = 'Failed to resolve ENS';
                    resolvedEl.style.color = 'var(--orange)';
                }
            } else {
                resolvedEl.textContent = 'Invalid address format';
                resolvedEl.style.color = 'var(--orange)';
            }
        }

        async function confirmTapConfig() {
            const input = document.getElementById('wizardTapOps').value.trim();
            let opsAddress = null;

            if (!input) {
                // Use connected wallet as default
                opsAddress = connectedAddress;
            } else if (ethers.isAddress(input)) {
                opsAddress = input;
            } else if (input.includes('.')) {
                // Try ENS
                showWizardStatus('Resolving ENS...', 'info');
                try {
                    opsAddress = await provider.resolveName(input);
                    if (!opsAddress) {
                        showWizardStatus('ENS name not found', 'error');
                        return;
                    }
                } catch (e) {
                    showWizardStatus('Failed to resolve ENS', 'error');
                    return;
                }
            } else {
                showWizardStatus('Invalid address format', 'error');
                return;
            }

            hideWizardStatus();
            wizardState.enableTap = true;
            wizardState.tapOps = opsAddress;

            // Proceed to LP step
            showWizardStep(5);
        }

        function showWizardStep(step) {
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));

            if (step === 1) {
                document.getElementById('wizardStep1').classList.add('active');
            } else if (step === 2) {
                document.getElementById('wizardStep2').classList.add('active');
            } else if (step === 3) {
                document.getElementById('wizardStep3').classList.add('active');
            } else if (step === 4) {
                document.getElementById('wizardStep4').classList.add('active');
            } else if (step === 5) {
                // LP step
                updateLPPreview();
                document.getElementById('wizardStep5LP').classList.add('active');
            } else if (step === 6) {
                // Founders step (loot only)
                if (connectedAddress) {
                    const firstAddressInput = document.querySelector('#wizardFounders .founder-address');
                    if (firstAddressInput && !firstAddressInput.value) {
                        firstAddressInput.value = connectedAddress;
                    }
                }
                document.getElementById('wizardStep6Founders').classList.add('active');
            } else if (step === 'confirm') {
                updateWizardSummary();
                document.getElementById('wizardStepConfirm').classList.add('active');
            }

            wizardState.step = step;
        }

        // LP functions
        function showLPConfig() {
            document.getElementById('wizardLPConfig').style.display = 'block';
            updateLPPreview();
        }

        function hideLPConfig() {
            document.getElementById('wizardLPConfig').style.display = 'none';
        }

        function updateLPPreview() {
            const pct = parseInt(document.getElementById('wizardLPPct').value);
            document.getElementById('wizardLPValue').textContent = pct + '%';

            if (wizardState.raiseAmount) {
                const lpAmount = wizardState.raiseAmount * (pct / 100);
                const treasuryAmount = wizardState.raiseAmount - lpAmount;
                document.getElementById('wizardLPPreview').textContent =
                    `${lpAmount} ETH to liquidity  ${treasuryAmount} ETH to treasury`;
            }
        }

        function selectLP(enabled) {
            wizardState.enableLP = enabled;
            wizardState.lpPct = 0;
            // If loot, go to founders step, otherwise go to confirm
            if (wizardState.tokenType === 'loot') {
                showWizardStep(6);
            } else {
                showWizardStep('confirm');
            }
        }

        function confirmLPConfig() {
            wizardState.enableLP = true;
            wizardState.lpPct = parseInt(document.getElementById('wizardLPPct').value);
            // If loot, go to founders step, otherwise go to confirm
            if (wizardState.tokenType === 'loot') {
                showWizardStep(6);
            } else {
                showWizardStep('confirm');
            }
        }

        function wizardBack() {
            const step = wizardState.step;
            if (step === 2) {
                showWizardStep(1);
            } else if (step === 3) {
                showWizardStep(2);
            } else if (step === 4) {
                showWizardStep(3);
            } else if (step === 5) {
                showWizardStep(4);
            } else if (step === 6) {
                showWizardStep(5);
            } else if (step === 'confirm') {
                if (wizardState.tokenType === 'loot') {
                    showWizardStep(6);
                } else {
                    showWizardStep(5);
                }
            }
        }

        async function wizardNext() {
            const step = wizardState.step;
            if (step === 2) {
                // Validate name/symbol
                const name = document.getElementById('wizardName').value.trim();
                const symbol = document.getElementById('wizardSymbol').value.trim();

                if (!name) {
                    showWizardStatus('Please enter a DAO name', 'error');
                    return;
                }
                if (!symbol) {
                    showWizardStatus('Please enter a token symbol', 'error');
                    return;
                }

                hideWizardStatus();
                showWizardStep(3);
            } else if (step === 6) {
                // Validate and resolve founders (supports ENS)
                const founders = getWizardFounders();
                if (founders.addresses.length === 0) {
                    showWizardStatus('Please add at least one founder', 'error');
                    return;
                }

                // Resolve ENS names and validate addresses
                const resolvedAddresses = [];
                for (let i = 0; i < founders.addresses.length; i++) {
                    const input = founders.addresses[i];
                    let resolved = null;

                    if (ethers.isAddress(input)) {
                        resolved = input;
                    } else if (input.includes('.')) {
                        // Try ENS resolution
                        showWizardStatus(`Resolving ENS for founder ${i + 1}...`, 'info');
                        try {
                            resolved = await provider.resolveName(input);
                            if (!resolved) {
                                showWizardStatus(`ENS name not found for founder ${i + 1}`, 'error');
                                return;
                            }
                        } catch (e) {
                            showWizardStatus(`Failed to resolve ENS for founder ${i + 1}`, 'error');
                            return;
                        }
                    } else {
                        showWizardStatus(`Invalid address for founder ${i + 1}`, 'error');
                        return;
                    }

                    if (founders.shares[i] <= 0) {
                        showWizardStatus(`Invalid share amount for founder ${i + 1}`, 'error');
                        return;
                    }

                    resolvedAddresses.push(resolved);
                }

                // Store resolved addresses for launch
                wizardState.resolvedFounders = { addresses: resolvedAddresses, shares: founders.shares };

                hideWizardStatus();
                showWizardStep('confirm');
            }
        }

        function updateWizardSummary() {
            const name = document.getElementById('wizardName').value.trim();
            const symbol = document.getElementById('wizardSymbol').value.trim().toUpperCase();
            const price = calcPricePerToken(wizardState.raiseAmount);
            const priceDisplay = formatPriceDisplay(price);
            const isLoot = wizardState.tokenType === 'loot';

            document.getElementById('wizardSummaryName').textContent = `${name} (${symbol})`;
            document.getElementById('wizardSummaryType').textContent = isLoot ? 'Loot (Non-Voting)' : 'Shares (Voting)';
            document.getElementById('wizardSummaryRaise').textContent = `${wizardState.raiseAmount} ETH`;
            document.getElementById('wizardSummaryPrice').innerHTML = `${priceDisplay.perMillion} <span style="opacity: 0.5; font-size: 0.85em;">/ 1M tokens</span>`;

            // Show/hide founders row
            const foundersRow = document.getElementById('wizardSummaryFoundersRow');
            const founders = isLoot ? getWizardFounders() : { addresses: [], shares: [] };
            if (isLoot) {
                const totalShares = founders.shares.reduce((a, b) => a + b, 0);
                document.getElementById('wizardSummaryFounders').textContent = `${founders.addresses.length} founders (${totalShares.toLocaleString()} shares)`;
                foundersRow.style.display = 'flex';
            } else {
                foundersRow.style.display = 'none';
            }

            // Tap summary
            if (wizardState.enableTap) {
                const tapAmount = wizardState.raiseAmount * (wizardState.tapPct / 100);
                const duration = wizardState.tapDuration;
                const opsAddr = wizardState.tapOps || connectedAddress;
                const shortOps = opsAddr ? `${opsAddr.slice(0, 6)}...${opsAddr.slice(-4)}` : 'your wallet';
                const tapAmountStr = tapAmount >= 0.01 ? tapAmount.toFixed(2) : tapAmount.toFixed(4);
                document.getElementById('wizardSummaryTap').innerHTML = `${tapAmountStr} ETH / ${duration} mo <span style="opacity: 0.5;"> ${shortOps}</span>`;
            } else {
                document.getElementById('wizardSummaryTap').textContent = 'Disabled';
            }

            // LP summary
            if (wizardState.enableLP && wizardState.lpPct > 0) {
                const lpAmount = wizardState.raiseAmount * (wizardState.lpPct / 100);
                document.getElementById('wizardSummaryLP').innerHTML = `${wizardState.lpPct}% <span style="opacity: 0.5;">(${lpAmount} ETH to ZAMM)</span>`;
            } else {
                document.getElementById('wizardSummaryLP').textContent = 'None';
            }

            // Trust Mode notice - show for loot sale with tap but no shareholders
            const trustNotice = document.getElementById('wizardTrustModeNotice');
            if (isLoot && wizardState.enableTap && founders.addresses.length === 0) {
                trustNotice.style.display = 'block';
            } else {
                trustNotice.style.display = 'none';
            }
        }

        function getWizardFounders() {
            const rows = document.querySelectorAll('#wizardFounders .wizard-founder-row');
            const addresses = [];
            const shares = [];

            rows.forEach(row => {
                const addr = row.querySelector('.founder-address').value.trim();
                const shareVal = parseFloat(row.querySelector('.founder-shares').value.replace(/,/g, '')) || 0;

                if (addr && shareVal > 0) {
                    addresses.push(addr);
                    shares.push(shareVal);
                }
            });

            return { addresses, shares };
        }

        function addFounder() {
            const foundersDiv = document.getElementById('wizardFounders');
            const newRow = document.createElement('div');
            newRow.className = 'wizard-founder-row';
            newRow.innerHTML = `
                <input type="text" class="wizard-founder-input founder-address" placeholder="0x...">
                <input type="text" class="wizard-founder-input founder-shares" placeholder="Shares">
                <button class="wizard-founder-remove" onclick="removeFounder(this)">&times;</button>
            `;
            foundersDiv.appendChild(newRow);
        }

        function removeFounder(btn) {
            const row = btn.closest('.wizard-founder-row');
            const allRows = document.querySelectorAll('#wizardFounders .wizard-founder-row');
            if (allRows.length > 1) {
                row.remove();
            }
        }

        function showWizardStatus(message, type = 'info') {
            const el = document.getElementById('wizardStatus');
            el.className = 'status-message show ' + type;
            el.innerHTML = message;
        }

        function hideWizardStatus() {
            document.getElementById('wizardStatus').className = 'status-message';
        }

        async function launchSimpleDAICO() {
            if (!signer) {
                showWizardStatus('Please connect your wallet first', 'error');
                showWalletModal();
                return;
            }

            // Check network - get chainId directly from wallet provider to avoid ethers NETWORK_ERROR
            const walletChainIdHex = await connectedWalletProvider.request({ method: 'eth_chainId' });
            const walletChainId = BigInt(walletChainIdHex);
            const expectedNetwork = getNetwork();
            if (walletChainId !== expectedNetwork.chainId) {
                showWizardStatus(`Please switch wallet to ${expectedNetwork.name}`, 'error');
                try {
                    await connectedWalletProvider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: expectedNetwork.chainIdHex }]
                    });
                    return;
                } catch (error) {
                    if (!isUserRejection(error)) {
                        console.error('Failed to switch network:', error);
                    }
                }
                return;
            }

            // Recreate provider/signer to ensure we're on the correct network
            provider = new ethers.BrowserProvider(connectedWalletProvider);
            signer = await provider.getSigner();

            const name = document.getElementById('wizardName').value.trim();
            const symbol = document.getElementById('wizardSymbol').value.trim().toUpperCase();
            const description = document.getElementById('wizardDescription').value.trim();

            // Validate required fields
            if (!name) {
                showWizardStatus('Please enter a DAO name', 'error');
                return;
            }
            if (!symbol) {
                showWizardStatus('Please enter a token symbol', 'error');
                return;
            }
            if (!wizardState.raiseAmount || wizardState.raiseAmount <= 0) {
                showWizardStatus('Please set a raise amount', 'error');
                return;
            }

            const contractURI = buildContractURI(name, symbol, description);
            const price = calcPricePerToken(wizardState.raiseAmount);
            const isLoot = wizardState.tokenType === 'loot';

            // Footgun prevention: loot sale with no tap and no founders = locked funds
            if (isLoot && !wizardState.enableTap) {
                const founders = getWizardFounders();
                if (founders.addresses.length === 0) {
                    showWizardStatus('Loot sale requires either Tap or Founders to access funds', 'error');
                    return;
                }
            }

            // Gather founders (only for loot mode) - use pre-resolved ENS addresses
            let initHolders = [];
            let initSharesWei = [];

            if (isLoot) {
                if (wizardState.resolvedFounders) {
                    // Use pre-resolved addresses from wizardNext validation
                    initHolders = wizardState.resolvedFounders.addresses;
                    initSharesWei = wizardState.resolvedFounders.shares.map(s => ethers.parseEther(s.toString()));
                } else {
                    // Fallback to direct validation (shouldn't happen if wizard flow is followed)
                    const founders = getWizardFounders();
                    initHolders = founders.addresses;
                    initSharesWei = founders.shares.map(s => ethers.parseEther(s.toString()));
                }
            }

            try {
                document.getElementById('wizardLaunchBtn').disabled = true;
                showWizardStatus('Preparing transaction...', 'info');

                const daicoContract = new ethers.Contract(DAICO_ADDRESS, DAICO_ABI, signer);

                const impls = getImplementations();
                const summonConfig = {
                    summoner: SUMMONER_ADDRESS,
                    molochImpl: impls.moloch,
                    sharesImpl: impls.shares,
                    lootImpl: impls.loot
                };

                const saleSupplyWei = ethers.parseEther(WIZARD_DEFAULTS.saleSupply.toString());
                const forAmtWei = ethers.parseEther('1');
                // Format price as fixed decimal string (avoid scientific notation)
                const priceStr = price.toFixed(18);
                const tribAmtWei = ethers.parseEther(priceStr);

                // Convert LP percentage to basis points (10% = 1000 bps)
                const lpBps = wizardState.enableLP ? wizardState.lpPct * 100 : 0;

                const daicoConfig = {
                    tribTkn: ethers.ZeroAddress, // ETH
                    tribAmt: tribAmtWei,
                    saleSupply: saleSupplyWei,
                    forAmt: forAmtWei,
                    deadline: getDefaultDeadline(), // 30 days from now
                    sellLoot: isLoot,
                    lpBps: lpBps,
                    maxSlipBps: 100,
                    feeOrHook: 30
                };

                const salt = ethers.hexlify(ethers.randomBytes(32));

                // Predict DAO address for custom calls
                const predictedDao = predictDaoAddress(initHolders, initSharesWei, salt);

                // Build custom calls for governance settings
                const customCalls = [
                    {
                        target: predictedDao,
                        value: 0n,
                        data: MOLOCH_INTERFACES.setProposalTTL.encodeFunctionData('setProposalTTL', [WIZARD_DEFAULTS.proposalTTL])
                    },
                    {
                        target: predictedDao,
                        value: 0n,
                        data: MOLOCH_INTERFACES.setTimelockDelay.encodeFunctionData('setTimelockDelay', [WIZARD_DEFAULTS.timelockDelay])
                    }
                ];

                // Encode calldata and show verify link
                let calldata;
                let tx;
                // For WalletConnect, skip local gas estimation (use generous limit, wallet will refine)
                const txOverrides = walletConnectProvider ? { gasLimit: 2_000_000n } : {};

                if (wizardState.enableTap) {
                    // Calculate tap config using user-selected percentage and duration
                    const tapAllowanceNum = wizardState.raiseAmount * wizardState.tapPct / 100;
                    const tapAllowance = ethers.parseEther(tapAllowanceNum.toFixed(18));
                    // Convert months to seconds (avg 30.44 days/month)
                    const secondsPerMonth = 2629746n;
                    const durationSeconds = secondsPerMonth * BigInt(wizardState.tapDuration);
                    const ratePerSec = tapAllowance / durationSeconds;

                    const tapConfig = {
                        ops: wizardState.tapOps || connectedAddress, // Custom ops or default to summoner
                        ratePerSec: ratePerSec > 0n ? ratePerSec : 1n, // Min 1 wei/sec
                        tapAllowance: tapAllowance
                    };

                    calldata = DAICO_IFACE.encodeFunctionData('summonDAICOWithTapCustom', [
                        summonConfig, name, symbol, contractURI, WIZARD_DEFAULTS.quorumBps,
                        true, DEFAULT_RENDERER, salt, initHolders, initSharesWei,
                        false, false, daicoConfig, tapConfig, customCalls
                    ]);

                    const verifyUrl = buildSwissKnifeUrl(calldata);
                    showWizardStatus(`Confirm in wallet... <a href="${verifyUrl}" target="_blank" rel="noopener" style="color: var(--cyan); opacity: 0.7; font-size: 0.85em;">verify calldata</a>`, 'info');

                    tx = await daicoContract.summonDAICOWithTapCustom(
                        summonConfig,
                        name,
                        symbol,
                        contractURI,
                        WIZARD_DEFAULTS.quorumBps,
                        true, // ragequittable
                        DEFAULT_RENDERER,
                        salt,
                        initHolders,
                        initSharesWei,
                        false, // sharesLocked
                        false, // lootLocked
                        daicoConfig,
                        tapConfig,
                        customCalls,
                        txOverrides
                    );
                } else {
                    calldata = DAICO_IFACE.encodeFunctionData('summonDAICOCustom', [
                        summonConfig, name, symbol, contractURI, WIZARD_DEFAULTS.quorumBps,
                        true, DEFAULT_RENDERER, salt, initHolders, initSharesWei,
                        false, false, daicoConfig, customCalls
                    ]);

                    const verifyUrl = buildSwissKnifeUrl(calldata);
                    showWizardStatus(`Confirm in wallet... <a href="${verifyUrl}" target="_blank" rel="noopener" style="color: var(--cyan); opacity: 0.7; font-size: 0.85em;">verify calldata</a>`, 'info');

                    tx = await daicoContract.summonDAICOCustom(
                        summonConfig,
                        name,
                        symbol,
                        contractURI,
                        WIZARD_DEFAULTS.quorumBps,
                        true, // ragequittable
                        DEFAULT_RENDERER,
                        salt,
                        initHolders,
                        initSharesWei,
                        false, // sharesLocked
                        false, // lootLocked
                        daicoConfig,
                        customCalls,
                        txOverrides
                    );
                }

                showWizardStatus(`Transaction submitted! <a href="${getNetwork().explorer}/tx/${tx.hash}" target="_blank" rel="noopener" style="color: var(--cyan);">View on Explorer</a>`, 'info');

                await tx.wait();

                // Show success step
                document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
                document.getElementById('wizardSuccess').classList.add('active');
                document.getElementById('wizardSuccessAddress').textContent = predictedDao;
                document.getElementById('wizardSuccessLink').href = `https://majeurdao.eth.limo/#/dao/${getNetwork().chainId}/${predictedDao}`;

                hideWizardStatus();

                // Refresh DAICO list to show the new sale
                daicoScanTriggered = false;
                setTimeout(() => triggerDAICOScan(), 3000);

            } catch (error) {
                console.error('Launch failed:', error);

                // Check if user rejected the transaction (handle various wallet error formats)
                if (isUserRejection(error)) {
                    hideWizardStatus();
                } else {
                    const errorMessage = getErrorMessage(error);
                    showWizardStatus(errorMessage, 'error');
                }
            } finally {
                document.getElementById('wizardLaunchBtn').disabled = false;
            }
        }

        // ==================== END WIZARD ====================

        // ==================== INTERACTIVE SUMMARY ====================
        // Ordered array for tribute token cycling
        // Get tribute tokens for current network from NETWORKS config
        function getSummaryTributeTokens() {
            const network = getNetwork();
            return network.treasuryTokens.map(address => {
                const meta = network.tokenMeta[address] || { symbol: '???', decimals: 18 };
                return { address, symbol: meta.symbol, decimals: meta.decimals };
            });
        }

        const summaryState = {
            raise: 10,
            supply: 1_000_000_000,
            tokenType: 'shares', // 'shares' or 'loot'
            quorum: 10,
            voting: 2,
            timelock: 1,
            tributeTokenIndex: 0, // Index into getSummaryTributeTokens()
            tapEnabled: true,
            tapPct: 100,
            tapMonths: 6,
            founderShares: false, // Whether to mint shares to summoner (for Builder template)
            template: 'buterin' // Current active template: 'buterin', 'club', 'builder', 'ungovern', or null (custom)
        };

        // Template definitions
        // Buterin: Classic DAICO per Vitalik's vision - tap + governance + ragequit
        // Club: Investment club - no tap (vote on each spend), higher quorum
        // Builder: Loot sale + founder shares + no tap - builder controls treasury, funders can ragequit
        // Ungovern: Pure loot sale + tap - no governance at all, just ragequit + tap
        const DAICO_TEMPLATES = {
            buterin: {
                name: 'Buterin',
                description: 'Classic DAICO: tap + governance',
                tokenType: 'shares',
                quorum: 10,
                voting: 2,
                timelock: 1,
                tapEnabled: true,
                tapPct: 100,
                tapMonths: 6,
                founderShares: false,
                signature: { tokenType: 'shares', tapEnabled: true }
            },
            club: {
                name: 'Club',
                description: 'Investment club: vote on spends',
                tokenType: 'shares',
                quorum: 20,
                voting: 3,
                timelock: 1,
                tapEnabled: false,
                tapPct: 0,
                tapMonths: 0,
                founderShares: false,
                signature: { tokenType: 'shares', tapEnabled: false }
            },
            builder: {
                name: 'Builder',
                description: 'Builder controls treasury, funders can exit',
                tokenType: 'loot',
                quorum: 51,
                voting: 3,
                timelock: 3,
                tapEnabled: false,
                tapPct: 0,
                tapMonths: 0,
                founderShares: true, // Builder gets shares to control DAO
                signature: { tokenType: 'loot', tapEnabled: false, founderShares: true }
            },
            ungovern: {
                name: 'Ungovern',
                description: 'No governance: tap + ragequit only',
                tokenType: 'loot',
                quorum: 10,
                voting: 2,
                timelock: 1,
                tapEnabled: true,
                tapPct: 100,
                tapMonths: 3,
                founderShares: false, // No founder shares - truly ungoverned
                signature: { tokenType: 'loot', tapEnabled: true, founderShares: false }
            }
        };

        // Apply a template to the summary state
        function applyTemplate(templateId) {
            const template = DAICO_TEMPLATES[templateId];
            if (!template) return;

            // Update state
            summaryState.tokenType = template.tokenType;
            summaryState.quorum = template.quorum;
            summaryState.voting = template.voting;
            summaryState.timelock = template.timelock;
            summaryState.tapEnabled = template.tapEnabled;
            summaryState.tapPct = template.tapPct;
            summaryState.tapMonths = template.tapMonths;
            summaryState.founderShares = template.founderShares;
            summaryState.template = templateId;

            // Update UI elements
            document.getElementById('editQuorum').textContent = template.quorum + '%';
            document.getElementById('editVoting').textContent = template.voting;
            document.getElementById('editTimelock').textContent = template.timelock;

            // Update token type display
            const tokenTypeEl = document.getElementById('editTokenType');
            if (template.tokenType === 'loot') {
                tokenTypeEl.textContent = 'Loot';
                tokenTypeEl.classList.add('loot');
            } else {
                tokenTypeEl.textContent = 'Shares';
                tokenTypeEl.classList.remove('loot');
            }

            // Update template note with explanatory text
            const templateNote = document.getElementById('summaryTemplateNote');
            templateNote.className = `summary-template-note ${templateId}`;
            if (templateId === 'buterin') {
                templateNote.textContent = 'All holders vote. Tap releases funds automatically to ops.';
            } else if (templateId === 'club') {
                templateNote.textContent = 'All holders vote on each spend. No automatic fund release.';
            } else if (templateId === 'builder') {
                templateNote.textContent = 'Builder controls treasury. Funders can ragequit within timelock.';
            } else if (templateId === 'ungovern') {
                templateNote.textContent = 'No governance. Tap releases funds to ops. Holders can ragequit.';
            }

            // Update tap display
            updateSummaryTapDisplay();

            // Update template buttons
            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.template-btn.${templateId}`);
            if (activeBtn) activeBtn.classList.add('active');

            // Hide governance line for Ungovern (no founder shares = no governance)
            // Show for Builder (founder has shares and controls treasury)
            const governanceLine = document.getElementById('governanceLine');
            if (governanceLine) {
                governanceLine.style.display = (templateId === 'ungovern') ? 'none' : '';
            }

            // Update price preview
            updateSummaryPricePreview();
        }

        // Check if current state matches a template (for button highlight)
        function detectCurrentTemplate() {
            for (const [id, template] of Object.entries(DAICO_TEMPLATES)) {
                if (summaryState.tokenType === template.tokenType &&
                    summaryState.tapEnabled === template.tapEnabled &&
                    summaryState.founderShares === template.founderShares &&
                    summaryState.quorum === template.quorum &&
                    summaryState.voting === template.voting &&
                    summaryState.timelock === template.timelock &&
                    (!template.tapEnabled || (
                        summaryState.tapPct === template.tapPct &&
                        summaryState.tapMonths === template.tapMonths
                    ))) {
                    return id;
                }
            }
            return null; // Custom configuration
        }

        // Update template button states based on current state (called when user edits values)
        function updateTemplateBadge() {
            const detectedTemplate = detectCurrentTemplate();

            // Update button states
            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));

            if (detectedTemplate) {
                summaryState.template = detectedTemplate;
                const activeBtn = document.querySelector(`.template-btn.${detectedTemplate}`);
                if (activeBtn) activeBtn.classList.add('active');
            } else {
                summaryState.template = null;
            }

            // Hide governance line when loot without founder shares (no practical governance)
            // Show when shares, or when loot with founder shares (Builder)
            const governanceLine = document.getElementById('governanceLine');
            if (governanceLine) {
                const hasGovernance = summaryState.tokenType === 'shares' || summaryState.founderShares;
                governanceLine.style.display = hasGovernance ? '' : 'none';
            }
        }

        // Update template note text based on current state
        function updateTemplateNote() {
            const templateNote = document.getElementById('summaryTemplateNote');
            const detected = summaryState.template || detectCurrentTemplate();

            if (detected) {
                templateNote.className = `summary-template-note ${detected}`;
                if (detected === 'buterin') {
                    templateNote.textContent = 'All holders vote. Tap releases funds automatically to ops.';
                } else if (detected === 'club') {
                    templateNote.textContent = 'All holders vote on each spend. No automatic fund release.';
                } else if (detected === 'builder') {
                    templateNote.textContent = 'Builder controls treasury. Funders can ragequit within timelock.';
                } else if (detected === 'ungovern') {
                    templateNote.textContent = 'No governance. Tap releases funds to ops. Holders can ragequit.';
                }
            } else {
                // Custom config - show generic note based on token type
                templateNote.className = 'summary-template-note';
                if (summaryState.tokenType === 'loot') {
                    templateNote.textContent = summaryState.tapEnabled
                        ? 'Loot holders can ragequit. Tap releases funds to ops.'
                        : 'Loot holders can ragequit. Proposals control treasury.';
                } else {
                    templateNote.textContent = summaryState.tapEnabled
                        ? 'All holders vote. Tap releases funds automatically.'
                        : 'All holders vote on each spend.';
                }
            }
        }

        // Detect template from on-chain DAO config (for gallery display)
        // Uses efficient heuristics based on token type and tap presence
        function detectDAICOTemplate(sale, dao) {
            // sale: { tribAmt, forAmt, forTkn, deadline, remainingSupply, totalSupply }
            // dao: { isLoot, hasTap, tapRate }

            const isLoot = dao?.isLoot || false;
            const hasTap = dao?.hasTap || (dao?.tapRate && dao.tapRate > 0n);

            // Shares sales
            if (!isLoot) {
                // Buterin: Shares + Tap (classic DAICO)
                if (hasTap) {
                    return 'buterin';
                }
                // Club: Shares + No Tap (vote on spends)
                return 'club';
            }

            // Loot sales
            if (isLoot) {
                // Ungovern: Loot + Tap (truly ungoverned, tap releases funds)
                if (hasTap) {
                    return 'ungovern';
                }
                // Builder: Loot sale + No Tap (builder controls treasury via proposals)
                return 'builder';
            }

            return null;
        }

        // Initialize price preview on load
        function updateSummaryPricePreview() {
            const tributeToken = getSummaryTributeTokens()[summaryState.tributeTokenIndex];
            const price = summaryState.raise / summaryState.supply;
            const pricePerMillion = price * 1_000_000;
            let priceStr;
            if (pricePerMillion >= 0.0001) {
                priceStr = pricePerMillion.toFixed(6).replace(/\.?0+$/, '');
            } else {
                priceStr = pricePerMillion.toExponential(2);
            }
            const icon = getTokenIcon(tributeToken.address);
            document.getElementById('summaryPricePreview').innerHTML = `${priceStr} ${tributeToken.symbol} <span class="summary-token-icon">${icon}</span> per 1M tokens`;
        }

        function editSummaryField(field) {
            const elementMap = {
                raise: 'editRaise',
                supply: 'editSupply',
                quorum: 'editQuorum',
                voting: 'editVoting',
                timelock: 'editTimelock',
                tapPct: 'editTapPct',
                tapMonths: 'editTapMonths'
            };

            const el = document.getElementById(elementMap[field]);
            if (!el || el.classList.contains('editing')) return;

            const currentValue = el.textContent.replace(/[,%]/g, '');
            const isPercent = field === 'quorum' || field === 'tapPct';

            el.classList.add('editing');
            el.innerHTML = `<input type="number" value="${currentValue}" min="1" step="any">`;

            const input = el.querySelector('input');
            input.focus();
            input.select();

            const finishEdit = () => {
                let newValue = parseFloat(input.value) || summaryState[field];

                // Validate ranges
                if (field === 'raise') newValue = Math.max(0.001, newValue);
                if (field === 'supply') newValue = Math.max(1, Math.round(newValue));
                if (field === 'quorum') newValue = Math.max(1, Math.min(100, Math.round(newValue)));
                if (field === 'voting') newValue = Math.max(1, Math.round(newValue));
                if (field === 'timelock') newValue = Math.max(0, Math.round(newValue));
                if (field === 'tapPct') newValue = Math.max(1, Math.min(100, Math.round(newValue)));
                if (field === 'tapMonths') newValue = Math.max(1, Math.min(60, Math.round(newValue)));

                summaryState[field] = newValue;

                // Format display
                let displayValue;
                if (field === 'supply') {
                    displayValue = newValue.toLocaleString();
                } else if (field === 'quorum' || field === 'tapPct') {
                    displayValue = newValue + '%';
                } else {
                    displayValue = newValue.toString();
                }

                el.classList.remove('editing');
                el.textContent = displayValue;
                updateSummaryPricePreview();
                // Update tap preview if raise, tapPct, or tapMonths changed
                if (field === 'raise' || field === 'tapPct' || field === 'tapMonths') {
                    updateSummaryTapDisplay();
                }
                // Check if edit changes template match
                updateTemplateBadge();
                updateTemplateNote();
            };

            input.addEventListener('blur', finishEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                }
                if (e.key === 'Escape') {
                    // Restore original value
                    let displayValue;
                    if (field === 'supply') {
                        displayValue = summaryState[field].toLocaleString();
                    } else if (field === 'quorum' || field === 'tapPct') {
                        displayValue = summaryState[field] + '%';
                    } else {
                        displayValue = summaryState[field].toString();
                    }
                    el.classList.remove('editing');
                    el.textContent = displayValue;
                }
            });
        }

        function toggleSummaryTokenType() {
            const el = document.getElementById('editTokenType');
            if (summaryState.tokenType === 'shares') {
                summaryState.tokenType = 'loot';
                el.textContent = 'Loot';
                el.classList.add('loot');
                // Reset founderShares when manually switching to loot
                summaryState.founderShares = false;
                // Auto-enable tap for loot sales without founder shares (prevents locked funds footgun)
                if (!summaryState.tapEnabled && !summaryState.founderShares) {
                    summaryState.tapEnabled = true;
                    updateSummaryTapDisplay();
                }
            } else {
                summaryState.tokenType = 'shares';
                summaryState.founderShares = false; // Reset when switching to shares
                el.textContent = 'Shares';
                el.classList.remove('loot');
            }
            updateTemplateBadge();
            updateTemplateNote();
        }

        function toggleSummaryTribute() {
            summaryState.tributeTokenIndex = (summaryState.tributeTokenIndex + 1) % getSummaryTributeTokens().length;
            const tributeToken = getSummaryTributeTokens()[summaryState.tributeTokenIndex];
            const el = document.getElementById('editTribute');
            el.textContent = tributeToken.symbol;
            updateSummaryPricePreview();
            updateSummaryTapDisplay(); // Update daily rate for new token symbol
        }

        function toggleSummaryTap() {
            // Prevent disabling tap for loot sales without founder shares (locked funds footgun)
            // Allow disabling if founderShares is true (Builder pattern - founder controls treasury)
            if (summaryState.tapEnabled && summaryState.tokenType === 'loot' && !summaryState.founderShares) {
                return; // Don't allow disabling tap for loot sales without founder control
            }
            summaryState.tapEnabled = !summaryState.tapEnabled;
            updateSummaryTapDisplay();
            updateTemplateBadge();
            updateTemplateNote();
        }

        function editTapPctField() {
            // If tap is disabled, clicking the "disabled" text enables it
            if (!summaryState.tapEnabled) {
                summaryState.tapEnabled = true;
                updateSummaryTapDisplay();
                updateTemplateBadge();
                updateTemplateNote();
                return;
            }
            // Otherwise, edit normally
            editSummaryField('tapPct');
        }

        function updateSummaryTapDisplay() {
            const tapPctEl = document.getElementById('editTapPct');
            const tapMonthsEl = document.getElementById('editTapMonths');
            const tapToggleEl = document.getElementById('editTapToggle');
            const tapOverText = document.getElementById('tapOverText');
            const tapMonthsText = document.getElementById('tapMonthsText');
            const tapPreviewEl = document.getElementById('summaryTapPreview');

            if (summaryState.tapEnabled) {
                // Show tap values
                tapPctEl.textContent = summaryState.tapPct + '%';
                tapPctEl.style.opacity = '1';
                tapMonthsEl.textContent = summaryState.tapMonths;
                tapMonthsEl.style.display = 'inline';
                tapToggleEl.textContent = '(disable)';
                tapOverText.style.display = 'inline';
                tapMonthsText.style.display = 'inline';

                // Calculate and show daily tap rate
                const tributeToken = getSummaryTributeTokens()[summaryState.tributeTokenIndex];
                const tapAmount = summaryState.raise * (summaryState.tapPct / 100);
                const daysTotal = summaryState.tapMonths * 30.44; // avg days per month
                const ratePerDay = tapAmount / daysTotal;
                const dailyStr = formatSummaryTapRate(ratePerDay, tributeToken.symbol);
                tapPreviewEl.textContent = ` ${dailyStr}/day to ops`;
                tapPreviewEl.style.display = 'block';
            } else {
                // Hide tap values, show "disabled"
                tapPctEl.textContent = 'disabled';
                tapPctEl.style.opacity = '0.5';
                tapMonthsEl.style.display = 'none';
                tapToggleEl.textContent = '(enable)';
                tapOverText.style.display = 'none';
                tapMonthsText.style.display = 'none';
                tapPreviewEl.style.display = 'none';
            }
        }

        // Format tap rate for summary display
        function formatSummaryTapRate(amountPerDay, symbol) {
            // For stablecoins, just show the amount
            if (symbol === 'USDC' || symbol === 'USDT' || symbol === 'DAI') {
                if (amountPerDay >= 1) {
                    return amountPerDay.toFixed(2) + ' ' + symbol;
                } else if (amountPerDay >= 0.01) {
                    return amountPerDay.toFixed(4) + ' ' + symbol;
                } else {
                    return amountPerDay.toExponential(2) + ' ' + symbol;
                }
            }
            // For ETH and wstETH, use sub-units for small amounts
            if (amountPerDay >= 1) {
                return amountPerDay.toFixed(2) + ' ' + symbol;
            } else if (amountPerDay >= 0.001) {
                return amountPerDay.toFixed(4) + ' ' + symbol;
            } else {
                const weiPerDay = amountPerDay * 1e18;
                if (weiPerDay >= 1e15) {
                    return (weiPerDay / 1e15).toFixed(2) + ' finney';
                } else if (weiPerDay >= 1e12) {
                    return (weiPerDay / 1e12).toFixed(2) + ' gwei';
                } else {
                    return amountPerDay.toExponential(2) + ' ' + symbol;
                }
            }
        }

        async function launchFromSummary() {
            if (!signer || !connectedWalletProvider) {
                document.getElementById('summaryStatus').innerHTML = 'Please <a href="#" onclick="connectWallet(); return false;" style="color: var(--cyan);">connect wallet</a> first';
                return;
            }

            // Get chainId directly from wallet provider to avoid ethers NETWORK_ERROR
            const walletChainIdHex = await connectedWalletProvider.request({ method: 'eth_chainId' });
            const walletChainId = BigInt(walletChainIdHex);
            const expectedNetwork = getNetwork();
            if (walletChainId !== expectedNetwork.chainId) {
                document.getElementById('summaryStatus').textContent = `Please switch wallet to ${expectedNetwork.name}`;
                // Also trigger network switch prompt
                try {
                    await connectedWalletProvider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: expectedNetwork.chainIdHex }]
                    });
                    // If successful, page will reload via chainChanged handler
                    return;
                } catch (error) {
                    if (!isUserRejection(error)) {
                        console.error('Failed to switch network:', error);
                    }
                }
                return;
            }

            // Recreate provider/signer to ensure we're on the correct network
            provider = new ethers.BrowserProvider(connectedWalletProvider);
            signer = await provider.getSigner();

            const name = document.getElementById('summaryName').value.trim();
            const symbol = document.getElementById('summarySymbol').value.trim().toUpperCase();
            const description = document.getElementById('summaryDescription').value.trim();
            const contractURI = buildContractURI(name, symbol, description);

            if (!name) {
                document.getElementById('summaryStatus').textContent = 'Please enter a DAO name';
                return;
            }
            if (!symbol) {
                document.getElementById('summaryStatus').textContent = 'Please enter a token symbol';
                return;
            }

            const isLoot = summaryState.tokenType === 'loot';
            const price = summaryState.raise / summaryState.supply;

            try {
                document.getElementById('summaryLaunchBtn').disabled = true;
                document.getElementById('summaryStatus').textContent = 'Preparing transaction...';

                const daicoContract = new ethers.Contract(DAICO_ADDRESS, DAICO_ABI, signer);

                const impls = getImplementations();
                const summonConfig = {
                    summoner: SUMMONER_ADDRESS,
                    molochImpl: impls.moloch,
                    sharesImpl: impls.shares,
                    lootImpl: impls.loot
                };

                const tributeToken = getSummaryTributeTokens()[summaryState.tributeTokenIndex];
                const saleSupplyWei = ethers.parseEther(summaryState.supply.toString());

                // For 6-decimal tokens (USDC/USDT), use larger forAmt to maintain precision
                // Price = tribAmt / forAmt, so: tribAmt = price * forAmt
                // With forAmt = 1M tokens and 6 decimals, min price is 0.000001 USDC per 1M = 1e-12 per token
                const forAmtTokens = tributeToken.decimals === 6 ? 1_000_000 : 1;
                const forAmtWei = ethers.parseEther(forAmtTokens.toString());
                const tribAmtForBatch = price * forAmtTokens;
                const tribAmtWei = ethers.parseUnits(tribAmtForBatch.toFixed(tributeToken.decimals), tributeToken.decimals);

                const daicoConfig = {
                    tribTkn: tributeToken.address,
                    tribAmt: tribAmtWei,
                    saleSupply: saleSupplyWei,
                    forAmt: forAmtWei,
                    deadline: getDefaultDeadline(), // 30 days from now
                    sellLoot: isLoot,
                    lpBps: 0,
                    maxSlipBps: 100,
                    feeOrHook: 30
                };

                // For Builder template, founder gets shares to control the DAO
                // For Ungovern template (loot + tap, no founder shares), no one governs
                let initHolders = [];
                let initSharesWei = [];
                if (summaryState.founderShares) {
                    initHolders = [connectedAddress];
                    initSharesWei = [ethers.parseEther('1000000')]; // 1M shares to founder/builder
                }

                const salt = ethers.hexlify(ethers.randomBytes(32));
                const predictedDao = predictDaoAddress(initHolders, initSharesWei, salt);

                // Convert governance settings to contract values
                const quorumBps = summaryState.quorum * 100;
                const proposalTTL = summaryState.voting * 86400; // days to seconds
                const timelockDelay = summaryState.timelock * 86400;

                const customCalls = [
                    {
                        target: predictedDao,
                        value: 0n,
                        data: MOLOCH_INTERFACES.setProposalTTL.encodeFunctionData('setProposalTTL', [proposalTTL])
                    },
                    {
                        target: predictedDao,
                        value: 0n,
                        data: MOLOCH_INTERFACES.setTimelockDelay.encodeFunctionData('setTimelockDelay', [timelockDelay])
                    }
                ];

                // Encode calldata and show verify link
                let calldata;
                let tx;
                // For WalletConnect, skip local gas estimation (use generous limit, wallet will refine)
                const txOverrides = walletConnectProvider ? { gasLimit: 2_000_000n } : {};

                if (summaryState.tapEnabled) {
                    // Calculate tap config
                    const tapAllowanceNum = summaryState.raise * summaryState.tapPct / 100;
                    const tapAllowance = ethers.parseUnits(tapAllowanceNum.toFixed(tributeToken.decimals), tributeToken.decimals);
                    // Convert months to seconds (avg 30.44 days/month)
                    const secondsPerMonth = 2629746n;
                    const durationSeconds = secondsPerMonth * BigInt(summaryState.tapMonths);
                    const ratePerSec = tapAllowance / durationSeconds;

                    const tapConfig = {
                        ops: connectedAddress, // Default to summoner
                        ratePerSec: ratePerSec > 0n ? ratePerSec : 1n,
                        tapAllowance: tapAllowance
                    };

                    calldata = DAICO_IFACE.encodeFunctionData('summonDAICOWithTapCustom', [
                        summonConfig, name, symbol, contractURI, quorumBps,
                        true, DEFAULT_RENDERER, salt, initHolders, initSharesWei,
                        false, false, daicoConfig, tapConfig, customCalls
                    ]);

                    const verifyUrl = buildSwissKnifeUrl(calldata);
                    document.getElementById('summaryStatus').innerHTML = `Confirm in wallet... <a href="${verifyUrl}" target="_blank" rel="noopener" style="color: var(--cyan); opacity: 0.7; font-size: 0.85em;">verify calldata</a>`;

                    tx = await daicoContract.summonDAICOWithTapCustom(
                        summonConfig,
                        name,
                        symbol,
                        contractURI,
                        quorumBps,
                        true,
                        DEFAULT_RENDERER,
                        salt,
                        initHolders,
                        initSharesWei,
                        false,
                        false,
                        daicoConfig,
                        tapConfig,
                        customCalls,
                        txOverrides
                    );
                } else {
                    calldata = DAICO_IFACE.encodeFunctionData('summonDAICOCustom', [
                        summonConfig, name, symbol, contractURI, quorumBps,
                        true, DEFAULT_RENDERER, salt, initHolders, initSharesWei,
                        false, false, daicoConfig, customCalls
                    ]);

                    const verifyUrl = buildSwissKnifeUrl(calldata);
                    document.getElementById('summaryStatus').innerHTML = `Confirm in wallet... <a href="${verifyUrl}" target="_blank" rel="noopener" style="color: var(--cyan); opacity: 0.7; font-size: 0.85em;">verify calldata</a>`;

                    tx = await daicoContract.summonDAICOCustom(
                        summonConfig,
                        name,
                        symbol,
                        contractURI,
                        quorumBps,
                        true,
                        DEFAULT_RENDERER,
                        salt,
                        initHolders,
                        initSharesWei,
                        false,
                        false,
                        daicoConfig,
                        customCalls,
                        txOverrides
                    );
                }

                document.getElementById('summaryStatus').innerHTML = `Submitted! <a href="${getNetwork().explorer}/tx/${tx.hash}" target="_blank" rel="noopener" style="color: var(--cyan);">View tx</a>`;

                await tx.wait();

                document.getElementById('summaryStatus').innerHTML = `Launched! <a href="https://majeurdao.eth.limo/#/dao/${getNetwork().chainId}/${predictedDao}" target="_blank" rel="noopener" style="color: var(--green);">View your DAO</a>`;

                // Refresh DAICO list to show the new sale
                daicoScanTriggered = false;
                setTimeout(() => triggerDAICOScan(), 3000);

            } catch (error) {
                console.error('Launch failed:', error);

                // Check if user rejected the transaction (handle various wallet error formats)
                if (isUserRejection(error)) {
                    document.getElementById('summaryStatus').textContent = '';
                } else {
                    document.getElementById('summaryStatus').textContent = getErrorMessage(error);
                }
            } finally {
                document.getElementById('summaryLaunchBtn').disabled = false;
            }
        }

        // Initialize summary price and tap on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateSummaryPricePreview();
            updateSummaryTapDisplay();
        });

        // ==================== END SUMMARY ====================

        // ==================== DAICO SCANNER ====================

        // ABIs for scanning
        const MULTICALL3_ABI = [
            'function aggregate3(tuple(address target, bool allowFailure, bytes callData)[] calls) view returns (tuple(bool success, bytes returnData)[])'
        ];

        // VIEW_HELPER_ABI - scanDAICOs returns all DAOs with active sales in one batched call
        const VIEW_HELPER_ABI = [
            // scanDAICOs - efficient batched scan for DAOs with active sales
            {
                "inputs": [
                    {"internalType": "uint256", "name": "daoStart", "type": "uint256"},
                    {"internalType": "uint256", "name": "daoCount", "type": "uint256"},
                    {"internalType": "address[]", "name": "tribTokens", "type": "address[]"}
                ],
                "name": "scanDAICOs",
                "outputs": [{
                    "components": [
                        {"internalType": "address", "name": "dao", "type": "address"},
                        {"components": [
                            {"internalType": "string", "name": "name", "type": "string"},
                            {"internalType": "string", "name": "symbol", "type": "string"},
                            {"internalType": "string", "name": "contractURI", "type": "string"},
                            {"internalType": "address", "name": "sharesToken", "type": "address"},
                            {"internalType": "address", "name": "lootToken", "type": "address"},
                            {"internalType": "address", "name": "badgesToken", "type": "address"},
                            {"internalType": "address", "name": "renderer", "type": "address"}
                        ], "internalType": "struct DAOMeta", "name": "meta", "type": "tuple"},
                        {"components": [
                            {"internalType": "address", "name": "tribTkn", "type": "address"},
                            {"internalType": "uint256", "name": "tribAmt", "type": "uint256"},
                            {"internalType": "uint256", "name": "forAmt", "type": "uint256"},
                            {"internalType": "address", "name": "forTkn", "type": "address"},
                            {"internalType": "uint40", "name": "deadline", "type": "uint40"},
                            {"internalType": "uint256", "name": "remainingSupply", "type": "uint256"},
                            {"internalType": "uint256", "name": "totalSupply", "type": "uint256"},
                            {"internalType": "uint256", "name": "treasuryBalance", "type": "uint256"},
                            {"internalType": "uint256", "name": "allowance", "type": "uint256"},
                            {"internalType": "uint16", "name": "lpBps", "type": "uint16"},
                            {"internalType": "uint16", "name": "maxSlipBps", "type": "uint16"},
                            {"internalType": "uint256", "name": "feeOrHook", "type": "uint256"}
                        ], "internalType": "struct SaleView[]", "name": "sales", "type": "tuple[]"},
                        {"components": [
                            {"internalType": "address", "name": "ops", "type": "address"},
                            {"internalType": "address", "name": "tribTkn", "type": "address"},
                            {"internalType": "uint128", "name": "ratePerSec", "type": "uint128"},
                            {"internalType": "uint64", "name": "lastClaim", "type": "uint64"},
                            {"internalType": "uint256", "name": "claimable", "type": "uint256"},
                            {"internalType": "uint256", "name": "pending", "type": "uint256"},
                            {"internalType": "uint256", "name": "treasuryBalance", "type": "uint256"},
                            {"internalType": "uint256", "name": "tapAllowance", "type": "uint256"}
                        ], "internalType": "struct TapView", "name": "tap", "type": "tuple"}
                    ],
                    "internalType": "struct DAICOView[]",
                    "name": "daicos",
                    "type": "tuple[]"
                }],
                "stateMutability": "view",
                "type": "function"
            },
            // getDAICO - single DAO DAICO data
            {
                "inputs": [
                    {"internalType": "address", "name": "dao", "type": "address"},
                    {"internalType": "address[]", "name": "tribTokens", "type": "address[]"}
                ],
                "name": "getDAICO",
                "outputs": [{
                    "components": [
                        {"internalType": "address", "name": "dao", "type": "address"},
                        {"components": [
                            {"internalType": "string", "name": "name", "type": "string"},
                            {"internalType": "string", "name": "symbol", "type": "string"},
                            {"internalType": "string", "name": "contractURI", "type": "string"},
                            {"internalType": "address", "name": "sharesToken", "type": "address"},
                            {"internalType": "address", "name": "lootToken", "type": "address"},
                            {"internalType": "address", "name": "badgesToken", "type": "address"},
                            {"internalType": "address", "name": "renderer", "type": "address"}
                        ], "internalType": "struct DAOMeta", "name": "meta", "type": "tuple"},
                        {"components": [
                            {"internalType": "address", "name": "tribTkn", "type": "address"},
                            {"internalType": "uint256", "name": "tribAmt", "type": "uint256"},
                            {"internalType": "uint256", "name": "forAmt", "type": "uint256"},
                            {"internalType": "address", "name": "forTkn", "type": "address"},
                            {"internalType": "uint40", "name": "deadline", "type": "uint40"},
                            {"internalType": "uint256", "name": "remainingSupply", "type": "uint256"},
                            {"internalType": "uint256", "name": "totalSupply", "type": "uint256"},
                            {"internalType": "uint256", "name": "treasuryBalance", "type": "uint256"},
                            {"internalType": "uint256", "name": "allowance", "type": "uint256"},
                            {"internalType": "uint16", "name": "lpBps", "type": "uint16"},
                            {"internalType": "uint16", "name": "maxSlipBps", "type": "uint16"},
                            {"internalType": "uint256", "name": "feeOrHook", "type": "uint256"}
                        ], "internalType": "struct SaleView[]", "name": "sales", "type": "tuple[]"},
                        {"components": [
                            {"internalType": "address", "name": "ops", "type": "address"},
                            {"internalType": "address", "name": "tribTkn", "type": "address"},
                            {"internalType": "uint128", "name": "ratePerSec", "type": "uint128"},
                            {"internalType": "uint64", "name": "lastClaim", "type": "uint64"},
                            {"internalType": "uint256", "name": "claimable", "type": "uint256"},
                            {"internalType": "uint256", "name": "pending", "type": "uint256"},
                            {"internalType": "uint256", "name": "treasuryBalance", "type": "uint256"},
                            {"internalType": "uint256", "name": "tapAllowance", "type": "uint256"}
                        ], "internalType": "struct TapView", "name": "tap", "type": "tuple"}
                    ],
                    "internalType": "struct DAICOView",
                    "name": "",
                    "type": "tuple"
                }],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const DAICO_SCANNER_ABI = [
            'function sales(address dao, address tribTkn) view returns (uint256 tribAmt, uint256 forAmt, address forTkn, uint40 deadline)',
            'function taps(address dao) view returns (address ops, address tribTkn, uint128 ratePerSec, uint64 lastClaim)',
            'function lpConfigs(address dao, address tribTkn) view returns (uint16 lpBps, uint16 maxSlipBps, uint256 feeOrHook)',
            'function claimableTap(address dao) view returns (uint256)'
        ];

        // Minimal ABI for direct DAO queries (used by fetchAndOpenDAO for deep links)
        const MOLOCH_SCANNER_ABI = [
            'function name(uint256) view returns (string)',
            'function symbol(uint256) view returns (string)',
            'function sharesToken() view returns (address)',
            'function lootToken() view returns (address)'
        ];

        const ERC20_ABI = [
            'function balanceOf(address) view returns (uint256)',
            'function totalSupply() view returns (uint256)'
        ];

        // Multicall3 getEthBalance interface (reused for performance)
        const MULTICALL3_ETH_BALANCE_IFACE = new ethers.Interface(['function getEthBalance(address) view returns (uint256)']);

        // Scanner state
        let activeDAICOs = [];
        let completedDAICOs = [];
        let currentSaleTab = 'active';

        // Helper to add gas limit override for WalletConnect transactions
        // WalletConnect's RPC can fail gas estimation, so we provide a fixed limit
        // Using 1M as a safe upper bound - mobile wallet will refine the actual gas needed
        function getWalletConnectTxOverrides(baseOptions = {}) {
            if (walletConnectProvider) {
                return { ...baseOptions, gasLimit: 1_000_000n };
            }
            return baseOptions;
        }

        // Initialize and return an RPC provider for read-only calls (quotes, deep links)
        // Tries connected wallet provider first, then falls back to public RPCs
        async function initScanner() {
            const network = getNetwork();

            // Try connected wallet provider first (if not WalletConnect)
            if (provider && !walletConnectProvider) {
                return provider;
            }

            // Try each public RPC until one works
            for (const rpc of network.rpcs) {
                try {
                    const rpcProvider = new ethers.JsonRpcProvider(rpc);
                    // Quick test to ensure RPC is responsive
                    await rpcProvider.getBlockNumber();
                    return rpcProvider;
                } catch (e) {
                    console.warn(`RPC ${rpc} failed:`, e.message);
                    // Continue to next RPC
                }
            }

            console.error('All RPC endpoints failed - check network connection');
            return null;
        }

        // Execute a scan function with RPC fallback
        // Tries connected provider first, then each public RPC until one succeeds
        async function withRpcFallback(scanFn) {
            const network = getNetwork();

            // Try connected wallet provider first (if not WalletConnect)
            if (provider && !walletConnectProvider) {
                try {
                    return await scanFn(provider);
                } catch (e) {
                    console.warn('Connected provider scan failed, trying public RPCs:', e.message);
                }
            }

            // Try each public RPC until one works
            for (const rpc of network.rpcs) {
                try {
                    const rpcProvider = new ethers.JsonRpcProvider(rpc);
                    return await scanFn(rpcProvider);
                } catch (e) {
                    console.warn(`RPC ${rpc} failed:`, e.message);
                    // Continue to next RPC
                }
            }

            throw new Error('All RPC endpoints failed - check network connection');
        }

        // Scan for active DAICOs using the view helper's efficient batched scanDAICOs function
        // This replaces 3 RPC calls with a single call that batches all queries on-chain
        async function scanActiveDAICOs() {
            // Get tribute tokens for current network
            const tribTokens = getNetwork().treasuryTokens;

            // Use RPC fallback to ensure reliability
            const daicoResults = await withRpcFallback(async (scanProvider) => {
                const viewHelper = new ethers.Contract(MOLOCH_VIEW_HELPER, VIEW_HELPER_ABI, scanProvider);
                // Single efficient call - view helper batches all DAICO queries internally:
                // - Scans all DAOs for active sales
                // - Gets sales terms, remaining supply, total supply, treasury balance, allowance
                // - Gets tap config with claimable/pending amounts
                // - Returns only DAOs with active sales (filters on-chain)
                return await viewHelper.scanDAICOs(0, 100, tribTokens);
            });

            // Transform view helper results to our internal format
            const daosWithSales = daicoResults.map(daico => ({
                dao: daico.dao,
                name: daico.meta.name,
                symbol: daico.meta.symbol,
                contractURI: daico.meta.contractURI,
                sharesToken: daico.meta.sharesToken,
                lootToken: daico.meta.lootToken,
                metadata: parseContractURI(daico.meta.contractURI),
                sales: daico.sales.map(sale => ({
                    tribTkn: sale.tribTkn,
                    tribAmt: sale.tribAmt,
                    forAmt: sale.forAmt,
                    forTkn: sale.forTkn,
                    deadline: Number(sale.deadline),
                    remainingSupply: sale.remainingSupply,
                    totalSupply: sale.totalSupply,
                    treasuryBalance: sale.treasuryBalance,
                    allowance: sale.allowance,
                    lpBps: Number(sale.lpBps),
                    maxSlipBps: Number(sale.maxSlipBps),
                    feeOrHook: sale.feeOrHook
                })),
                tap: daico.tap.ops !== ethers.ZeroAddress && daico.tap.ratePerSec > 0n ? {
                    ops: daico.tap.ops,
                    tribTkn: daico.tap.tribTkn,
                    ratePerSec: daico.tap.ratePerSec,
                    lastClaim: Number(daico.tap.lastClaim),
                    claimable: daico.tap.claimable,
                    pending: daico.tap.pending,
                    treasuryBalance: daico.tap.treasuryBalance,
                    tapAllowance: daico.tap.tapAllowance
                } : null,
                claimableTap: daico.tap.claimable || 0n,
                ethBalance: daico.tap.tribTkn === ethers.ZeroAddress ? daico.tap.treasuryBalance : 0n
            }));

            if (daosWithSales.length === 0) return [];

            const currentTime = Math.floor(Date.now() / 1000);

            // Separate active and completed sales
            activeDAICOs = daosWithSales.filter(d =>
                d.sales.some(s => {
                    const hasSupply = s.remainingSupply && s.remainingSupply > 0n;
                    const notExpired = s.deadline === 0 || s.deadline > currentTime;
                    return hasSupply && notExpired;
                })
            );

            completedDAICOs = daosWithSales.filter(d =>
                d.sales.some(s => {
                    const soldOut = !s.remainingSupply || s.remainingSupply === 0n;
                    const expired = s.deadline > 0 && s.deadline <= currentTime;
                    return soldOut || expired;
                })
            ).filter(d => !activeDAICOs.includes(d)); // Exclude if also active

            return activeDAICOs;
        }

        // Tab switching for sales
        function showSaleTab(tab) {
            currentSaleTab = tab;

            // Update tab UI
            document.getElementById('activeTab').classList.toggle('active', tab === 'active');
            document.getElementById('completedTab').classList.toggle('active', tab === 'completed');

            // Render appropriate list
            renderDAICOs();
        }

        // Update tab counts
        function updateTabCounts() {
            const activeCount = document.getElementById('activeCount');
            const completedCount = document.getElementById('completedCount');
            if (activeCount) activeCount.textContent = activeDAICOs.length > 0 ? `(${activeDAICOs.length})` : '';
            if (completedCount) completedCount.textContent = completedDAICOs.length > 0 ? `(${completedDAICOs.length})` : '';
        }

        // Render DAICOs based on current tab
        function renderDAICOs() {
            const container = document.getElementById('activeDaicosList');
            if (!container) return;

            const daicos = currentSaleTab === 'active' ? activeDAICOs : completedDAICOs;

            if (daicos.length === 0) {
                const msg = currentSaleTab === 'active'
                    ? 'No active sales found. Be the first to launch one!'
                    : 'No completed sales yet.';
                container.innerHTML = `<div class="no-daicos">${msg}</div>`;
                return;
            }

            const now = Math.floor(Date.now() / 1000);

            container.innerHTML = daicos.map(daoData => {
                // Use first active sale for display
                const sale = daoData.sales[0];
                const tribInfo = COMMON_TRIB_TOKENS[sale.tribTkn] || { symbol: '???', decimals: 18 };

                // Calculate price per token
                const tribAmtNum = Number(ethers.formatUnits(sale.tribAmt, tribInfo.decimals));
                const forAmtNum = Number(ethers.formatEther(sale.forAmt));
                const pricePerToken = tribAmtNum / forAmtNum;
                const pricePerMillion = pricePerToken * 1_000_000;

                // Remaining supply (tokens available for purchase)
                const remainingNum = Number(ethers.formatEther(sale.remainingSupply || 0n));

                // Treasury balance = amount raised (tribute tokens received by DAO)
                const treasuryNum = sale.treasuryBalance
                    ? Number(ethers.formatUnits(sale.treasuryBalance, tribInfo.decimals))
                    : 0;

                // For progress visualization, we'll show treasury raised
                // This is accurate: all tribute goes to DAO treasury
                // We don't know the "target" without event indexing, so we show absolute raised

                // Time remaining with readable date
                let timeRemaining = '';
                if (sale.deadline > 0) {
                    const secsLeft = sale.deadline - now;
                    if (secsLeft > 0) {
                        const deadlineDate = new Date(sale.deadline * 1000);
                        const dateStr = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const days = Math.floor(secsLeft / 86400);
                        const hours = Math.floor((secsLeft % 86400) / 3600);
                        const countdown = days > 0 ? `${days}d ${hours}h` : `${hours}h`;
                        timeRemaining = `Ends ${dateStr} (${countdown})`;
                    } else {
                        timeRemaining = 'Ended';
                    }
                } else {
                    timeRemaining = 'No deadline';
                }

                // Determine if selling shares or loot
                const isLoot = sale.forTkn.toLowerCase() === daoData.lootToken?.toLowerCase();
                const tokenType = isLoot ? 'Loot' : 'Shares';

                // Tap info (could be ETH or ERC20)
                let tapHtml = '';
                if (daoData.tap && daoData.claimableTap > 0n) {
                    const tapTribInfo = COMMON_TRIB_TOKENS[daoData.tap.tribTkn] || { symbol: 'ETH', decimals: 18 };
                    const claimableAmt = Number(ethers.formatUnits(daoData.claimableTap, tapTribInfo.decimals)).toFixed(4);
                    tapHtml = `<div class="daico-tap">TAP: ${claimableAmt} ${tapTribInfo.symbol} claimable</div>`;
                }

                // Render DAO image/logo from contractURI metadata
                const imageHtml = renderDaoImage(daoData.metadata, daoData.name);

                // Format raised amount
                const raisedStr = treasuryNum >= 1
                    ? treasuryNum.toFixed(2)
                    : treasuryNum >= 0.0001
                        ? treasuryNum.toFixed(4)
                        : treasuryNum.toFixed(6);

                // Get tribute token icon for visual display
                const tribIcon = getTokenIcon(sale.tribTkn);

                // Determine completion status
                const isSoldOut = remainingNum <= 0;
                const isExpired = sale.deadline > 0 && sale.deadline <= now;
                const isCompleted = isSoldOut || isExpired;

                // Calculate progress percentage
                const totalSupplyNum = sale.totalSupply ? Number(ethers.formatEther(sale.totalSupply)) : 0;
                const soldNum = totalSupplyNum > 0 ? totalSupplyNum - remainingNum : 0;
                const progressPct = totalSupplyNum > 0 ? Math.min((soldNum / totalSupplyNum) * 100, 100) : 0;

                // Status badge for completed sales
                let statusBadge = '';
                if (isCompleted) {
                    if (isSoldOut) {
                        statusBadge = '<div class="sale-status-badge sold-out">Sold Out</div>';
                    } else if (isExpired) {
                        statusBadge = '<div class="sale-status-badge ended">Ended</div>';
                    }
                }

                // Detect template type from on-chain config
                const hasTap = daoData.tap && daoData.tap.ratePerSec > 0n;
                const detectedTemplate = detectDAICOTemplate(sale, { isLoot, hasTap });
                let templateBadgeHtml = '';
                if (detectedTemplate && DAICO_TEMPLATES[detectedTemplate]) {
                    const tmpl = DAICO_TEMPLATES[detectedTemplate];
                    templateBadgeHtml = `<div class="daico-template-badge ${detectedTemplate}">${tmpl.name}</div>`;
                }

                // Progress bar HTML
                const progressHtml = totalSupplyNum > 0 ? `
                    <div class="daico-progress ${isSoldOut ? 'sold-out' : ''}">
                        <div class="daico-progress-bar" style="width: ${progressPct}%"></div>
                        <div class="daico-progress-text">${progressPct.toFixed(1)}% sold</div>
                    </div>
                    <div class="daico-progress-labels">
                        <span class="progress-sold">${soldNum.toLocaleString()} sold</span>
                        <span class="progress-total">${totalSupplyNum.toLocaleString()} total</span>
                    </div>
                ` : '';

                return `
                    <div class="daico-card ${isCompleted ? 'completed' : ''}" onclick="openDAICODetail('${daoData.dao}', '${sale.tribTkn}')">
                        ${templateBadgeHtml}
                        ${statusBadge}
                        <div class="daico-card-content">
                            ${imageHtml}
                            <div class="daico-info">
                                <div class="daico-header">
                                    <div class="daico-name">${escapeHtml(daoData.name || 'Unknown DAO')}</div>
                                    <div class="daico-symbol">${escapeHtml(daoData.symbol || '???')}</div>
                                </div>
                                <div class="daico-price">
                                    <span class="daico-trib-icon">${tribIcon}</span>
                                    ${pricePerMillion.toFixed(6)} ${tribInfo.symbol} / 1M ${tokenType}
                                </div>
                                ${progressHtml}
                                <div class="daico-stats">
                                    <span class="daico-raised">
                                        <span class="daico-trib-icon-sm">${tribIcon}</span>
                                        ${raisedStr} ${tribInfo.symbol} raised
                                    </span>
                                    <span>${remainingNum.toLocaleString()} ${tokenType} left</span>
                                </div>
                                <div class="daico-deadline">${timeRemaining}</div>
                                ${tapHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load active DAICOs on scroll into view
        let daicoScanTriggered = false;
        async function triggerDAICOScan() {
            if (daicoScanTriggered) return;
            daicoScanTriggered = true;

            const container = document.getElementById('activeDaicosList');
            if (container) {
                container.innerHTML = '<div class="daico-loading">Scanning for active DAICOs...</div>';
            }

            try {
                await scanActiveDAICOs();
                updateTabCounts();
                renderDAICOs();
            } catch (error) {
                console.error('DAICO scan failed:', error);
                if (container) {
                    container.innerHTML = '<div class="no-daicos">Failed to load DAICOs. Please refresh.</div>';
                }
            }
        }

        // ==================== END SCANNER ====================

        // ==================== PURCHASE MODAL ====================

        // Extended ABIs for purchasing
        const DAICO_PURCHASE_ABI = [
            'function quoteBuy(address dao, address tribTkn, uint256 payAmt) view returns (uint256 buyAmt)',
            'function quotePayExactOut(address dao, address tribTkn, uint256 buyAmt) view returns (uint256 payAmt)',
            'function buy(address dao, address tribTkn, uint256 payAmt, uint256 minBuyAmt) payable',
            'function buyExactOut(address dao, address tribTkn, uint256 buyAmt, uint256 maxPayAmt) payable',
            'function claimTap(address dao)'
        ];

        const ERC20_FULL_ABI = [
            'function balanceOf(address) view returns (uint256)',
            'function allowance(address owner, address spender) view returns (uint256)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function decimals() view returns (uint8)',
            'function symbol() view returns (string)'
        ];

        // Purchase state
        let currentPurchase = {
            dao: null,
            tribTkn: null,
            sale: null,
            daoData: null,
            slippage: 0.5, // 0.5%
            inputMode: 'pay', // 'pay' or 'receive'
            payBalance: 0n,
            allowance: 0n
        };

        let quoteDebounce = null;

        function openPurchaseModal(dao, tribTkn) {
            // Find DAO data from scanned results (check both active and completed)
            let daoData = activeDAICOs.find(d => d.dao.toLowerCase() === dao.toLowerCase());
            if (!daoData) {
                daoData = completedDAICOs.find(d => d.dao.toLowerCase() === dao.toLowerCase());
            }
            if (!daoData) {
                console.error('DAO not found in scanned data');
                return;
            }

            const sale = daoData.sales.find(s => s.tribTkn.toLowerCase() === tribTkn.toLowerCase());
            if (!sale) {
                console.error('Sale not found');
                return;
            }

            currentPurchase = {
                dao,
                tribTkn,
                sale,
                daoData,
                slippage: 0.5,
                inputMode: 'pay',
                payBalance: 0n,
                allowance: 0n
            };

            // Update modal UI
            document.getElementById('purchaseDaoName').textContent = daoData.name || 'Buy Tokens';

            // Show description from contractURI metadata if present
            const descEl = document.getElementById('purchaseDescription');
            if (daoData.metadata && daoData.metadata.description) {
                descEl.textContent = daoData.metadata.description;
                descEl.style.display = 'block';
            } else {
                descEl.style.display = 'none';
            }

            // Sale info
            const tribInfo = COMMON_TRIB_TOKENS[tribTkn] || { symbol: '???', decimals: 18 };
            const isLoot = sale.forTkn.toLowerCase() === daoData.lootToken?.toLowerCase();

            // Show template badge if detected
            const hasTap = daoData.tap && daoData.tap.ratePerSec > 0n;
            const detectedTemplate = detectDAICOTemplate(sale, { isLoot, hasTap });
            const templateBadgeEl = document.getElementById('purchaseTemplateBadge');
            if (detectedTemplate && DAICO_TEMPLATES[detectedTemplate]) {
                const tmpl = DAICO_TEMPLATES[detectedTemplate];
                templateBadgeEl.textContent = tmpl.name;
                templateBadgeEl.className = `daico-template-badge ${detectedTemplate}`;
                templateBadgeEl.style.display = 'inline-block';
                templateBadgeEl.style.position = 'static';
                templateBadgeEl.style.marginLeft = '0.5rem';
            } else {
                templateBadgeEl.style.display = 'none';
            }
            const tokenType = isLoot ? 'Loot' : 'Shares';

            const remainingNum = Number(ethers.formatEther(sale.remainingSupply || 0n));
            document.getElementById('purchaseRemaining').textContent = remainingNum.toLocaleString() + ' ' + tokenType;

            // Deadline with readable date
            const now = Math.floor(Date.now() / 1000);
            if (sale.deadline > 0) {
                const secsLeft = sale.deadline - now;
                if (secsLeft > 0) {
                    const deadlineDate = new Date(sale.deadline * 1000);
                    const dateStr = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const timeStr = deadlineDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const days = Math.floor(secsLeft / 86400);
                    const hours = Math.floor((secsLeft % 86400) / 3600);
                    const countdown = days > 0 ? `${days}d ${hours}h` : `${hours}h`;
                    document.getElementById('purchaseDeadline').textContent = `${dateStr} ${timeStr} (${countdown} left)`;
                } else {
                    document.getElementById('purchaseDeadline').textContent = 'Ended';
                }
            } else {
                document.getElementById('purchaseDeadline').textContent = 'No deadline';
            }

            // Price
            const tribAmtNum = Number(ethers.formatUnits(sale.tribAmt, tribInfo.decimals));
            const forAmtNum = Number(ethers.formatEther(sale.forAmt));
            const pricePerMillion = (tribAmtNum / forAmtNum) * 1_000_000;
            document.getElementById('purchasePrice').textContent = `${pricePerMillion.toFixed(6)} ${tribInfo.symbol} / 1M ${tokenType}`;

            // Progress bar - calculate sold vs total
            const totalSupplyNum = sale.totalSupply ? Number(ethers.formatEther(sale.totalSupply)) : 0;
            const soldNum = totalSupplyNum > 0 ? totalSupplyNum - remainingNum : 0;
            const progressPct = totalSupplyNum > 0 ? Math.min((soldNum / totalSupplyNum) * 100, 100) : 0;
            const isSoldOut = remainingNum <= 0;

            document.getElementById('purchaseProgressBar').style.width = `${progressPct}%`;
            document.getElementById('purchaseProgressText').textContent = `${progressPct.toFixed(1)}% sold`;
            document.getElementById('purchaseProgressSold').textContent = `${soldNum.toLocaleString()} ${tokenType} sold`;
            document.getElementById('purchaseProgressRemaining').textContent = `${remainingNum.toLocaleString()} remaining`;

            // Update progress bar styling for sold out
            const progressEl = document.getElementById('purchaseProgress');
            if (isSoldOut) {
                progressEl.classList.add('sold-out');
            } else {
                progressEl.classList.remove('sold-out');
            }

            // Token displays
            document.getElementById('payTokenIcon').innerHTML = getTokenIcon(tribTkn);
            document.getElementById('payTokenSymbol').textContent = tribInfo.symbol;
            document.getElementById('receiveTokenIcon').innerHTML = isLoot ? TOKEN_ICONS.loot : TOKEN_ICONS.shares;
            document.getElementById('receiveTokenSymbol').textContent = tokenType.toUpperCase();
            document.getElementById('receiveAvailable').textContent = remainingNum.toLocaleString();

            // Tap section with real-time accrual
            // Show if tap is configured (ratePerSec > 0) even if nothing claimable yet
            if (daoData.tap && daoData.tap.ratePerSec > 0n) {
                document.getElementById('tapSection').style.display = 'block';

                // Get tap token info (could be ETH or ERC20)
                const tapTribTkn = daoData.tap.tribTkn;
                const tapTribInfo = COMMON_TRIB_TOKENS[tapTribTkn] || { symbol: 'ETH', decimals: 18 };

                // Store tap state for real-time updates
                currentPurchase.tapInfo = {
                    baseClaimable: daoData.claimableTap || 0n,
                    ratePerSec: daoData.tap.ratePerSec,
                    tribTkn: tapTribTkn,
                    symbol: tapTribInfo.symbol,
                    decimals: tapTribInfo.decimals,
                    startTime: Date.now()
                };

                // Initial display
                updateTapDisplay();

                // Start real-time accrual (update every 100ms for smooth ticking)
                startTapAccrual();

                // Display ops address with ENS reverse lookup
                const opsDisplay = document.getElementById('tapOpsDisplay');
                const shortOps = daoData.tap.ops.slice(0, 6) + '...' + daoData.tap.ops.slice(-4);
                opsDisplay.textContent = shortOps;
                // Try reverse ENS lookup (async, update when ready)
                provider.lookupAddress(daoData.tap.ops).then(ensName => {
                    if (ensName) {
                        opsDisplay.textContent = ensName;
                    }
                }).catch(() => {}); // Silently ignore ENS lookup failures

                // Only show claim button if user is ops
                if (connectedAddress && daoData.tap.ops.toLowerCase() === connectedAddress.toLowerCase()) {
                    document.getElementById('claimTapBtn').style.display = 'block';
                } else {
                    document.getElementById('claimTapBtn').style.display = 'none';
                }
            } else {
                document.getElementById('tapSection').style.display = 'none';
                stopTapAccrual();
            }

            // Majeur link
            document.getElementById('majeurLink').href = `https://majeurdao.eth.limo/#/dao/${getNetwork().chainId}/${dao}`;

            // Clear inputs
            document.getElementById('payAmountInput').value = '';
            document.getElementById('receiveAmountInput').value = '';

            // Update button state
            updatePurchaseButton();
            loadUserBalances();

            // Show modal
            document.getElementById('purchaseModal').style.display = 'flex';
        }

        function closePurchaseModal() {
            stopTapAccrual();
            clearTimeout(quoteDebounce); // Clear any pending quote requests
            clearUrlHash();
            document.getElementById('purchaseModal').style.display = 'none';
            currentPurchase = { dao: null, tribTkn: null, sale: null, daoData: null, slippage: 0.5, inputMode: 'pay', payBalance: 0n, allowance: 0n, tapInfo: null };
        }

        async function loadUserBalances() {
            if (!signer || !currentPurchase.dao) return;

            const tribInfo = COMMON_TRIB_TOKENS[currentPurchase.tribTkn] || { symbol: '???', decimals: 18 };

            try {
                if (currentPurchase.tribTkn === ethers.ZeroAddress) {
                    // ETH balance
                    const balance = await provider.getBalance(connectedAddress);
                    currentPurchase.payBalance = balance;
                    currentPurchase.allowance = ethers.MaxUint256; // No approval needed for ETH
                    document.getElementById('payBalance').textContent = Number(ethers.formatEther(balance)).toFixed(4) + ' ETH';
                } else {
                    // ERC20 balance and allowance
                    const token = new ethers.Contract(currentPurchase.tribTkn, ERC20_FULL_ABI, provider);
                    const [balance, allowance] = await Promise.all([
                        token.balanceOf(connectedAddress),
                        token.allowance(connectedAddress, DAICO_ADDRESS)
                    ]);
                    currentPurchase.payBalance = balance;
                    currentPurchase.allowance = allowance;
                    document.getElementById('payBalance').textContent = Number(ethers.formatUnits(balance, tribInfo.decimals)).toFixed(4) + ' ' + tribInfo.symbol;
                }

                updatePurchaseButton();
            } catch (e) {
                console.error('Failed to load balances:', e);
            }
        }

        function setSlippage(pct, btn) {
            currentPurchase.slippage = pct;
            btn.parentElement.querySelectorAll('.slippage-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setMaxPay() {
            if (!currentPurchase.payBalance || currentPurchase.payBalance === 0n) return;

            const tribInfo = COMMON_TRIB_TOKENS[currentPurchase.tribTkn] || { decimals: 18 };
            let maxAmt = currentPurchase.payBalance;

            // Reserve some ETH for gas if paying with ETH
            if (currentPurchase.tribTkn === ethers.ZeroAddress) {
                const gasReserve = ethers.parseEther('0.01');
                if (maxAmt > gasReserve) {
                    maxAmt = maxAmt - gasReserve;
                }
            }

            // Clip to the cost of remaining supply if user balance would exceed it
            const sale = currentPurchase.sale;
            if (sale && sale.remainingSupply && sale.remainingSupply > 0n && sale.tribAmt > 0n && sale.forAmt > 0n) {
                // Cost to buy all remaining = (remainingSupply * tribAmt) / forAmt
                const costForRemaining = (sale.remainingSupply * sale.tribAmt) / sale.forAmt;
                if (costForRemaining < maxAmt) {
                    maxAmt = costForRemaining;
                }
            }

            const formatted = Number(ethers.formatUnits(maxAmt, tribInfo.decimals));
            document.getElementById('payAmountInput').value = formatted.toString();
            currentPurchase.inputMode = 'pay';
            handlePayInput();
        }

        async function handlePayInput() {
            currentPurchase.inputMode = 'pay';
            const payStr = document.getElementById('payAmountInput').value.trim();
            if (!payStr || isNaN(parseFloat(payStr)) || parseFloat(payStr) <= 0) {
                document.getElementById('receiveAmountInput').value = '';
                updatePurchaseButton();
                return;
            }

            // Debounce
            clearTimeout(quoteDebounce);
            quoteDebounce = setTimeout(() => quoteBuyAmount(payStr), 300);
        }

        async function handleReceiveInput() {
            currentPurchase.inputMode = 'receive';
            const receiveStr = document.getElementById('receiveAmountInput').value.trim();
            if (!receiveStr || isNaN(parseFloat(receiveStr)) || parseFloat(receiveStr) <= 0) {
                document.getElementById('payAmountInput').value = '';
                updatePurchaseButton();
                return;
            }

            // Debounce
            clearTimeout(quoteDebounce);
            quoteDebounce = setTimeout(() => quotePayAmount(receiveStr), 300);
        }

        async function quoteBuyAmount(payStr) {
            if (!currentPurchase.dao) return;

            const tribInfo = COMMON_TRIB_TOKENS[currentPurchase.tribTkn] || { decimals: 18 };

            try {
                // Ensure scanner is initialized for quotes without wallet connection
                const rpcProvider = await initScanner();
                if (!rpcProvider) return;

                const payAmt = ethers.parseUnits(payStr, tribInfo.decimals);
                const daicoContract = new ethers.Contract(DAICO_ADDRESS, DAICO_PURCHASE_ABI, rpcProvider);
                const buyAmt = await daicoContract.quoteBuy(currentPurchase.dao, currentPurchase.tribTkn, payAmt);

                if (buyAmt > 0n) {
                    document.getElementById('receiveAmountInput').value = Number(ethers.formatEther(buyAmt)).toFixed(4);
                } else {
                    document.getElementById('receiveAmountInput').value = '';
                }
            } catch (e) {
                console.error('Quote failed:', e);
                document.getElementById('receiveAmountInput').value = '';
            }

            updatePurchaseButton();
        }

        async function quotePayAmount(receiveStr) {
            if (!currentPurchase.dao) return;

            const tribInfo = COMMON_TRIB_TOKENS[currentPurchase.tribTkn] || { decimals: 18 };

            try {
                // Ensure scanner is initialized for quotes without wallet connection
                const rpcProvider = await initScanner();
                if (!rpcProvider) return;

                const buyAmt = ethers.parseEther(receiveStr);
                const daicoContract = new ethers.Contract(DAICO_ADDRESS, DAICO_PURCHASE_ABI, rpcProvider);
                const payAmt = await daicoContract.quotePayExactOut(currentPurchase.dao, currentPurchase.tribTkn, buyAmt);

                if (payAmt > 0n) {
                    document.getElementById('payAmountInput').value = Number(ethers.formatUnits(payAmt, tribInfo.decimals)).toFixed(6);
                } else {
                    document.getElementById('payAmountInput').value = '';
                }
            } catch (e) {
                console.error('Quote failed:', e);
                document.getElementById('payAmountInput').value = '';
            }

            updatePurchaseButton();
        }

        function updatePurchaseButton() {
            const buyBtn = document.getElementById('buyBtn');
            const approveBtn = document.getElementById('approveBtn');

            // Check if sale is completed (expired or sold out)
            const now = Math.floor(Date.now() / 1000);
            const sale = currentPurchase.sale;
            const isExpired = sale && sale.deadline > 0 && sale.deadline <= now;
            const isSoldOut = sale && (!sale.remainingSupply || sale.remainingSupply === 0n);

            if (isExpired) {
                buyBtn.textContent = 'Sale Ended';
                buyBtn.disabled = true;
                approveBtn.style.display = 'none';
                return;
            }

            if (isSoldOut) {
                buyBtn.textContent = 'Sold Out';
                buyBtn.disabled = true;
                approveBtn.style.display = 'none';
                return;
            }

            if (!signer) {
                buyBtn.textContent = 'Connect Wallet';
                buyBtn.disabled = false;
                buyBtn.onclick = () => { closePurchaseModal(); showWalletModal(); };
                approveBtn.style.display = 'none';
                return;
            }

            buyBtn.onclick = executePurchase;

            const payStr = document.getElementById('payAmountInput').value.trim();
            const receiveStr = document.getElementById('receiveAmountInput').value.trim();

            if (!payStr || isNaN(parseFloat(payStr)) || parseFloat(payStr) <= 0 || !receiveStr || isNaN(parseFloat(receiveStr)) || parseFloat(receiveStr) <= 0) {
                buyBtn.textContent = 'Enter Amount';
                buyBtn.disabled = true;
                approveBtn.style.display = 'none';
                return;
            }

            const tribInfo = COMMON_TRIB_TOKENS[currentPurchase.tribTkn] || { decimals: 18 };
            const payAmt = ethers.parseUnits(payStr, tribInfo.decimals);

            // Check balance
            if (payAmt > currentPurchase.payBalance) {
                buyBtn.textContent = 'Insufficient Balance';
                buyBtn.disabled = true;
                approveBtn.style.display = 'none';
                return;
            }

            // Check ERC20 approval
            if (currentPurchase.tribTkn !== ethers.ZeroAddress && payAmt > currentPurchase.allowance) {
                approveBtn.style.display = 'block';
                document.getElementById('approveTokenName').textContent = tribInfo.symbol;
                buyBtn.textContent = 'Buy';
                buyBtn.disabled = true;
                return;
            }

            approveBtn.style.display = 'none';
            buyBtn.textContent = 'Buy';
            buyBtn.disabled = false;
        }

        async function approveToken() {
            if (!signer || !currentPurchase.tribTkn || currentPurchase.tribTkn === ethers.ZeroAddress) return;

            const tribInfo = COMMON_TRIB_TOKENS[currentPurchase.tribTkn] || { symbol: 'TOKEN', decimals: 18 };
            const approveBtn = document.getElementById('approveBtn');

            try {
                approveBtn.disabled = true;
                approveBtn.textContent = 'Approving...';

                const token = new ethers.Contract(currentPurchase.tribTkn, ERC20_FULL_ABI, signer);
                const tx = await token.approve(DAICO_ADDRESS, ethers.MaxUint256, getWalletConnectTxOverrides());

                approveBtn.textContent = 'Confirming...';
                await tx.wait();

                currentPurchase.allowance = ethers.MaxUint256;
                updatePurchaseButton();

            } catch (e) {
                console.error('Approval failed:', e);
                if (!isUserRejection(e)) {
                    showPurchaseStatus('Approval failed', 'error');
                }
            } finally {
                approveBtn.disabled = false;
                approveBtn.innerHTML = `Approve <span id="approveTokenName">${tribInfo.symbol}</span>`;
            }
        }

        async function executePurchase() {
            if (!signer || !currentPurchase.dao) return;

            const payStr = document.getElementById('payAmountInput').value.trim();
            const receiveStr = document.getElementById('receiveAmountInput').value.trim();

            if (!payStr || !receiveStr) return;

            const tribInfo = COMMON_TRIB_TOKENS[currentPurchase.tribTkn] || { decimals: 18 };
            const buyBtn = document.getElementById('buyBtn');

            try {
                buyBtn.disabled = true;
                buyBtn.textContent = 'Preparing...';

                const daicoContract = new ethers.Contract(DAICO_ADDRESS, DAICO_PURCHASE_ABI, signer);
                const isETH = currentPurchase.tribTkn === ethers.ZeroAddress;

                let tx;
                if (currentPurchase.inputMode === 'pay') {
                    // Exact input (buy)
                    const payAmt = ethers.parseUnits(payStr, tribInfo.decimals);
                    const expectedOut = ethers.parseEther(receiveStr);
                    const slippageBps = BigInt(Math.floor(currentPurchase.slippage * 100));
                    const minOut = expectedOut * (10000n - slippageBps) / 10000n;

                    buyBtn.textContent = 'Confirm in wallet...';
                    tx = await daicoContract.buy(
                        currentPurchase.dao,
                        currentPurchase.tribTkn,
                        payAmt,
                        minOut,
                        getWalletConnectTxOverrides({ value: isETH ? payAmt : 0n })
                    );
                } else {
                    // Exact output (buyExactOut)
                    const buyAmt = ethers.parseEther(receiveStr);
                    const expectedPay = ethers.parseUnits(payStr, tribInfo.decimals);
                    const slippageBps = BigInt(Math.floor(currentPurchase.slippage * 100));
                    const maxPay = expectedPay * (10000n + slippageBps) / 10000n;

                    buyBtn.textContent = 'Confirm in wallet...';
                    tx = await daicoContract.buyExactOut(
                        currentPurchase.dao,
                        currentPurchase.tribTkn,
                        buyAmt,
                        maxPay,
                        getWalletConnectTxOverrides({ value: isETH ? maxPay : 0n })
                    );
                }

                buyBtn.textContent = 'Processing...';
                showPurchaseStatus(`Transaction submitted! <a href="${getNetwork().explorer}/tx/${tx.hash}" target="_blank" rel="noopener" style="color: var(--cyan);">View</a>`, 'info');

                await tx.wait();

                showPurchaseStatus('Purchase successful!', 'success');

                // Refresh balances
                loadUserBalances();

                // Clear inputs
                document.getElementById('payAmountInput').value = '';
                document.getElementById('receiveAmountInput').value = '';

                // Refresh DAICO list in background
                daicoScanTriggered = false;
                triggerDAICOScan();

            } catch (e) {
                console.error('Purchase failed:', e);
                if (!isUserRejection(e)) {
                    showPurchaseStatus(getErrorMessage(e), 'error');
                }
            } finally {
                buyBtn.disabled = false;
                updatePurchaseButton();
            }
        }

        // ==================== TAP REAL-TIME ACCRUAL ====================
        let tapAccrualInterval = null;

        function startTapAccrual() {
            stopTapAccrual(); // Clear any existing interval
            tapAccrualInterval = setInterval(updateTapDisplay, 500); // Update every 500ms
        }

        function stopTapAccrual() {
            if (tapAccrualInterval) {
                clearInterval(tapAccrualInterval);
                tapAccrualInterval = null;
            }
        }

        function updateTapDisplay() {
            const tapInfo = currentPurchase.tapInfo;
            if (!tapInfo) return;

            // Calculate elapsed time since modal opened (in milliseconds)
            const elapsedMs = Date.now() - tapInfo.startTime;

            // Calculate accrued amount using BigInt math to avoid precision loss
            // accruedWei = (ratePerSec * elapsedMs) / 1000
            // Using BigInt division: multiply first, then divide to minimize precision loss
            const accruedWei = (tapInfo.ratePerSec * BigInt(elapsedMs)) / 1000n;
            const totalClaimable = tapInfo.baseClaimable + accruedWei;

            // Format with more precision for the ticking effect
            const formatted = Number(ethers.formatUnits(totalClaimable, tapInfo.decimals));

            // Show more decimal places for small amounts to see the ticking
            let displayStr;
            if (formatted >= 1) {
                displayStr = formatted.toFixed(4);
            } else if (formatted >= 0.0001) {
                displayStr = formatted.toFixed(6);
            } else {
                displayStr = formatted.toFixed(8);
            }

            document.getElementById('tapClaimable').textContent = displayStr + ' ' + tapInfo.symbol;
        }

        async function claimTap() {
            if (!signer || !currentPurchase.dao || !currentPurchase.daoData?.tap) return;

            const claimBtn = document.getElementById('claimTapBtn');

            try {
                claimBtn.disabled = true;
                claimBtn.textContent = 'Claiming...';

                // Stop accrual during claim
                stopTapAccrual();

                const daicoContract = new ethers.Contract(DAICO_ADDRESS, DAICO_PURCHASE_ABI, signer);
                const tx = await daicoContract.claimTap(currentPurchase.dao, getWalletConnectTxOverrides());

                showPurchaseStatus(`Claim submitted! <a href="${getNetwork().explorer}/tx/${tx.hash}" target="_blank" rel="noopener" style="color: var(--cyan);">View</a>`, 'info');

                await tx.wait();

                showPurchaseStatus('TAP claimed successfully!', 'success');

                // Reset tap display and restart accrual from zero
                const tapTribInfo = COMMON_TRIB_TOKENS[currentPurchase.daoData.tap.tribTkn] || { symbol: 'ETH', decimals: 18 };
                currentPurchase.tapInfo = {
                    baseClaimable: 0n,
                    ratePerSec: currentPurchase.daoData.tap.ratePerSec,
                    tribTkn: currentPurchase.daoData.tap.tribTkn,
                    symbol: tapTribInfo.symbol,
                    decimals: tapTribInfo.decimals,
                    startTime: Date.now()
                };
                updateTapDisplay();
                startTapAccrual();

            } catch (e) {
                console.error('Claim failed:', e);
                if (!isUserRejection(e)) {
                    showPurchaseStatus(getErrorMessage(e), 'error');
                }
                // Restart accrual on failure (keep showing ticking)
                startTapAccrual();
            } finally {
                claimBtn.disabled = false;
                claimBtn.textContent = 'Claim TAP';
            }
        }

        function showPurchaseStatus(message, type) {
            const status = document.getElementById('purchaseStatus');
            status.innerHTML = message;
            status.className = 'status-message';
            if (type === 'error') status.classList.add('error');
            else if (type === 'success') status.classList.add('success');
            else if (type === 'info') status.classList.add('info');
            status.style.display = 'block';
        }

        // Open sale detail and update URL hash
        function openDAICODetail(dao, tribTkn) {
            // Update URL hash for deep linking
            updateUrlHash(dao, tribTkn);
            openPurchaseModal(dao, tribTkn);
        }

        // ==================== URL DEEP LINKING ====================
        // URL format: #/sale/{chainId}/{dao} or #/sale/{chainId}/{dao}/{tribToken}
        // Also supports legacy format: #/sale/0xDAO or #/sale/0xDAO/0xTribToken

        // Update URL hash when opening a sale (includes chain ID)
        function updateUrlHash(dao, tribTkn) {
            const chainId = getNetwork().chainId.toString();
            let hash = `#/sale/${chainId}/${dao}`;
            if (tribTkn && tribTkn !== ethers.ZeroAddress) {
                hash += `/${tribTkn}`;
            }
            window.history.replaceState(null, '', hash);
        }

        // Clear URL hash when closing modal
        function clearUrlHash() {
            if (window.location.hash) {
                window.history.replaceState(null, '', window.location.pathname);
            }
        }

        // Parse URL hash and open sale if specified
        // Supports: #/sale/{chainId}/0xDAO, #/sale/{chainId}/0xDAO/0xTribToken
        // Also supports legacy: #/sale/0xDAO and #/sale/0xDAO/0xTribToken
        async function handleDeepLink() {
            if (!window.location.hash) return;

            try {
                const hash = window.location.hash;

                // Try new format with chain ID: #/sale/{chainId}/0x.../0x...
                let saleMatch = hash.match(/^#\/sale\/(\d+)\/(0x[a-fA-F0-9]{40})(?:\/(0x[a-fA-F0-9]{40}))?$/);
                let linkChainId = null;
                let dao, tribTkn;

                if (saleMatch) {
                    linkChainId = saleMatch[1];
                    dao = saleMatch[2];
                    tribTkn = saleMatch[3] || ethers.ZeroAddress;
                } else {
                    // Fall back to legacy format: #/sale/0x.../0x...
                    saleMatch = hash.match(/^#\/sale\/(0x[a-fA-F0-9]{40})(?:\/(0x[a-fA-F0-9]{40}))?$/);
                    if (!saleMatch) return;
                    dao = saleMatch[1];
                    tribTkn = saleMatch[2] || ethers.ZeroAddress;
                }

                // Check if we need to switch networks
                if (linkChainId) {
                    const linkNetwork = getNetworkByChainId(BigInt(linkChainId));
                    if (linkNetwork && linkNetwork.network.chainId !== getNetwork().chainId) {
                        // Prompt user to switch networks
                        await promptNetworkSwitch(linkNetwork.key, linkNetwork.network, dao, tribTkn);
                        return; // handleDeepLink will be called again after network switch
                    }
                }

                if (!dao || !ethers.isAddress(dao)) return;

                // Wait for DAICOs to load first
                await waitForDAICOScan();

                // Find the DAO in our scanned list (check both active and completed)
                let daoData = activeDAICOs.find(d => d.dao.toLowerCase() === dao.toLowerCase());
                if (!daoData) {
                    daoData = completedDAICOs.find(d => d.dao.toLowerCase() === dao.toLowerCase());
                }

                if (daoData) {
                    // Find matching sale (by tribTkn or use first)
                    const sale = daoData.sales.find(s => s.tribTkn.toLowerCase() === tribTkn.toLowerCase())
                        || daoData.sales[0];

                    if (sale) {
                        openPurchaseModal(dao, sale.tribTkn);
                    }
                } else {
                    // DAO not in active list - try to fetch it directly
                    await fetchAndOpenDAO(dao, tribTkn);
                }
            } catch (e) {
                console.error('Deep link error:', e);
            }
        }

        // Wait for DAICO scan to complete
        function waitForDAICOScan() {
            return new Promise((resolve) => {
                if (activeDAICOs.length > 0 || completedDAICOs.length > 0 || daicoScanTriggered) {
                    // If already scanned, wait a bit for results
                    setTimeout(resolve, 500);
                } else {
                    // Trigger scan and wait
                    triggerDAICOScan().then(() => setTimeout(resolve, 500));
                }
            });
        }

        // Fetch a specific DAO directly (for deep links to DAOs not in active list)
        async function fetchAndOpenDAO(daoAddr, tribTkn) {
            try {
                // Ensure scanner is initialized for deep links without wallet
                const rpcProvider = await initScanner();
                if (!rpcProvider) return;

                const multicall = new ethers.Contract(MULTICALL3_ADDRESS, MULTICALL3_ABI, rpcProvider);
                const molochIface = new ethers.Interface(MOLOCH_SCANNER_ABI);
                const daicoIface = new ethers.Interface(DAICO_SCANNER_ABI);
                const erc20Iface = new ethers.Interface(ERC20_ABI);

                // Build calls for this specific DAO
                // Use full signature to disambiguate overloaded functions in ethers v6
                const calls = [
                    { target: daoAddr, allowFailure: true, callData: molochIface.encodeFunctionData('name(uint256)', [0]) },
                    { target: daoAddr, allowFailure: true, callData: molochIface.encodeFunctionData('symbol(uint256)', [0]) },
                    { target: daoAddr, allowFailure: true, callData: molochIface.encodeFunctionData('sharesToken', []) },
                    { target: daoAddr, allowFailure: true, callData: molochIface.encodeFunctionData('lootToken', []) },
                    { target: DAICO_ADDRESS, allowFailure: true, callData: daicoIface.encodeFunctionData('sales', [daoAddr, tribTkn]) },
                    { target: DAICO_ADDRESS, allowFailure: true, callData: daicoIface.encodeFunctionData('taps', [daoAddr]) },
                    { target: DAICO_ADDRESS, allowFailure: true, callData: daicoIface.encodeFunctionData('claimableTap', [daoAddr]) }
                ];

                const results = await multicall.aggregate3(calls);

                // Parse results
                const daoData = { dao: daoAddr, sales: [] };

                if (results[0].success) daoData.name = molochIface.decodeFunctionResult('name(uint256)', results[0].returnData)[0];
                if (results[1].success) daoData.symbol = molochIface.decodeFunctionResult('symbol(uint256)', results[1].returnData)[0];
                if (results[2].success) daoData.sharesToken = molochIface.decodeFunctionResult('sharesToken', results[2].returnData)[0];
                if (results[3].success) daoData.lootToken = molochIface.decodeFunctionResult('lootToken', results[3].returnData)[0];

                if (results[4].success) {
                    const [saleTribAmt, saleForAmt, saleForTkn, saleDeadline] = daicoIface.decodeFunctionResult('sales', results[4].returnData);
                    const now = Math.floor(Date.now() / 1000);
                    if (saleTribAmt > 0n && saleForAmt > 0n && (saleDeadline === 0 || saleDeadline > now)) {
                        const sale = { tribTkn, tribAmt: saleTribAmt, forAmt: saleForAmt, forTkn: saleForTkn, deadline: Number(saleDeadline) };

                        // Get remaining supply
                        const balanceCall = await multicall.aggregate3([
                            { target: saleForTkn, allowFailure: true, callData: erc20Iface.encodeFunctionData('balanceOf', [daoAddr]) }
                        ]);
                        if (balanceCall[0].success) {
                            sale.remainingSupply = erc20Iface.decodeFunctionResult('balanceOf', balanceCall[0].returnData)[0];
                        }

                        daoData.sales.push(sale);
                    }
                }

                if (results[5].success) {
                    const [ops, tapTribTkn, ratePerSec, lastClaim] = daicoIface.decodeFunctionResult('taps', results[5].returnData);
                    if (ops !== ethers.ZeroAddress && ratePerSec > 0n) {
                        daoData.tap = { ops, tribTkn: tapTribTkn, ratePerSec, lastClaim: Number(lastClaim) };
                    }
                }

                if (results[6].success) {
                    daoData.claimableTap = daicoIface.decodeFunctionResult('claimableTap', results[6].returnData)[0];
                }

                // Open modal if we found an active sale
                if (daoData.sales.length > 0) {
                    // Add to activeDAICOs for modal to work
                    activeDAICOs.push(daoData);
                    openPurchaseModal(daoAddr, daoData.sales[0].tribTkn);
                }

            } catch (e) {
                console.error('Failed to fetch DAO:', e);
            }
        }

        // Listen for hash changes (back/forward navigation)
        window.addEventListener('hashchange', handleDeepLink);

        // Handle deep link on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Small delay to let other initializations complete
            setTimeout(handleDeepLink, 100);
        });

        // ==================== END PURCHASE MODAL ====================

        // Form helpers
        function formatNumberInput(input) {
            let value = input.value.replace(/[^\d.]/g, '');
            const parts = value.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            input.value = parts.join('.');
        }

        function parseFormattedNumber(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/,/g, '')) || 0;
        }

        function toggleLPConfig() {
            const enabled = document.getElementById('enableLP').checked;
            document.getElementById('lpConfig').classList.toggle('show', enabled);
            document.getElementById('vizLPRow').style.display = enabled ? 'flex' : 'none';
            document.getElementById('vizLPLabel').style.display = enabled ? 'inline' : 'none';
            updateVisualization();
        }

        function toggleTapConfig() {
            const enabled = document.getElementById('enableTap').checked;
            document.getElementById('tapConfig').classList.toggle('show', enabled);
            document.getElementById('vizTapRow').style.display = enabled ? 'flex' : 'none';
            updateVisualization();
        }

        function toggleAdvanced() {
            const enabled = document.getElementById('showAdvanced').checked;
            document.getElementById('advancedConfig').classList.toggle('show', enabled);
        }

        // Update visualization based on form inputs
        function updateVisualization() {
            const name = document.getElementById('daoName').value || '--';
            const symbol = document.getElementById('daoSymbol').value || '--';
            const supply = parseFormattedNumber(document.getElementById('saleSupply').value);
            const price = parseFloat(document.getElementById('tokenPrice').value) || 0;
            const paymentToken = document.getElementById('paymentToken').value;
            const enableLP = document.getElementById('enableLP').checked;
            const lpPct = parseInt(document.getElementById('lpPct').value) || 50;
            const enableTap = document.getElementById('enableTap').checked;
            const tapRate = parseFloat(document.getElementById('tapRate').value) || 0;

            // Show/hide custom token input
            document.getElementById('customTokenGroup').style.display = paymentToken === 'custom' ? 'block' : 'none';

            // Update viz panel
            document.getElementById('vizName').textContent = name !== '--' ? `${name} (${symbol || '?'})` : '--';
            document.getElementById('vizSupply').textContent = supply > 0 ? supply.toLocaleString() + ' tokens' : '--';

            const paySymbol = paymentToken === 'eth' ? 'ETH' : 'tokens';
            document.getElementById('vizPrice').textContent = price > 0 ? `${price} ${paySymbol}` : '--';

            const totalRaise = supply * price;
            document.getElementById('vizRaise').textContent = totalRaise > 0 ? `${totalRaise.toLocaleString()} ${paySymbol}` : '--';

            // LP visualization
            if (enableLP && lpPct > 0 && lpPct < 100) {
                const lpAmount = totalRaise * (lpPct / 100);
                const treasuryAmount = totalRaise - lpAmount;
                document.getElementById('vizLP').textContent = `${lpPct}% (${lpAmount.toLocaleString()} ${paySymbol}  Liquidity)`;
                document.getElementById('vizBarSale').style.width = (100 - lpPct) + '%';
                document.getElementById('vizBarLP').style.width = lpPct + '%';
            } else {
                document.getElementById('vizLP').textContent = '--';
                document.getElementById('vizBarSale').style.width = '100%';
                document.getElementById('vizBarLP').style.width = '0%';
            }

            // Tap visualization
            if (enableTap && tapRate > 0) {
                document.getElementById('vizTap').textContent = `${tapRate} ${paySymbol}/month`;
            } else {
                document.getElementById('vizTap').textContent = '--';
            }
        }

        function showStatus(message, type = 'info') {
            const el = document.getElementById('statusMessage');
            el.className = 'status-message show ' + type;
            el.innerHTML = message;
        }

        function hideStatus() {
            document.getElementById('statusMessage').className = 'status-message';
        }

        // Launch DAICO
        async function launchDAICO() {
            if (!signer || !connectedWalletProvider) {
                showStatus('Please connect your wallet first', 'error');
                showWalletModal();
                return;
            }

            // Check network - get chainId directly from wallet provider to avoid ethers NETWORK_ERROR
            const walletChainIdHex = await connectedWalletProvider.request({ method: 'eth_chainId' });
            const walletChainId = BigInt(walletChainIdHex);
            const expectedNetwork = getNetwork();
            if (walletChainId !== expectedNetwork.chainId) {
                showStatus(`Please switch wallet to ${expectedNetwork.name}`, 'error');
                try {
                    await connectedWalletProvider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: expectedNetwork.chainIdHex }]
                    });
                    return;
                } catch (error) {
                    if (!isUserRejection(error)) {
                        console.error('Failed to switch network:', error);
                    }
                }
                return;
            }

            // Recreate provider/signer to ensure we're on the correct network
            provider = new ethers.BrowserProvider(connectedWalletProvider);
            signer = await provider.getSigner();

            // Gather form data
            const name = document.getElementById('daoName').value.trim();
            const symbol = document.getElementById('daoSymbol').value.trim().toUpperCase();
            const description = document.getElementById('daoDescription').value.trim();
            const contractURI = buildContractURI(name, symbol, description);
            const quorumPct = parseInt(document.getElementById('quorumPct').value) || 20;
            const supply = parseFormattedNumber(document.getElementById('saleSupply').value);
            const price = parseFloat(document.getElementById('tokenPrice').value) || 0;
            const paymentToken = document.getElementById('paymentToken').value;
            const customToken = document.getElementById('customTokenAddress').value.trim();
            const tokenType = document.getElementById('tokenType').value;
            const founderShares = parseFormattedNumber(document.getElementById('founderShares').value);

            const enableLP = document.getElementById('enableLP').checked;
            const lpPct = parseInt(document.getElementById('lpPct').value) || 50;
            const poolFee = parseInt(document.getElementById('poolFee').value) || 30;

            const enableTap = document.getElementById('enableTap').checked;
            const tapOps = document.getElementById('tapOps').value.trim() || connectedAddress;
            const tapRate = parseFloat(document.getElementById('tapRate').value) || 0;
            const tapBudget = parseFloat(document.getElementById('tapBudget').value) || 0;

            const ragequittable = document.getElementById('ragequittable').checked;
            const sharesLocked = document.getElementById('sharesLocked').checked;
            const lootLocked = document.getElementById('lootLocked').checked;

            // Validation
            if (!name) {
                showStatus('Please enter a DAO name', 'error');
                return;
            }
            if (!symbol) {
                showStatus('Please enter a token symbol', 'error');
                return;
            }
            if (supply <= 0) {
                showStatus('Please enter a valid sale supply', 'error');
                return;
            }
            if (price <= 0) {
                showStatus('Please enter a valid token price', 'error');
                return;
            }
            if (paymentToken === 'custom' && !ethers.isAddress(customToken)) {
                showStatus('Please enter a valid custom token address', 'error');
                return;
            }
            if (enableLP && (lpPct < 1 || lpPct > 99)) {
                showStatus('LP percentage must be between 1 and 99', 'error');
                return;
            }
            if (enableTap && !ethers.isAddress(tapOps)) {
                showStatus('Please enter a valid ops address for tap', 'error');
                return;
            }

            // Footgun prevention: loot sale with no tap and no founders = locked funds
            if (tokenType === 'loot' && !enableTap && founderShares <= 0) {
                showStatus('Loot sale requires either Tap or Founder Shares to access funds', 'error');
                return;
            }

            try {
                showStatus('Preparing transaction...', 'info');
                document.getElementById('submitBtn').disabled = true;

                const daicoContract = new ethers.Contract(DAICO_ADDRESS, DAICO_ABI, signer);

                // Build summon config
                const impls = getImplementations();
                const summonConfig = {
                    summoner: SUMMONER_ADDRESS,
                    molochImpl: impls.moloch,
                    sharesImpl: impls.shares,
                    lootImpl: impls.loot
                };

                // Build DAICO config
                const tribTkn = paymentToken === 'eth' ? ethers.ZeroAddress : customToken;
                const saleSupplyWei = ethers.parseEther(supply.toString());

                // Get tribute token decimals (ETH = 18, custom tokens need to be queried)
                let tribDecimals = 18;
                if (paymentToken !== 'eth' && customToken) {
                    try {
                        const tokenContract = new ethers.Contract(customToken, ERC20_FULL_ABI, provider);
                        tribDecimals = await tokenContract.decimals();
                    } catch (e) {
                        console.warn('Could not fetch token decimals, assuming 18:', e);
                    }
                }

                // Calculate tribAmt and forAmt to represent price
                // Price = tribAmt / forAmt (e.g., 0.0001 ETH per token means 1 ETH = 10000 tokens)
                // For 6-decimal tokens (USDC/USDT), use larger forAmt to maintain precision
                const forAmtTokens = tribDecimals <= 6 ? 1_000_000 : 1;
                const forAmtWei = ethers.parseEther(forAmtTokens.toString());
                const tribAmtForBatch = price * forAmtTokens;
                const tribAmtWei = ethers.parseUnits(tribAmtForBatch.toFixed(tribDecimals), tribDecimals);

                const daicoConfig = {
                    tribTkn: tribTkn,
                    tribAmt: tribAmtWei,
                    saleSupply: saleSupplyWei,
                    forAmt: forAmtWei,
                    deadline: getDefaultDeadline(), // 30 days from now
                    sellLoot: tokenType === 'loot',
                    lpBps: enableLP ? lpPct * 100 : 0, // Convert % to bps
                    maxSlipBps: 100, // 1% default slippage
                    feeOrHook: poolFee
                };

                // Init holders (founder allocation)
                const initHolders = founderShares > 0 ? [connectedAddress] : [];
                const initSharesWei = founderShares > 0 ? [ethers.parseEther(founderShares.toString())] : [];

                // Generate random salt
                const salt = ethers.hexlify(ethers.randomBytes(32));

                // Predict DAO address for custom calls
                const predictedDao = predictDaoAddress(initHolders, initSharesWei, salt);

                // Build custom calls for default governance settings (2-day voting, 1-day timelock)
                const customCalls = [
                    {
                        target: predictedDao,
                        value: 0n,
                        data: MOLOCH_INTERFACES.setProposalTTL.encodeFunctionData('setProposalTTL', [WIZARD_DEFAULTS.proposalTTL])
                    },
                    {
                        target: predictedDao,
                        value: 0n,
                        data: MOLOCH_INTERFACES.setTimelockDelay.encodeFunctionData('setTimelockDelay', [WIZARD_DEFAULTS.timelockDelay])
                    }
                ];

                // Encode calldata and show verify link
                let calldata;
                let tx;
                const quorumBps = quorumPct * 100;
                // For WalletConnect, skip local gas estimation (use generous limit, wallet will refine)
                const txOverrides = walletConnectProvider ? { gasLimit: 2_000_000n } : {};

                if (enableTap && tapRate > 0) {
                    // Use summonDAICOWithTapCustom
                    const SECONDS_PER_MONTH = 2629746n;
                    const ratePerSecWei = ethers.parseUnits(tapRate.toString(), tribDecimals) / SECONDS_PER_MONTH;
                    const tapAllowanceWei = tapBudget > 0 ? ethers.parseUnits(tapBudget.toString(), tribDecimals) : ethers.MaxUint256;

                    const tapConfig = {
                        ops: tapOps,
                        ratePerSec: ratePerSecWei,
                        tapAllowance: tapAllowanceWei
                    };

                    calldata = DAICO_IFACE.encodeFunctionData('summonDAICOWithTapCustom', [
                        summonConfig, name, symbol, contractURI, quorumBps,
                        ragequittable, DEFAULT_RENDERER, salt, initHolders, initSharesWei,
                        sharesLocked, lootLocked, daicoConfig, tapConfig, customCalls
                    ]);

                    const verifyUrl = buildSwissKnifeUrl(calldata);
                    showStatus(`Confirm in wallet... <a href="${verifyUrl}" target="_blank" rel="noopener" style="color: var(--cyan); opacity: 0.7; font-size: 0.85em;">verify calldata</a>`, 'info');

                    tx = await daicoContract.summonDAICOWithTapCustom(
                        summonConfig,
                        name,
                        symbol,
                        contractURI,
                        quorumBps,
                        ragequittable,
                        DEFAULT_RENDERER,
                        salt,
                        initHolders,
                        initSharesWei,
                        sharesLocked,
                        lootLocked,
                        daicoConfig,
                        tapConfig,
                        customCalls,
                        txOverrides
                    );
                } else {
                    // Use summonDAICOCustom
                    calldata = DAICO_IFACE.encodeFunctionData('summonDAICOCustom', [
                        summonConfig, name, symbol, contractURI, quorumBps,
                        ragequittable, DEFAULT_RENDERER, salt, initHolders, initSharesWei,
                        sharesLocked, lootLocked, daicoConfig, customCalls
                    ]);

                    const verifyUrl = buildSwissKnifeUrl(calldata);
                    showStatus(`Confirm in wallet... <a href="${verifyUrl}" target="_blank" rel="noopener" style="color: var(--cyan); opacity: 0.7; font-size: 0.85em;">verify calldata</a>`, 'info');

                    tx = await daicoContract.summonDAICOCustom(
                        summonConfig,
                        name,
                        symbol,
                        contractURI,
                        quorumBps,
                        ragequittable,
                        DEFAULT_RENDERER,
                        salt,
                        initHolders,
                        initSharesWei,
                        sharesLocked,
                        lootLocked,
                        daicoConfig,
                        customCalls,
                        txOverrides
                    );
                }

                showStatus(`Transaction submitted! <a href="${getNetwork().explorer}/tx/${tx.hash}" target="_blank" rel="noopener">View on Explorer</a>`, 'info');

                const receipt = await tx.wait();

                // Use the predicted DAO address (CREATE2 is deterministic)
                const daoAddress = predictedDao;

                // Show success
                document.getElementById('launchForm').style.display = 'none';
                document.getElementById('successPanel').style.display = 'block';
                document.getElementById('successAddress').textContent = daoAddress;
                document.getElementById('successLink').href = `https://majeurdao.eth.limo/#/dao/${getNetwork().chainId}/${daoAddress}`;

                hideStatus();

                // Refresh DAICO list to show the new sale
                daicoScanTriggered = false;
                setTimeout(() => triggerDAICOScan(), 3000);

            } catch (error) {
                console.error('Launch failed:', error);

                // Check if user rejected the transaction (handle various wallet error formats)
                if (isUserRejection(error)) {
                    hideStatus();
                } else {
                    showStatus(getErrorMessage(error), 'error');
                }
            } finally {
                document.getElementById('submitBtn').disabled = false;
            }
        }

        // Line drawing for hero section
        function updateLines() {
            const fund = document.getElementById('fund');
            const ctrl = document.getElementById('ctrl');
            const grow = document.getElementById('grow');
            const daico = document.getElementById('daico');

            if (!fund || !ctrl || !grow || !daico) return;

            const fundRect = fund.getBoundingClientRect();
            const ctrlRect = ctrl.getBoundingClientRect();
            const growRect = grow.getBoundingClientRect();
            const daicoRect = daico.getBoundingClientRect();

            const line1 = document.getElementById('line1');
            const x1Start = fundRect.left + fundRect.width / 2;
            const y1Start = fundRect.bottom;
            const x1End = ctrlRect.left + ctrlRect.width / 2;
            const y1End = ctrlRect.top;
            line1.setAttribute('d', `M ${x1Start} ${y1Start} Q ${(x1Start + x1End) / 2 + 20} ${(y1Start + y1End) / 2} ${x1End} ${y1End}`);

            const line2 = document.getElementById('line2');
            const x2Start = ctrlRect.left + ctrlRect.width / 2;
            const y2Start = ctrlRect.bottom;
            const x2End = growRect.left + growRect.width / 2;
            const y2End = growRect.top;
            line2.setAttribute('d', `M ${x2Start} ${y2Start} Q ${(x2Start + x2End) / 2 - 20} ${(y2Start + y2End) / 2} ${x2End} ${y2End}`);

            const line3 = document.getElementById('line3');
            const x3Start = growRect.left + growRect.width / 2;
            const y3Start = growRect.bottom;
            const x3End = daicoRect.left + daicoRect.width / 2;
            const y3End = daicoRect.top;
            line3.setAttribute('d', `M ${x3Start} ${y3Start} Q ${(x3Start + x3End) / 2 + 20} ${(y3Start + y3End) / 2} ${x3End} ${y3End}`);
        }

        let resizeTimeout;
        function handleResize() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(updateLines, 100);
        }

        // Initialize app
        async function initApp() {
            initEIP6963();
            await tryAutoReconnect();
        }

        window.addEventListener('load', () => {
            updateLines();
            initApp();
        });
        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', () => setTimeout(updateLines, 200));

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLaunchModal();
                closeWalletModal();
                closeWizard();
                closePurchaseModal();
            }
        });

        // Close modal on overlay click
        document.getElementById('launchModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('launchModal')) {
                closeLaunchModal();
            }
        });
        document.getElementById('walletModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('walletModal')) {
                closeWalletModal();
            }
        });
        document.getElementById('wizardModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('wizardModal')) {
                closeWizard();
            }
        });
        document.getElementById('purchaseModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('purchaseModal')) {
                closePurchaseModal();
            }
        });

        // Trigger DAICO scan when section scrolls into view
        const daicoObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    triggerDAICOScan();
                }
            });
        }, { threshold: 0.1 });

        const daicoSection = document.getElementById('active-daicos-section');
        if (daicoSection) {
            daicoObserver.observe(daicoSection);
        }

        // Crossed-out word animations on scroll
        const crossedWordObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animated');
                    crossedWordObserver.unobserve(entry.target);
                }
            });
        }, { threshold: 0.3 });

        document.querySelectorAll('.crossed-word').forEach(el => {
            crossedWordObserver.observe(el);
        });

        // CTRL diagram animation on scroll
        const diagramObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animated');
                    diagramObserver.unobserve(entry.target);
                }
            });
        }, { threshold: 0.4 });

        const ctrlDiagram = document.querySelector('.ctrl-diagram');
        if (ctrlDiagram) {
            diagramObserver.observe(ctrlDiagram);
        }

        // GROW illustration animation on scroll
        const growObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animated');
                    growObserver.unobserve(entry.target);
                }
            });
        }, { threshold: 0.3 });

        const growIllustration = document.querySelector('.grow-illustration');
        if (growIllustration) {
            growObserver.observe(growIllustration);
        }

        // Attribution box - show after scrolling past hero (throttled)
        const attributionBox = document.getElementById('attributionBox');
        let attributionScrollTimeout;
        if (attributionBox) {
            window.addEventListener('scroll', () => {
                if (attributionScrollTimeout) return;
                attributionScrollTimeout = setTimeout(() => {
                    attributionScrollTimeout = null;
                    if (window.scrollY > window.innerHeight * 0.5) {
                        attributionBox.classList.add('visible');
                    } else {
                        attributionBox.classList.remove('visible');
                    }
                }, 100);
            }, { passive: true });
        }

        // Network selector functions
        function toggleNetworkDropdown() {
            const selector = document.getElementById('networkSelector');
            if (selector) selector.classList.toggle('open');
        }

        function closeNetworkDropdown() {
            const selector = document.getElementById('networkSelector');
            if (selector) selector.classList.remove('open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const selector = document.getElementById('networkSelector');
            if (selector && !selector.contains(e.target)) {
                closeNetworkDropdown();
            }
        });

        async function switchNetwork(networkKey) {
            closeNetworkDropdown();

            const targetNetwork = NETWORKS[networkKey];
            if (!targetNetwork) return;

            // If wallet is connected, request network switch via wallet
            if (connectedWalletProvider) {
                // Check if already on target network
                try {
                    const currentChainIdHex = await connectedWalletProvider.request({ method: 'eth_chainId' });
                    if (currentChainIdHex === targetNetwork.chainIdHex) {
                        // Already on target network, just update UI state
                        currentNetwork = networkKey;
                        localStorage.setItem('daico_network', networkKey);
                        updateNetworkUI();
                        // Rescan on new network
                        activeDAICOs = [];
                        completedDAICOs = [];
                        daicoScanTriggered = false;
                        triggerDAICOScan();
                        return;
                    }
                } catch (e) {
                    // Continue with switch attempt
                }

                try {
                    await connectedWalletProvider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: targetNetwork.chainIdHex }]
                    });

                    // Some wallets don't fire chainChanged event reliably
                    // Verify the switch and update UI manually
                    const newChainIdHex = await connectedWalletProvider.request({ method: 'eth_chainId' });
                    if (newChainIdHex === targetNetwork.chainIdHex) {
                        // Switch successful - update state and reload to refresh everything
                        currentNetwork = networkKey;
                        localStorage.setItem('daico_network', networkKey);
                        window.location.reload();
                    }
                    return;
                } catch (error) {
                    // Error code 4902 means the chain hasn't been added to the wallet
                    if (error.code === 4902) {
                        try {
                            await connectedWalletProvider.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: targetNetwork.chainIdHex,
                                    chainName: targetNetwork.name,
                                    nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: targetNetwork.rpcs,
                                    blockExplorerUrls: [targetNetwork.explorer]
                                }]
                            });
                        } catch (addError) {
                            console.error('Failed to add network:', addError);
                            showStatus(`Failed to add ${targetNetwork.name} network`, 'error');
                        }
                    } else if (!isUserRejection(error)) {
                        console.error('Failed to switch network:', error);
                        showStatus(`Failed to switch to ${targetNetwork.name}`, 'error');
                    }
                }
            } else {
                // No wallet connected - just switch the display network
                currentNetwork = networkKey;
                localStorage.setItem('daico_network', networkKey);
                // Clear cached DAICOs and reset scan trigger
                activeDAICOs = [];
                completedDAICOs = [];
                daicoScanTriggered = false;
                // Update UI
                updateNetworkUI();
                // Rescan for DAICOs on new network
                showStatus(`Switching to ${targetNetwork.name}...`, 'info');
                await triggerDAICOScan();
            }
        }

        function updateNetworkUI() {
            const selector = document.getElementById('networkSelector');
            const networkName = document.getElementById('networkName');
            const network = getNetwork();

            // Update selector data attribute for styling
            if (selector) selector.setAttribute('data-network', currentNetwork);

            // Update network name
            if (networkName) networkName.textContent = network.name;

            // Update active state on options
            document.querySelectorAll('.network-option').forEach(opt => {
                opt.classList.toggle('active', opt.getAttribute('data-network') === currentNetwork);
            });
        }

        // Initialize network UI on load
        updateNetworkUI();

        // Theme boxes pop animation on scroll
        const themeObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('pop-in');
                    themeObserver.unobserve(entry.target);
                }
            });
        }, { threshold: 0.5 });

        document.querySelectorAll('.section .theme').forEach(el => {
            themeObserver.observe(el);
        });

        // Summary section - editable fields pop in sequence on entrance
        let summaryAnimated = false;
        const summaryObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !summaryAnimated) {
                    summaryAnimated = true;
                    const editables = entry.target.querySelectorAll('.summary-editable');
                    editables.forEach((el, i) => {
                        setTimeout(() => {
                            el.classList.add('entrance-pop');
                            // Remove class after animation to allow hover effects
                            setTimeout(() => {
                                el.classList.remove('entrance-pop');
                            }, 400);
                        }, i * 100); // Stagger by 100ms each
                    });
                    summaryObserver.unobserve(entry.target);
                }
            });
        }, { threshold: 0.3 });

        const summarySentence = document.querySelector('.summary-sentence');
        if (summarySentence) {
            summaryObserver.observe(summarySentence);
        }
    </script>
</body>
</html>
